{% extends "base.html" %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0c0c0c">
<meta name="msapplication-navbutton-color" content="#0c0c0c">
<meta name="apple-mobile-web-app-title" content="INEMI Feed">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* Modern CSS Variables */
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
    --glass-bg: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.8);
    --text-muted: rgba(255, 255, 255, 0.6);
    --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.3);
    --shadow-strong: 0 20px 60px rgba(0, 0, 0, 0.5);
    --border-radius: 20px;
    --border-radius-lg: 30px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Global Styles */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--dark-gradient);
    color: var(--text-primary);
    overflow: hidden;
    overscroll-behavior-y: contain;
    -webkit-overflow-scrolling: touch;
    /* Mobile full screen support */
    height: 100vh;
    height: 100dvh;
    width: 100vw;
    position: fixed;
    top: 0;
    left: 0;
  }

  /* Android specific fixes */
  @supports (-webkit-touch-callout: none) {
    .video-feed {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
  }
  
  /* Fix for Android Chrome address bar */
  .feed-container {
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }
  
  .feed-wrapper {
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }
</style>
{% endblock %}

{% block content %}
<!-- Modern Animated Background -->
<div class="modern-background">
  <div class="gradient-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <div class="orb orb-4"></div>
  </div>
  <div class="geometric-shapes">
    <div class="shape shape-triangle"></div>
    <div class="shape shape-circle"></div>
    <div class="shape shape-square"></div>
    <div class="shape shape-hexagon"></div>
  </div>
  <div class="floating-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>
  <div class="grid-overlay"></div>
</div>

<style>
  /* Modern Background Styles */
  .modern-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
    background: var(--dark-gradient);
  }

  /* Gradient Orbs */
  .gradient-orbs {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(60px);
    opacity: 0.6;
    animation: orbFloat 20s ease-in-out infinite;
  }

  .orb-1 {
    width: 300px;
    height: 300px;
    background: var(--primary-gradient);
    top: 10%;
    left: 10%;
    animation-delay: 0s;
  }

  .orb-2 {
    width: 200px;
    height: 200px;
    background: var(--secondary-gradient);
    top: 60%;
    right: 15%;
    animation-delay: 5s;
  }

  .orb-3 {
    width: 250px;
    height: 250px;
    background: var(--accent-gradient);
    bottom: 20%;
    left: 20%;
    animation-delay: 10s;
  }

  .orb-4 {
    width: 180px;
    height: 180px;
    background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    top: 30%;
    right: 30%;
    animation-delay: 15s;
  }

  /* Geometric Shapes */
  .geometric-shapes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .shape {
    position: absolute;
    opacity: 0.1;
    animation: shapeRotate 30s linear infinite;
  }

  .shape-triangle {
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-bottom: 50px solid rgba(102, 126, 234, 0.3);
    top: 20%;
    left: 80%;
    animation-delay: 0s;
  }

  .shape-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(236, 72, 153, 0.2);
    top: 70%;
    left: 10%;
    animation-delay: 7s;
  }

  .shape-square {
    width: 40px;
    height: 40px;
    background: rgba(79, 172, 254, 0.2);
    top: 40%;
    left: 70%;
    animation-delay: 14s;
  }

  .shape-hexagon {
    width: 50px;
    height: 50px;
    background: rgba(255, 107, 107, 0.2);
    clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%);
    top: 80%;
    right: 20%;
    animation-delay: 21s;
  }

  /* Floating Particles */
  .floating-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .particle {
    position: absolute;
    width: 3px;
    height: 3px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: particleFloat 25s linear infinite;
  }

  .particle:nth-child(1) {
    top: 20%;
    left: 20%;
    animation-delay: 0s;
  }

  .particle:nth-child(2) {
    top: 40%;
    left: 80%;
    animation-delay: 4s;
  }

  .particle:nth-child(3) {
    top: 60%;
    left: 10%;
    animation-delay: 8s;
  }

  .particle:nth-child(4) {
    top: 80%;
    left: 70%;
    animation-delay: 12s;
  }

  .particle:nth-child(5) {
    top: 30%;
    left: 50%;
    animation-delay: 16s;
  }

  .particle:nth-child(6) {
    top: 70%;
    left: 30%;
    animation-delay: 20s;
  }

  /* Grid Overlay */
  .grid-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
      linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    opacity: 0.3;
  }

  /* Modern Animations */
  @keyframes orbFloat {
    0%, 100% { 
      transform: translateY(0px) translateX(0px) scale(1);
    }
    25% { 
      transform: translateY(-30px) translateX(20px) scale(1.1);
    }
    50% { 
      transform: translateY(-60px) translateX(-10px) scale(0.9);
    }
    75% { 
      transform: translateY(-30px) translateX(-20px) scale(1.05);
    }
  }

  @keyframes shapeRotate {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.2); }
    100% { transform: rotate(360deg) scale(1); }
  }

  @keyframes particleFloat {
    0% { 
      transform: translateY(100vh) translateX(0px) scale(0);
      opacity: 0;
    }
    10% { 
      opacity: 1;
      transform: translateY(90vh) translateX(10px) scale(1);
    }
    90% { 
      opacity: 1;
      transform: translateY(10vh) translateX(-10px) scale(1);
    }
    100% { 
      transform: translateY(-10vh) translateX(20px) scale(0);
      opacity: 0;
    }
  }
  
  @keyframes slideInUp {
    0% { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    100% { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
  
  @keyframes likePulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  
  
  @keyframes slideIn {
    0% { transform: translateX(100%); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    0% { transform: translateX(0); opacity: 1; }
    100% { transform: translateX(100%); opacity: 0; }
  }
  

  /* Instagram Reels Style Feed Container */
  .feed-container {
    width: 100vw;
    height: 100vh;
    height: 100dvh;
    max-width: 100vw;
    max-height: 100vh;
    max-height: 100dvh;
    background: #000;
    overflow: hidden;
    box-sizing: border-box;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    margin: 0;
    padding: 0;
    border: none;
    outline: none;
  }

  .feed-wrapper {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    background: #000;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
    contain: layout style paint;
    overscroll-behavior: contain;
    margin: 0;
    padding: 0;
    border: none;
    outline: none;
  }
  
  /* Desktop Mode - Smaller Container */
  @media (min-width: 769px) {
    .feed-container {
      padding: 20px;
      background: #0a0a0a;
    }
    
    .feed-wrapper {
      max-width: 480px;
      max-height: 90vh;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      margin: 0 auto;
    }
    
    .video-feed {
      height: 90vh;
      max-height: 90vh;
    }
    
    .video-item {
      height: 90vh;
      max-height: 90vh;
      min-height: 90vh;
    }
    
    .feed-nav {
      border-radius: 20px 20px 0 0;
    }
  }

  /* Instagram Reels Style Navigation */
  .feed-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0;
    margin: 0;
    z-index: 1000;
    pointer-events: none;
  }
  
  .feed-nav > * {
    pointer-events: auto;
  }

  .feed-nav-left {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 0;
    margin: 0;
  }

  .feed-title {
    color: var(--text-primary);
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .feed-nav-right {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 0;
    margin: 0;
  }
  
  .feed-nav-btn {
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 50%;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 16px;
    position: relative;
    overflow: hidden;
  }

  .feed-nav-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-gradient);
    opacity: 0;
    transition: var(--transition);
    border-radius: 50%;
  }

  .feed-nav-btn:hover::before {
    opacity: 0.1;
  }

  .feed-nav-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-soft);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .feed-nav-btn:active {
    transform: translateY(0) scale(0.95);
  }
  
  .feed-nav-btn.shuffling {
    animation: shufflePulse 0.6s ease-in-out;
  }
  
  @keyframes shufflePulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); color: #ff6b6b; }
    100% { transform: scale(1); }
  }

  /* Instagram Reels Style Video Feed - Enhanced */
  .video-feed {
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overflow-y: auto;
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    overscroll-behavior-y: contain;
    overscroll-behavior-x: none;
    box-sizing: border-box;
    touch-action: pan-y;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
    position: relative;
    /* Performance optimizations */
    contain: layout style paint;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }
  
  .video-feed::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }
  
  /* Smooth scroll indicator */
  .video-feed::after {
    content: '';
    position: fixed;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 60px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 100;
    pointer-events: none;
  }
  
  .video-feed.scrolling::after {
    opacity: 1;
  }

  /* Instagram Reels Style Video Items - Enhanced */
  .video-item {
    width: 100%;
    height: 100vh;
    height: 100dvh;
    min-height: 100vh;
    min-height: 100dvh;
    position: relative;
    scroll-snap-align: start;
    scroll-snap-stop: always;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    overflow: hidden;
    contain: layout style paint;
    background: #000;
    will-change: transform;
    transform: translateZ(0);
    transition: opacity 0.3s ease;
    margin: 0;
    padding: 0;
    border: none;
    outline: none;
  }
  
  .video-item.loading {
    opacity: 0.7;
  }
  
  .video-item.playing {
    opacity: 1;
  }
  
  .video-item.playing .video-info,
  .video-item.playing .video-actions {
    opacity: 1;
    transform: translateY(0) translateX(0);
  }
  
  /* Smooth fade-in animation for video info - only apply when not playing */
  .video-item:not(.playing) .video-info {
    opacity: 0;
    transform: translateY(20px);
  }
  
  .video-item:not(.playing) .video-actions {
    opacity: 0;
    transform: translateX(20px);
  }
  
  .video-info {
    transition: opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;
  }
  
  .video-actions {
    transition: opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;
  }
  
  .video-player {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
    box-sizing: border-box;
    opacity: 0;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: opacity;
    transform: translateZ(0);
    margin: 0;
    padding: 0;
    border: none;
    outline: none;
    display: block;
  }
  
  .video-player.loaded {
    opacity: 1;
  }
  
  .video-player[data-loading="true"] {
    opacity: 0.5;
  }
  
  .video-player.playing {
    opacity: 1;
  }
  
  /* Preload next video for smoother transitions */
  .video-item[data-preload="true"] .video-player {
    opacity: 0.3;
  }

  @keyframes modernSlideIn {
    0% { 
      opacity: 0; 
    }
    100% { 
      opacity: 1; 
    }
  }
  
  @keyframes likePulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  /* Instagram Reels Style Video Overlay - Enhanced */
  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.4) 0%,
      transparent 25%,
      transparent 65%,
      rgba(0, 0, 0, 0.8) 100%
    );
    pointer-events: none;
    z-index: 1;
    transition: opacity 0.3s ease;
  }
  
  .video-item.playing .video-overlay {
    opacity: 0.9;
  }

  /* Instagram Reels Style Video Info - Enhanced */
  .video-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 80px;
    color: #fff;
    z-index: 10;
    padding: 20px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    pointer-events: none;
    transition: opacity 0.4s ease 0.2s, transform 0.4s ease 0.2s;
  }
  
  /* Desktop - Smaller video info */
  @media (min-width: 769px) {
    .video-info {
      right: 70px;
      padding: 15px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
    }
    
    .video-author-avatar {
      width: 32px;
      height: 32px;
    }
    
    .video-author-info h4 {
      font-size: 13px;
    }
    
    .video-author-info p {
      font-size: 10px;
    }
    
    .video-title {
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .video-description {
      font-size: 12px;
    }
    
    .mobile-bottom-nav {
      display: none !important;
    }
  }
   
  .video-author {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    pointer-events: auto;
  }
  
  .video-author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .video-author-avatar:active {
    transform: scale(0.95);
  }
  
  .video-author-info h4 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
  }
   
  .video-author-info p {
    margin: 0;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 400;
  }

  .video-title {
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 8px;
    line-height: 1.4;
    color: #fff;
    pointer-events: auto;
  }

  .video-description {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.5;
    max-height: 3.5em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    word-wrap: break-word;
    word-break: break-word;
    font-weight: 400;
    pointer-events: auto;
  }
  
  .video-stats {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    pointer-events: auto;
  }
  
  .view-count {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Instagram Reels Style Video Actions - Enhanced with 3D Glossy Effect */
  .video-actions {
    position: absolute;
    right: 12px;
    bottom: 120px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    z-index: 20;
    align-items: center;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  
  .video-item.playing .video-actions {
    transform: translateX(0);
    opacity: 1;
  }
  
  .video-action-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: rgba(0, 0, 0, 0.35);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 24px;
    position: relative;
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    will-change: transform;
    overflow: hidden;
  }
  
  /* 3D Glossy Effect */
  .video-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.2) 0%,
      rgba(255, 255, 255, 0.05) 50%,
      transparent 100%
    );
    border-radius: 50%;
    pointer-events: none;
    opacity: 0.6;
  }
  
  /* Desktop - Smaller action buttons */
  @media (min-width: 769px) {
    .video-actions {
      right: 10px;
      bottom: 100px;
      gap: 18px;
    }
    
    .video-action-btn {
      width: 48px;
      height: 48px;
      font-size: 20px;
    }
    
    .video-action-btn .action-icon {
      font-size: 22px;
    }
    
    .video-action-btn .action-count {
      font-size: 10px;
    }
  }
  
  .video-action-btn:hover {
    transform: scale(1.08);
    background: rgba(0, 0, 0, 0.45);
    box-shadow: 
      0 6px 20px rgba(0, 0, 0, 0.5),
      0 0 0 1px rgba(255, 255, 255, 0.15) inset;
  }
  
  .video-action-btn:active {
    transform: scale(0.92);
    background: rgba(0, 0, 0, 0.5);
  }
  
  .video-action-btn.liked {
    color: #ff3040;
    background: rgba(255, 48, 64, 0.25);
    box-shadow: 
      0 4px 16px rgba(255, 48, 64, 0.4),
      0 0 0 1px rgba(255, 48, 64, 0.3) inset;
  }
  
  .video-action-btn.liked::before {
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.3) 0%,
      rgba(255, 48, 64, 0.2) 50%,
      transparent 100%
    );
  }
  
  .video-action-btn.liked .action-icon {
    animation: likePulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    filter: drop-shadow(0 2px 8px rgba(255, 48, 64, 0.6));
  }
  
  /* 3D Glossy effect for icons - Instagram Reels Style */
  .video-action-btn .action-icon {
    font-size: 28px;
    margin-bottom: 2px;
    line-height: 1;
    filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.4));
    position: relative;
    z-index: 2;
    display: inline-block;
    transform-style: preserve-3d;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateZ(0);
  }
  
  /* Glossy highlight overlay for icons */
  .video-action-btn .action-icon::before {
    content: '';
    position: absolute;
    top: -25%;
    left: -25%;
    width: 150%;
    height: 150%;
    background: radial-gradient(
      circle at 35% 35%,
      rgba(255, 255, 255, 0.5) 0%,
      rgba(255, 255, 255, 0.2) 30%,
      transparent 70%
    );
    border-radius: 50%;
    pointer-events: none;
    opacity: 0.7;
    z-index: 1;
  }
  
  /* Icon-specific styling - Bootstrap Icons */
  .video-action-btn .action-icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .video-action-btn .action-icon i {
    font-size: inherit;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }
  
  .video-action-btn .like-icon {
    filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.4));
    font-size: 28px;
  }
  
  .video-action-btn .like-icon i {
    color: #ffffff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .video-action-btn.liked .like-icon {
    filter: drop-shadow(0 2px 10px rgba(255, 48, 64, 0.8));
    animation: likeGlow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .video-action-btn.liked .like-icon i {
    color: #ff3040;
  }
  
  .video-action-btn .comment-icon {
    filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.4));
    font-size: 26px;
  }
  
  .video-action-btn .comment-icon i {
    color: rgba(255, 255, 255, 0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .video-action-btn .share-icon {
    filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.4));
    font-size: 26px;
  }
  
  .video-action-btn .share-icon i {
    color: rgba(255, 255, 255, 0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .video-action-btn:hover .comment-icon i,
  .video-action-btn:hover .share-icon i {
    color: #ffffff;
    transform: scale(1.05);
  }
  
  .video-action-btn:hover .like-icon i {
    transform: scale(1.05);
  }
  
  .video-action-btn.liked:hover .like-icon i {
    transform: scale(1.1);
  }
  
  .video-action-btn:hover .action-icon {
    transform: scale(1.15) translateZ(0);
    filter: drop-shadow(0 3px 10px rgba(0, 0, 0, 0.6));
  }
  
  .video-action-btn.liked:hover .like-icon {
    filter: drop-shadow(0 3px 12px rgba(255, 48, 64, 0.9));
    transform: scale(1.2) translateZ(0);
  }
  
  /* Glow animation for liked state */
  @keyframes likeGlow {
    0% {
      filter: drop-shadow(0 2px 6px rgba(255, 48, 64, 0.4));
      transform: scale(1);
    }
    50% {
      filter: drop-shadow(0 4px 16px rgba(255, 48, 64, 1));
      transform: scale(1.2);
    }
    100% {
      filter: drop-shadow(0 2px 10px rgba(255, 48, 64, 0.8));
      transform: scale(1);
    }
  }
  
  .video-action-btn .action-count {
    font-size: 12px;
    font-weight: 700;
    margin-top: 1px;
    color: #ffffff;
    line-height: 1;
    text-shadow: 
      0 1px 3px rgba(0, 0, 0, 0.5),
      0 0 1px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 1;
    letter-spacing: 0.3px;
  }

  /* Instagram Reels Style Play Button Overlay - Enhanced */
  .play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 80px;
    height: 80px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 15;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    will-change: transform, opacity;
  }
  
  .video-item.paused .play-overlay {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
  }
  
  .play-overlay:hover {
    transform: translate(-50%, -50%) scale(1.1);
    background: rgba(0, 0, 0, 0.7);
  }
  
  .play-overlay:active {
    transform: translate(-50%, -50%) scale(0.95);
  }
  
  .play-overlay::after {
    content: '';
    width: 0;
    height: 0;
    border-left: 24px solid #fff;
    border-top: 14px solid transparent;
    border-bottom: 14px solid transparent;
    margin-left: 6px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }
  
  .play-overlay.hidden {
    display: none;
  }

  /* Modern Loading States */
  .video-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-primary);
    font-size: 14px;
    z-index: 10;
    text-align: center;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-soft);
  }

  .video-loading .spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid var(--text-primary);
    border-radius: 50%;
    animation: modernSpin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes modernSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .video-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #ff6b6b;
    font-size: 14px;
    text-align: center;
    z-index: 10;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 107, 107, 0.3);
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-soft);
  }

  .video-error .error-icon {
    font-size: 32px;
    margin-bottom: 15px;
  }

  .video-error button {
    background: var(--secondary-gradient);
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: var(--border-radius);
    cursor: pointer;
    margin-top: 15px;
    font-size: 14px;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: var(--shadow-soft);
  }

  .video-error button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-strong);
  }
  
  


  /* Override base.html styles for explore page */
  .main-content,
  .content-wrapper {
    margin: 0 !important;
    padding: 0 !important;
    width: 100vw !important;
    max-width: 100vw !important;
    height: 100vh !important;
    height: 100dvh !important;
  }

  /* Instagram Reels Style Mobile Responsive - Enhanced */
  @media (max-width: 768px) {
    .main-content,
    .content-wrapper {
      margin: 0 !important;
      padding: 0 !important;
      width: 100vw !important;
      max-width: 100vw !important;
      height: 100vh !important;
      height: 100dvh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }
    
    .feed-container {
      padding: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      height: 100dvh !important;
      margin: 0 !important;
      border: none !important;
      outline: none !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }
   
    .feed-wrapper {
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      outline: none !important;
    }
    
    .video-feed {
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
    }
    
    .video-item {
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      outline: none !important;
      width: 100vw !important;
    }
    
    .video-player {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      outline: none !important;
    }
    
     .feed-nav {
       height: 50px;
       padding: 0 !important;
       margin: 0 !important;
       background: transparent;
       left: 0 !important;
       right: 0 !important;
       top: 0 !important;
     }
     
     .feed-nav-left,
     .feed-nav-right {
       padding: 0 !important;
       margin: 0 !important;
     }
    
    .feed-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .feed-nav-btn {
      width: 36px;
      height: 36px;
      font-size: 14px;
    }
    
    .video-feed {
      height: 100vh;
      height: 100dvh;
    }
    
    .video-item {
      height: 100vh;
      height: 100dvh;
      min-height: 100vh;
      min-height: 100dvh;
    }
    
    .video-info {
      bottom: 0;
      left: 0;
      right: 70px;
      padding: 12px 15px;
      padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
      opacity: 1 !important;
      transform: translateY(0) !important;
      z-index: 10;
    }
    
    .video-author {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .video-author-avatar {
      width: 40px;
      height: 40px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      flex-shrink: 0;
    }
    
    .video-author-info {
      flex: 1;
      min-width: 0;
    }
    
    .video-author-info h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .video-author-info p {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .video-title {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 500;
      line-height: 1.3;
    }
    
    .video-description {
      font-size: 13px;
      max-height: 2.5em;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      line-height: 1.4;
      color: rgba(255, 255, 255, 0.9);
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
    }

     .video-actions {
       right: 12px;
       bottom: calc(140px + env(safe-area-inset-bottom, 0px));
       gap: 20px;
       opacity: 1 !important;
       transform: translateX(0) !important;
       z-index: 20;
     }

    .video-action-btn {
      width: 56px;
      height: 56px;
      font-size: 24px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.12) inset;
    }

    .video-action-btn .action-icon {
      font-size: 28px;
      margin-bottom: 2px;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));
    }

    .video-action-btn .action-count {
      font-size: 12px;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.6),
        0 0 1px rgba(0, 0, 0, 0.4);
    }
    
    .video-action-btn.liked {
      background: rgba(255, 48, 64, 0.3);
      box-shadow: 
        0 4px 16px rgba(255, 48, 64, 0.5),
        0 0 0 1px rgba(255, 48, 64, 0.4) inset;
    }
    
    .video-action-btn.liked .action-icon {
      filter: drop-shadow(0 2px 8px rgba(255, 48, 64, 0.7));
    }

    .play-overlay {
      width: 70px;
      height: 70px;
    }

    .play-overlay::after {
      border-left: 20px solid #fff;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
    }
    
    /* Better touch targets on mobile */
    .video-action-btn,
    .play-overlay,
    .feed-nav-btn {
      min-width: 44px;
      min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
  }

  /* Instagram Reels Style Extra Small Mobile - Enhanced */
  @media (max-width: 480px) {
    .feed-nav {
      height: 45px;
      padding: 0 !important;
      margin: 0 !important;
      left: 0 !important;
      right: 0 !important;
      top: 0 !important;
    }
    
    .feed-title {
      font-size: 16px;
    }
    
    .feed-nav-btn {
      width: 36px;
      height: 36px;
      font-size: 13px;
      min-width: 36px;
      min-height: 36px;
    }
    
    .video-info {
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      right: 65px;
      opacity: 1 !important;
      transform: translateY(0) !important;
    }
    
    .video-author-avatar {
      width: 32px;
      height: 32px;
    }
    
    .video-author-info h4 {
      font-size: 13px;
    }
    
    .video-title {
      font-size: 13px;
    }
    
    .video-description {
      font-size: 12px;
    }

     .video-actions {
       right: 8px;
       bottom: calc(140px + env(safe-area-inset-bottom, 0px));
       gap: 16px;
       opacity: 1 !important;
       transform: translateX(0) !important;
     }

    .video-action-btn {
      width: 52px;
      height: 52px;
      font-size: 22px;
      min-width: 52px;
      min-height: 52px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.12) inset;
    }

    .video-action-btn .action-icon {
      font-size: 24px;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));
    }

    .video-action-btn .action-count {
      font-size: 11px;
      color: #ffffff;
      text-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.6),
        0 0 1px rgba(0, 0, 0, 0.4);
    }
    
    .video-action-btn.liked {
      background: rgba(255, 48, 64, 0.3);
      box-shadow: 
        0 4px 16px rgba(255, 48, 64, 0.5),
        0 0 0 1px rgba(255, 48, 64, 0.4) inset;
    }

    .play-overlay {
      width: 65px;
      height: 65px;
      min-width: 65px;
      min-height: 65px;
    }

    .play-overlay::after {
      border-left: 18px solid #fff;
      border-top: 11px solid transparent;
      border-bottom: 11px solid transparent;
    }
  }

  /* Instagram Reels Style Landscape */
  @media (max-width: 768px) and (orientation: landscape) {
    .feed-nav {
      height: 45px;
    }
    
    .video-item {
      height: 100vh;
      height: 100dvh;
    }
    
    .video-info {
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    }
    
    .video-actions {
      bottom: 80px;
    }
  }

  /* Hide scrollbar for Instagram Reels style */
  .video-feed {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  /* Prevent zoom on double tap */
  .video-feed {
    touch-action: pan-y;
  }
  
  /* Mobile scroll fixes */
  @media (max-width: 768px) {
    body {
      overflow: auto !important;
      position: relative !important;
    }
    
    html {
      overflow: auto !important;
    }
    
    .feed-container {
      position: relative !important;
      overflow: visible !important;
    }
    
    .feed-wrapper {
      overflow: visible !important;
    }
    
    .video-feed {
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch !important;
    }
  }
  
  /* Prevent body scroll */
  body {
    position: fixed;
    overflow: hidden;
    width: 100%;
    height: 100%;
  }
  
  /* Prevent document scroll */
  document {
    overflow: hidden;
  }

  /* Modern Mobile Touch Improvements */
  @media (max-width: 768px) {
    .video-action-btn {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .video-action-btn:active {
      transform: translateY(0) scale(0.9);
    }
    
    .feed-nav-btn {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .feed-nav-btn:active {
      transform: translateY(0) scale(0.9);
    }
    
    /* Prevent text selection on mobile */
    .video-info, .video-actions {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Improve touch targets */
    .video-action-btn, .feed-nav-btn {
      min-width: 44px;
      min-height: 44px;
    }
     
    /* Android scroll improvements */
    .video-feed {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scroll-behavior: smooth;
      touch-action: pan-y;
      overflow-y: scroll !important;
    }
     
    /* Prevent zoom on double tap */
    .video-item {
      touch-action: manipulation;
    }
     
    /* Better scroll performance on Android */
    .video-item {
      will-change: transform;
      transform: translateZ(0);
    }
     
    /* Force scroll on mobile */
    .feed-wrapper {
      overflow: visible !important;
    }
     
    .feed-container {
      overflow: visible !important;
    }
     
    /* Make sure video info and actions are visible on mobile */
    .video-info {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }
     
    .video-actions {
      opacity: 1 !important;
      transform: translateX(0) !important;
    }
     
    .play-overlay {
      opacity: 1 !important;
      scale: 1 !important;
    }
  }

  /* Modern Performance Optimizations - Enhanced */
  .video-item {
    will-change: transform, opacity;
    transform: translateZ(0);
    contain: layout style paint;
  }
  
  .video-player {
    will-change: opacity;
    transform: translateZ(0);
  }
  
  .video-info, .video-actions {
    will-change: transform, opacity;
  }
  
  /* GPU acceleration for smooth scrolling */
  .video-feed {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }
  
  /* Optimize repaints */
  .video-item * {
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }

  /* Modern Focus States */
  .feed-nav-btn:focus,
  .video-action-btn:focus,
  .play-overlay:focus {
    outline: 2px solid rgba(102, 126, 234, 0.6);
    outline-offset: 2px;
  }

  /* Modern Selection States */
  ::selection {
    background: rgba(102, 126, 234, 0.3);
    color: var(--text-primary);
  }

  ::-moz-selection {
    background: rgba(102, 126, 234, 0.3);
    color: var(--text-primary);
  }

  /* Modern Hover Effects - Disabled for mobile performance */
  @media (hover: hover) and (pointer: fine) {
    .video-item:hover {
      transform: translateY(-2px);
    }

    .video-item:hover .video-player {
      filter: brightness(1.05);
    }
  }

  /* Modern Loading Animation */
  @keyframes modernPulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.7;
      transform: scale(1.05);
    }
  }

  .video-loading .spinner {
    animation: modernSpin 1s linear infinite, modernPulse 2s ease-in-out infinite;
  }

  /* Modern Gradient Text Animation */
  @keyframes gradientShift {
    0%, 100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }

  .feed-title {
    background-size: 200% 200%;
    animation: gradientShift 3s ease infinite;
  }

  /* Modern Glassmorphism Enhancement */
  .feed-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border-radius: var(--border-radius-lg);
    pointer-events: none;
    z-index: -1;
  }

  /* Mobile Full Screen Enhancements */
  @media (max-width: 768px) {
    html {
      height: 100vh;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
    }
    
    body {
      height: 100vh;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
    }
    
    /* Ensure no content is cut off */
    .video-info {
      max-width: calc(100vw - 40px);
    }
    
    .video-actions {
      max-height: calc(100vh - 200px);
      max-height: calc(100dvh - 200px);
    }
    
    /* Prevent horizontal scroll */
    .video-feed {
      overflow-x: hidden;
    }
    
    .video-item {
      max-width: 100vw;
      overflow: hidden;
    }
  }
  
  /* Mobile Bottom Navigation Bar */
  .mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    align-items: center;
    justify-content: space-around;
    padding: 0 10px;
    padding-bottom: env(safe-area-inset-bottom, 0px);
    z-index: 1000;
    border-radius: 20px 20px 0 0;
  }
  
  @media (max-width: 768px) {
    .mobile-bottom-nav {
      display: flex;
    }
    
    .video-info {
      padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
    }
    
     .video-actions {
       bottom: calc(140px + env(safe-area-inset-bottom, 0px));
     }
  }
  
  .mobile-nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 12px;
    position: relative;
    min-height: 44px;
  }
  
  .mobile-nav-item.active {
    background: rgba(138, 43, 226, 0.2);
  }
  
  .mobile-nav-item.active .mobile-nav-icon {
    color: #8a2be2;
  }
  
  .mobile-nav-item.compass-active {
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 6px;
    background: rgba(255, 255, 255, 0.05);
  }
  
  .mobile-nav-item.compass-active .mobile-nav-icon {
    color: rgba(255, 255, 255, 0.9);
  }
  
  .mobile-nav-icon {
    font-size: 22px;
    color: rgba(255, 255, 255, 0.7);
    transition: all 0.2s ease;
    margin-bottom: 2px;
  }
  
  .mobile-nav-item:active .mobile-nav-icon {
    transform: scale(0.9);
  }
  
  .mobile-nav-item.active .mobile-nav-icon {
    color: #8a2be2;
  }
 </style>

<!-- Feed Container -->
<div class="feed-container">
  <div class="feed-wrapper">
    <div class="feed-nav">
      <div class="feed-nav-left">
        <!-- Title removed for mobile optimization -->
      </div>
      <div class="feed-nav-right">
        <!-- Navigation buttons removed -->
      </div>
        </div>
   
    <div class="video-feed" id="videoFeed">
      <!-- Videos will be dynamically loaded here -->
        </div>
        
        <!-- Scroll indicator -->
        <div class="scroll-indicator" id="scrollIndicator"></div>
        
        <!-- Mobile Bottom Navigation -->
        <div class="mobile-bottom-nav">
          <div class="mobile-nav-item active" onclick="goToMenu()">
            <i class="bi bi-list mobile-nav-icon"></i>
          </div>
          <div class="mobile-nav-item" onclick="goToHome()">
            <i class="bi bi-house mobile-nav-icon"></i>
          </div>
          <div class="mobile-nav-item" onclick="goToSparkle()">
            <i class="bi bi-stars mobile-nav-icon"></i>
          </div>
          <div class="mobile-nav-item compass-active" onclick="goToExplore()">
            <i class="bi bi-compass mobile-nav-icon"></i>
          </div>
          <div class="mobile-nav-item" onclick="goToProfile()">
            <i class="bi bi-person mobile-nav-icon"></i>
          </div>
        </div>
        </div>
      </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal fade" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-white border-0" style="backdrop-filter: blur(15px); background: rgba(33, 37, 41, 0.95) !important;">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="shareModalLabel">Bagikan ke</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- WhatsApp -->
            <div class="col-6">
              <button class="btn btn-success w-100 py-3 rounded-3" onclick="shareToWhatsApp()" style="font-weight: 600;">
                <i class="bi bi-whatsapp fs-4"></i>
                <div class="mt-2">WhatsApp</div>
              </button>
            </div>
            <!-- Facebook -->
            <div class="col-6">
              <button class="btn btn-primary w-100 py-3 rounded-3" onclick="shareToFacebook()" style="font-weight: 600;">
                <i class="bi bi-facebook fs-4"></i>
                <div class="mt-2">Facebook</div>
              </button>
            </div>
            <!-- Twitter/X -->
            <div class="col-6">
              <button class="btn btn-dark w-100 py-3 rounded-3" onclick="shareToTwitter()" style="font-weight: 600;">
                <i class="bi bi-twitter-x fs-4"></i>
                <div class="mt-2">Twitter/X</div>
              </button>
            </div>
            <!-- Telegram -->
            <div class="col-6">
              <button class="btn btn-info w-100 py-3 rounded-3" onclick="shareToTelegram()" style="font-weight: 600;">
                <i class="bi bi-telegram fs-4"></i>
                <div class="mt-2">Telegram</div>
              </button>
            </div>
            <!-- Instagram -->
            <div class="col-6">
              <button class="btn btn-danger w-100 py-3 rounded-3" onclick="shareToInstagram()" style="font-weight: 600; background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); border: none;">
                <i class="bi bi-instagram fs-4"></i>
                <div class="mt-2">Instagram</div>
              </button>
            </div>
            <!-- Native Share (Mobile) -->
            <div class="col-6" id="nativeShareBtn" style="display: none;">
              <button class="btn btn-outline-light w-100 py-3 rounded-3" onclick="useNativeShare()" style="font-weight: 600;">
                <i class="bi bi-share-fill fs-4"></i>
                <div class="mt-2">Share</div>
              </button>
            </div>
            <!-- Copy Link -->
            <div class="col-12">
              <button class="btn btn-outline-light w-100 py-3 rounded-3" onclick="copyShareLink(event)" style="font-weight: 600;">
                <i class="bi bi-link-45deg fs-4"></i>
                <div class="mt-2">Salin Link</div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Feed functionality
let currentVideoIndex = 0;
let videos = [];
let isPlaying = false;
let nextCursor = null;
let isLoading = false;
let hasMoreVideos = true;

// Mobile detection function
function isMobile() {
  return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Shuffle array function (kept for legacy usage)
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Helper to safely get a date value from API response
function extractVideoDate(video) {
  const possibleKeys = [
    'created_at',
    'createdAt',
    'created_at_iso',
    'created',
    'createdDate',
    'date',
    'timestamp'
  ];
  
  for (const key of possibleKeys) {
    if (video[key]) {
      const dateValue = new Date(video[key]);
      if (!isNaN(dateValue.getTime())) {
        return dateValue;
      }
    }
  }
  
  return null;
}

// Sort videos by newest first (fallback to original order)
function sortVideosByDate(array) {
  const sorted = [...array];
  
  sorted.sort((a, b) => {
    const dateA = extractVideoDate(a);
    const dateB = extractVideoDate(b);
    
    if (dateA && dateB) {
      return dateB.getTime() - dateA.getTime();
    } else if (dateA && !dateB) {
      return -1;
    } else if (!dateA && dateB) {
      return 1;
    }
    
    return 0;
  });
  
  return sorted;
}

// Shuffle current videos in the feed
function shuffleCurrentVideos() {
  if (videos.length === 0) {
    console.log('No videos to shuffle');
    return;
  }
  
  console.log('Shuffling current videos...');
  const feedContainer = document.getElementById('videoFeed');
  
  // Get all video elements
  const videoElements = Array.from(feedContainer.children);
  
  // Shuffle the video elements
  const shuffledElements = shuffleArray(videoElements);
  
  // Clear the container
  feedContainer.innerHTML = '';
  
  // Re-append shuffled elements
  shuffledElements.forEach((element, index) => {
    feedContainer.appendChild(element);
    // Update the video index
    element.setAttribute('data-video-index', index);
  });
  
  // Update videos array
  videos = shuffledElements;
  
  // Reset current video index to 0
  currentVideoIndex = 0;
  
  // Show first video
  if (videos.length > 0) {
    showVideo(0);
  }
  
  console.log(`Shuffled ${videos.length} videos`);
  
  // Add visual feedback with CSS animation
  const shuffleBtn = document.querySelector('[onclick="shuffleCurrentVideos()"]');
  if (shuffleBtn) {
    shuffleBtn.classList.add('shuffling');
    setTimeout(() => {
      shuffleBtn.classList.remove('shuffling');
    }, 600);
  }
}

// API Configuration
const API_BASE_URL = '/api';

// Initialize feed when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Prevent page scroll
  document.body.style.overflow = 'hidden';
  document.documentElement.style.overflow = 'hidden';
  
  // Test API endpoints first
  testAPIEndpoints();
  
  // Add a fallback timer to ensure videos load (increased timeout)
  setTimeout(() => {
    const feedContainer = document.getElementById('videoFeed');
    if (feedContainer && feedContainer.children.length === 0) {
      console.log('No videos loaded after 10 seconds, loading dummy videos...');
      loadDummyVideos();
    }
  }, 10000);
  
  initFeed();
  
  // Handle orientation change
  window.addEventListener('orientationchange', function() {
    setTimeout(() => {
      // Recalculate video positions after orientation change
      const feedContainer = document.getElementById('videoFeed');
      if (feedContainer) {
        const containerHeight = feedContainer.clientHeight;
        const scrollTop = feedContainer.scrollTop;
        const newIndex = Math.round(scrollTop / containerHeight);
        currentVideoIndex = newIndex;
      }
    }, 100);
  });
  
  // Allow touch events for scrolling
  document.addEventListener('touchstart', function(e) {
    // Only prevent default for specific elements, not the video feed
    if (e.target.closest('.video-action-btn') || e.target.closest('.play-overlay')) {
      // Allow these to work normally
      return;
    }
  }, { passive: true });
  
  // Allow window scroll for mobile
  window.addEventListener('scroll', function(e) {
    // Only prevent scroll if not on mobile
    if (window.innerWidth > 768) {
      e.preventDefault();
      window.scrollTo(0, 0);
    }
  }, { passive: true });
  
  // Allow wheel scroll on mobile
  document.addEventListener('wheel', function(e) {
    // Only prevent wheel scroll on desktop
    if (window.innerWidth > 768 && !e.target.closest('.video-feed')) {
      e.preventDefault();
    }
  }, { passive: true });
  
  // Handle touch events for better mobile experience
  let touchStartY = 0;
  let touchEndY = 0;
  let touchStartTime = 0;
  let isScrolling = false;
  
  // Android-specific touch handling
  document.addEventListener('touchstart', function(e) {
    touchStartY = e.changedTouches[0].screenY;
    touchStartTime = Date.now();
    isScrolling = false;
  }, { passive: true });
  
  document.addEventListener('touchmove', function(e) {
    if (!isScrolling) {
      const touchY = e.changedTouches[0].screenY;
      const diff = Math.abs(touchY - touchStartY);
      
      if (diff > 10) {
        isScrolling = true;
      }
    }
  }, { passive: true });
  
  document.addEventListener('touchend', function(e) {
    touchEndY = e.changedTouches[0].screenY;
    const touchDuration = Date.now() - touchStartTime;
    handleSwipe(touchDuration);
  }, { passive: true });
  
  function handleSwipe(duration) {
    const swipeThreshold = 50;
    const diff = touchStartY - touchEndY;
    
    // Only handle swipe if it's a quick gesture (less than 300ms)
    if (Math.abs(diff) > swipeThreshold && duration < 300) {
      // Swipe detected, let the browser handle scroll
      return;
    }
  }
  
  // Prevent pull-to-refresh on Android
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      if (touch.clientY < 50) {
        e.preventDefault();
      }
    }
  }, { passive: false });
  
  // Handle Android Chrome address bar changes
  function handleViewportChange() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  
  window.addEventListener('resize', handleViewportChange);
  window.addEventListener('orientationchange', function() {
    setTimeout(handleViewportChange, 100);
  });
  
  // Initial viewport setup
  handleViewportChange();
  
  // Mobile detection and scroll setup
  
  if (isMobile()) {
    // Enable scroll on mobile
    document.body.style.overflow = 'auto';
    document.body.style.position = 'relative';
    document.documentElement.style.overflow = 'auto';
    
    // Make sure video feed can scroll
    const videoFeed = document.getElementById('videoFeed');
    if (videoFeed) {
      videoFeed.style.overflowY = 'auto';
      videoFeed.style.webkitOverflowScrolling = 'touch';
    }
    
    // Make sure video info and actions are visible
    const videoInfos = document.querySelectorAll('.video-info');
    const videoActions = document.querySelectorAll('.video-actions');
    const playOverlays = document.querySelectorAll('.play-overlay');
    
    videoInfos.forEach(info => {
      info.style.opacity = '1';
      info.style.transform = 'translateY(0)';
    });
    
    videoActions.forEach(actions => {
      actions.style.opacity = '1';
      actions.style.transform = 'translateX(0)';
    });
    
    playOverlays.forEach(overlay => {
      overlay.style.opacity = '1';
      overlay.style.scale = '1';
    });
  }
});

// Initialize feed
async function initFeed() {
  const feedContainer = document.getElementById('videoFeed');
  if (!feedContainer) {
    console.error('Video feed container not found!');
    return;
  }
  
  console.log('Initializing video feed...');
  
  // Clear existing content
  feedContainer.innerHTML = '';
  videos = [];
  nextCursor = null;
  hasMoreVideos = true;
  
  // Show initial loading state
  feedContainer.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; text-align: center;">
      <div>
        <div class="spinner" style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>Memuat video feed...</p>
      </div>
    </div>
  `;
  
  // Load initial videos from API
  await loadVideosFromAPI();
  
  // Set up intersection observer for auto-play
  setupIntersectionObserver();
  
  // Set up scroll listener
  setupScrollListener();
  
  // Set up infinite scroll
  setupInfiniteScroll();
  
  console.log('Video feed initialized successfully');
}

// Load videos from API using cursor-based pagination
async function loadVideosFromAPI(append = false) {
  if (isLoading || (!hasMoreVideos && append)) return;
  
  isLoading = true;
  console.log('Loading videos from API...', { append, nextCursor });
  
  try {
    // Try multiple API endpoints for better compatibility
    let urls = [
      `${API_BASE_URL}/feed/videos/cursor?limit=5`,
      `${API_BASE_URL}/feed/videos?page=1&per_page=5`,
      `${API_BASE_URL}/videos?page=1&per_page=5`,
      `${API_BASE_URL}/list_videos_db`
    ];
    
    if (nextCursor && append) {
      urls[0] += `&cursor=${encodeURIComponent(nextCursor)}`;
    }
    
    let data = null;
    let response = null;
    
    // Try each endpoint until one works
    for (let i = 0; i < urls.length; i++) {
      try {
        console.log(`Trying API endpoint ${i + 1}:`, urls[i]);
        response = await fetch(urls[i]);
        data = await response.json();
        
        // Handle different response formats
        if (data.success && data.data && data.data.length > 0) {
          console.log(`Success with endpoint ${i + 1}:`, data);
          break;
        } else if (Array.isArray(data) && data.length > 0) {
          // Handle direct array response (like /api/list_videos_db)
          console.log(`Success with endpoint ${i + 1} (array format):`, data);
          data = { success: true, data: data };
          break;
        } else {
          console.log(`Endpoint ${i + 1} failed:`, data);
        }
      } catch (err) {
        console.log(`Endpoint ${i + 1} error:`, err);
        continue;
      }
    }
    
    if (data && data.success && data.data && data.data.length > 0) {
      const feedContainer = document.getElementById('videoFeed');
      
      if (!append) {
        // Clear existing content for first load
        feedContainer.innerHTML = '';
        videos = [];
      }
      
      // Sort videos so the newest appears first
      const sortedVideos = sortVideosByDate(data.data);
      console.log('Sorted videos by date (newest first):', sortedVideos);
      
      // Create video elements from sorted API data
      sortedVideos.forEach((video, index) => {
        console.log('Creating video element:', video);
        const videoElement = createVideoElement(video, videos.length + index);
        if (videoElement) {
          feedContainer.appendChild(videoElement);
          videos.push(videoElement);
          
          // Ensure the very first item auto plays smoothly
          if (!append && index === 0) {
            const videoTag = videoElement.querySelector('video');
            if (videoTag) {
              videoTag.setAttribute('autoplay', '');
              videoTag.setAttribute('preload', 'auto');
              setTimeout(() => {
                videoTag.play().catch(err => {
                  console.log('Autoplay prevented for first video:', err);
                });
              }, 150);
            }
          }
          
          // Ensure mobile visibility
          if (isMobile()) {
            const videoInfo = videoElement.querySelector('.video-info');
            const videoActions = videoElement.querySelector('.video-actions');
            const playOverlay = videoElement.querySelector('.play-overlay');
            
            if (videoInfo) {
              videoInfo.style.opacity = '1';
              videoInfo.style.transform = 'translateY(0)';
            }
            if (videoActions) {
              videoActions.style.opacity = '1';
              videoActions.style.transform = 'translateX(0)';
            }
            if (playOverlay) {
              playOverlay.style.opacity = '1';
              playOverlay.style.scale = '1';
            }
          }
        }
      });
      
      // Update pagination info
      hasMoreVideos = data.pagination ? data.pagination.has_more : false;
      nextCursor = data.pagination ? data.pagination.next_cursor : null;
      
      // Re-setup intersection observer for new videos
      if (append) {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          setupIntersectionObserver();
        }, 50);
      } else {
        // Setup intersection observer for initial load
        setTimeout(() => {
          setupIntersectionObserver();
          // Auto-play first video if available
          if (videos.length > 0) {
            const firstVideo = videos[0].querySelector('video');
            if (firstVideo) {
              setTimeout(() => {
                firstVideo.play().catch(e => {
                  console.log('First video autoplay prevented:', e);
                });
              }, 300);
            }
          }
        }, 200);
      }
      
      console.log(`Successfully loaded ${data.data.length} videos from API`);
    } else {
      console.error('All API endpoints failed, using dummy data');
      // Show error message to user
      if (!append) {
        const feedContainer = document.getElementById('videoFeed');
        feedContainer.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; text-align: center;">
            <div>
              <div style="font-size: 48px; margin-bottom: 20px;"></div>
              <h3>Gagal Memuat Video</h3>
              <p>API tidak dapat diakses. Menggunakan video demo...</p>
              <button onclick="retryLoadVideos()" style="background: #ff6b6b; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                Coba Lagi
              </button>
            </div>
          </div>
        `;
        // Load dummy videos after showing error
        setTimeout(() => {
          loadDummyVideos();
        }, 2000);
      }
    }
  } catch (error) {
    console.error('Error loading videos:', error);
    // Show error message to user
    if (!append) {
      const feedContainer = document.getElementById('videoFeed');
      feedContainer.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; text-align: center;">
          <div>
            <div style="font-size: 48px; margin-bottom: 20px;"></div>
            <h3>Terjadi Kesalahan</h3>
            <p>Gagal memuat video: ${error.message}</p>
            <button onclick="retryLoadVideos()" style="background: #ff6b6b; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">
              Coba Lagi
            </button>
          </div>
        </div>
      `;
    }
  } finally {
    isLoading = false;
  }
}

// Fallback to dummy videos if API fails
function loadDummyVideos() {
  console.log('Loading dummy videos as fallback...');
  const feedContainer = document.getElementById('videoFeed');
  feedContainer.innerHTML = '';
  videos = [];
  
  const dummyVideos = [
    {
      id: 1,
      title: "Amazing AI Generated Music",
      caption: "Check out this incredible music created with AI technology! ",
      video_url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
      thumbnail_url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/BigBuckBunny.jpg",
      user: {
        username: "AI Music Creator",
        avatar_url: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face"
      },
      stats: {
        likes: 150,
        comments: 25,
        views: 1000,
        shares: 0
      },
      interactions: {
        is_liked: false
      },
      created_at: new Date().toISOString()
    },
    {
      id: 2,
      title: "Stunning AI Art Generation",
      caption: "Watch as AI creates beautiful digital art in real-time! ",
      video_url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4",
      thumbnail_url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ElephantsDream.jpg",
      user: {
        username: "Digital Artist",
        avatar_url: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&h=100&fit=crop&crop=face"
      },
      stats: {
        likes: 200,
        comments: 35,
        views: 1500,
        shares: 0
      },
      interactions: {
        is_liked: false
      },
      created_at: new Date(Date.now() - 3600000).toISOString()
    },
    {
      id: 3,
      title: "AI Video Creation Magic",
      caption: "See how AI transforms text into amazing videos! ",
      video_url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4",
      thumbnail_url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ForBiggerBlazes.jpg",
      user: {
        username: "Video Creator",
        avatar_url: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face"
      },
      stats: {
        likes: 89,
        comments: 12,
        views: 500,
        shares: 0
      },
      interactions: {
        is_liked: false
      },
      created_at: new Date(Date.now() - 7200000).toISOString()
    }
  ];
  
  // Shuffle dummy videos before creating elements
  const shuffledDummyVideos = shuffleArray(dummyVideos);
  console.log('Shuffled dummy videos:', shuffledDummyVideos);
  
  shuffledDummyVideos.forEach((video, index) => {
    console.log('Creating dummy video element:', video);
    const videoElement = createVideoElement(video, index);
    feedContainer.appendChild(videoElement);
    videos.push(videoElement);
    
    // Ensure mobile visibility
    if (isMobile()) {
      const videoInfo = videoElement.querySelector('.video-info');
      const videoActions = videoElement.querySelector('.video-actions');
      const playOverlay = videoElement.querySelector('.play-overlay');
      
      if (videoInfo) {
        videoInfo.style.opacity = '1';
        videoInfo.style.transform = 'translateY(0)';
      }
      if (videoActions) {
        videoActions.style.opacity = '1';
        videoActions.style.transform = 'translateX(0)';
      }
      if (playOverlay) {
        playOverlay.style.opacity = '1';
        playOverlay.style.scale = '1';
      }
    }
  });
  
  // Setup intersection observer after a short delay
  setTimeout(() => {
    setupIntersectionObserver();
    // Auto-play first video if available
    if (videos.length > 0) {
      const firstVideo = videos[0].querySelector('video');
      if (firstVideo) {
        setTimeout(() => {
          firstVideo.play().catch(e => {
            console.log('First video autoplay prevented:', e);
          });
        }, 300);
      }
    }
  }, 200);
  
  console.log(`Loaded ${dummyVideos.length} dummy videos`);
}

// Create individual video element
function createVideoElement(video, index) {
  const videoContainer = document.createElement('div');
  videoContainer.className = 'video-item';
  videoContainer.id = `video-${video.id}`;
  
   // Handle API data format - support multiple formats
   const videoUrl = video.video_url || video.videoUrl || video.url;
   const thumbnail = video.thumbnail_url || video.thumbnail || video.image_url || '/static/assets/image/default.jpg';
   
   // Filter out "AI asisten Inemi" from title
   let rawTitle = video.title || video.caption || 'Untitled Video';
   rawTitle = rawTitle.replace(/AI asisten Inemi/gi, '').replace(/asisten Inemi/gi, '').trim();
   const title = rawTitle || 'Untitled Video';
   
   // Filter out "AI asisten Inemi" from caption/description
   let rawCaption = video.caption || video.description || '';
   rawCaption = rawCaption.replace(/AI asisten Inemi/gi, '').replace(/asisten Inemi/gi, '').trim();
   const caption = truncateText(rawCaption, 300);
  
  const username = video.user?.username || video.username || video.author || 'Unknown User';
  const userAvatar = video.user?.avatar_url || video.user_avatar || video.authorAvatar || '/static/assets/image/default.jpg';
  const viewCount = video.stats?.views || video.view_count || video.views || 0;
  const likesCount = video.stats?.likes || video.likes || 0;
  const commentsCount = video.stats?.comments || video.comments || 0;
  const sharesCount = video.stats?.shares || video.shares || 0;
  const isLiked = video.interactions?.is_liked || video.isLiked || false;
  
  // Format time ago
  const timeAgo = video.created_at ? formatTimeAgo(video.created_at) : '2 hours ago';
  
  // Debug logging
  console.log('Creating video element with data:', {
    id: video.id,
    videoUrl,
    thumbnail,
    title,
    username,
    originalData: video
  });
  
  // Validate video URL
  if (!videoUrl || videoUrl === '') {
    console.warn(`Video ${video.id} has no valid URL, skipping...`);
    return null;
  }
  
  // Add loading and error states
  videoContainer.innerHTML = `
    <div class="video-loading" id="loading-${video.id}">
      <div class="spinner"></div>
      <p>Memuat video...</p>
    </div>
    
    <div class="video-error" id="error-${video.id}" style="display: none;">
      <div class="error-icon"></div>
      <p>Gagal memuat video</p>
      <button onclick="retryVideo(${video.id})">Coba Lagi</button>
    </div>
    
    <video 
      class="video-player" 
      preload="none"
      poster="${thumbnail}"
      muted
      playsinline
      loop
      data-video-id="${video.id}"
      onloadstart="showVideoLoading(${video.id})"
      onloadeddata="hideVideoLoading(${video.id}); this.classList.add('loaded')"
      oncanplay="hideVideoLoading(${video.id}); this.classList.add('loaded')"
      oncanplaythrough="this.classList.add('loaded'); this.classList.add('ready')"
      onerror="showVideoError(${video.id})"
      onloadedmetadata="console.log('Video ${video.id} metadata loaded')"
      onplay="this.classList.add('playing')"
      onpause="this.classList.remove('playing')"
    >
      <source src="${videoUrl}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    
    <div class="play-overlay" onclick="toggleVideoPlay(this)"></div>
    
    <div class="video-overlay"></div>
    
    <div class="video-info">
      <div class="video-author">
        <img src="${userAvatar}" alt="${username}" class="video-author-avatar" onerror="this.src='/static/assets/image/default.jpg'">
        <div class="video-author-info">
          <h4>${username}</h4>
          <p>${timeAgo}</p>
        </div>
      </div>
      <div class="video-title">${title}</div>
      <div class="video-description">${caption}</div>
      <div class="video-stats">
        <span class="view-count">${formatNumber(viewCount)} views</span>
      </div>
    </div>
    
    <div class="video-actions">
      <button class="video-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${video.id}, this)">
        <div class="action-icon like-icon">
          <i class="bi ${isLiked ? 'bi-heart-fill' : 'bi-heart'}"></i>
        </div>
        <div class="action-count">${formatNumber(likesCount)}</div>
      </button>
      <button class="video-action-btn" onclick="showComments(${video.id})">
        <div class="action-icon comment-icon">
          <i class="bi bi-chat-dots"></i>
        </div>
        <div class="action-count">${formatNumber(commentsCount)}</div>
      </button>
      <button class="video-action-btn" onclick="shareVideo(${video.id})">
        <div class="action-icon share-icon">
          <i class="bi bi-send-fill"></i>
        </div>
        <div class="action-count">${formatNumber(sharesCount)}</div>
      </button>
    </div>
    
  `;
  
  return videoContainer;
}

// Format time ago (real-time, Bahasa Indonesia)
function formatTimeAgo(dateString) {
  if (!dateString) return 'Baru saja';
  
  try {
    const now = new Date();
    const date = new Date(dateString);
    
    // Check if date is valid
    if (isNaN(date.getTime())) {
      console.warn('Invalid date string:', dateString);
      return 'Baru saja';
    }
    
    // Check if date is in the future (more than 1 minute ahead)
    // This handles cases where server time is wrong
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    // If date is in the future or less than 1 minute ago, show "Baru saja"
    if (diffInSeconds < 0) {
      console.warn('Date is in the future:', dateString, 'Current time:', now.toISOString());
      return 'Baru saja';
    }
    
    // If less than 1 minute, always show "Baru saja"
    if (diffInSeconds < 60) {
      return 'Baru saja';
    } else if (diffInSeconds < 3600) {
      const minutes = Math.floor(diffInSeconds / 60);
      return `${minutes} menit yang lalu`;
    } else if (diffInSeconds < 86400) {
      const hours = Math.floor(diffInSeconds / 3600);
      return `${hours} jam yang lalu`;
    } else if (diffInSeconds < 2592000) {
      const days = Math.floor(diffInSeconds / 86400);
      return `${days} hari yang lalu`;
    } else if (diffInSeconds < 31536000) {
      const months = Math.floor(diffInSeconds / 2592000);
      return `${months} bulan yang lalu`;
    } else {
      const years = Math.floor(diffInSeconds / 31536000);
      return `${years} tahun yang lalu`;
    }
  } catch (error) {
    console.error('Error formatting time:', error, 'dateString:', dateString);
    return 'Baru saja';
  }
}

// Update comment timestamps in real-time
function updateCommentTimestamps() {
  const commentTimes = document.querySelectorAll('.comment-time');
  commentTimes.forEach(element => {
    const timestamp = element.dataset.timestamp;
    if (timestamp) {
      element.textContent = formatTimeAgo(timestamp);
    }
  });
}

// Start auto-update for comment timestamps (every 10 seconds for real-time feel)
let commentTimestampInterval = null;
function startCommentTimestampUpdater() {
  if (commentTimestampInterval) {
    clearInterval(commentTimestampInterval);
  }
  // Update every 10 seconds for more real-time feel
  commentTimestampInterval = setInterval(updateCommentTimestamps, 10000);
  
  // Also update immediately
  updateCommentTimestamps();
}

function stopCommentTimestampUpdater() {
  if (commentTimestampInterval) {
    clearInterval(commentTimestampInterval);
    commentTimestampInterval = null;
  }
}

// Enhanced intersection observer for smooth auto-play
let currentObserver = null;

function setupIntersectionObserver() {
  // Disconnect previous observer if exists
  if (currentObserver) {
    currentObserver.disconnect();
  }
  
  currentObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const videoItem = entry.target;
      const video = videoItem.querySelector('video');
      if (!video) return;
      
      if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
        // Video is in viewport and at least 50% visible - play it
        videoItem.classList.remove('loading');
        videoItem.classList.add('playing');
        
        // Preload video if not loaded
        if (video.readyState < 2) {
          video.load();
        }
        
        // Try to play video
        const playPromise = video.play();
        
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              // Video playing successfully
              video.classList.add('playing');
              videoItem.classList.add('playing');
              isPlaying = true;
              
              // Hide play overlay
              const playOverlay = videoItem.querySelector('.play-overlay');
              if (playOverlay) {
                playOverlay.classList.add('hidden');
              }
              
              // Preload next video for smoother transition
              preloadNextVideo(videoItem);
            })
            .catch(e => {
              console.log('Autoplay prevented:', e);
              // Show play button if autoplay fails
              const playOverlay = videoItem.querySelector('.play-overlay');
              if (playOverlay) {
                playOverlay.classList.remove('hidden');
                videoItem.classList.add('paused');
              }
            });
        }
      } else {
        // Video is out of viewport - pause it
        video.pause();
        video.classList.remove('playing');
        videoItem.classList.remove('playing');
        videoItem.classList.add('loading');
        isPlaying = false;
        
        // Show play overlay when paused
        const playOverlay = videoItem.querySelector('.play-overlay');
        if (playOverlay && video.paused) {
          playOverlay.classList.remove('hidden');
          videoItem.classList.add('paused');
        }
      }
    });
  }, {
    threshold: [0.5], // Single threshold for better performance
    rootMargin: '0px'
  });

  // Observe all video containers
  videos.forEach(videoContainer => {
    currentObserver.observe(videoContainer);
  });
  
  console.log(`Observing ${videos.length} videos for auto-play`);
}

// Preload next video for smoother scrolling
function preloadNextVideo(currentVideoItem) {
  const feedContainer = document.getElementById('videoFeed');
  if (!feedContainer) return;
  
  const currentIndex = Array.from(feedContainer.children).indexOf(currentVideoItem);
  const nextIndex = currentIndex + 1;
  
  if (nextIndex < videos.length) {
    const nextVideoItem = videos[nextIndex];
    const nextVideo = nextVideoItem.querySelector('video');
    
    if (nextVideo && nextVideo.readyState === 0) {
      // Set preload attribute and load metadata
      nextVideo.preload = 'metadata';
      nextVideo.load();
      nextVideoItem.setAttribute('data-preload', 'true');
      
      // Remove preload flag once loaded
      nextVideo.addEventListener('loadedmetadata', () => {
        nextVideoItem.removeAttribute('data-preload');
      }, { once: true });
    }
  }
}

// Enhanced scroll listener with better performance - Optimized
let scrollTimeout;
let isScrolling = false;
let scrollRAF = null;
let lastScrollTop = 0;

function setupScrollListener() {
  const feedContainer = document.getElementById('videoFeed');
  if (!feedContainer) return;
  
  // Use requestAnimationFrame for smooth scroll handling
  feedContainer.addEventListener('scroll', () => {
    // Cancel previous RAF if exists
    if (scrollRAF) {
      cancelAnimationFrame(scrollRAF);
    }
    
    // Use RAF for visual feedback (smooth)
    scrollRAF = requestAnimationFrame(() => {
      if (!isScrolling) {
        isScrolling = true;
        feedContainer.classList.add('scrolling');
      }
    });
    
    // Throttle heavy operations (use longer timeout for better performance)
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    
    scrollTimeout = setTimeout(() => {
      isScrolling = false;
      feedContainer.classList.remove('scrolling');
      
      const scrollTop = feedContainer.scrollTop;
      const containerHeight = feedContainer.clientHeight;
      
      // Only update if scroll position changed significantly (reduce calculations)
      if (Math.abs(scrollTop - lastScrollTop) > containerHeight * 0.1) {
        lastScrollTop = scrollTop;
        const newIndex = Math.round(scrollTop / containerHeight);
        
        if (newIndex !== currentVideoIndex && newIndex >= 0 && newIndex < videos.length) {
          currentVideoIndex = newIndex;
          
          // Preload adjacent videos (only next 1 video for better performance)
          preloadAdjacentVideos(newIndex);
        }
      }
    }, 200); // Increased throttle time for better performance
  }, { passive: true });
}

// Preload adjacent videos for smoother experience - Optimized
function preloadAdjacentVideos(currentIndex) {
  // Only preload next 1 video to reduce memory usage
  const nextIndex = currentIndex + 1;
  if (nextIndex < videos.length && nextIndex < videos.length) {
    const nextVideoItem = videos[nextIndex];
    const nextVideo = nextVideoItem.querySelector('video');
    
    if (nextVideo && nextVideo.readyState === 0 && nextVideo.preload === 'none') {
      nextVideo.preload = 'metadata';
      // Use requestIdleCallback if available for non-critical preloading
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
          nextVideo.load();
        }, { timeout: 1000 });
      } else {
        setTimeout(() => nextVideo.load(), 100);
      }
    }
  }
}

// Set up infinite scroll - Optimized with throttling
let infiniteScrollTimeout;
function setupInfiniteScroll() {
  const feedContainer = document.getElementById('videoFeed');
  if (!feedContainer) return;
  
  feedContainer.addEventListener('scroll', () => {
    // Throttle infinite scroll check
    if (infiniteScrollTimeout) {
      clearTimeout(infiniteScrollTimeout);
    }
    
    infiniteScrollTimeout = setTimeout(() => {
      const { scrollTop, scrollHeight, clientHeight } = feedContainer;
      const threshold = 200; // Increased threshold for better UX
      
      if (scrollHeight - scrollTop - clientHeight < threshold && hasMoreVideos && !isLoading) {
        loadVideosFromAPI(true);
      }
    }, 300); // Throttle to reduce API calls
  }, { passive: true });
}



 



// Format numbers (e.g., 1000 -> 1K)
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

// Truncate text to specified length with ellipsis
function truncateText(text, maxLength = 300) {
  if (!text || text.length <= maxLength) {
    return text;
  }
  
  // Find the last space before the limit to avoid cutting words
  const truncated = text.substring(0, maxLength);
  const lastSpaceIndex = truncated.lastIndexOf(' ');
  
  if (lastSpaceIndex > maxLength * 0.8) { // If we can find a space in the last 20%
    return truncated.substring(0, lastSpaceIndex) + '...';
  } else {
    return truncated + '...';
  }
}


// Video loading and error handling functions
function showVideoLoading(videoId) {
  const loadingEl = document.getElementById(`loading-${videoId}`);
  const errorEl = document.getElementById(`error-${videoId}`);
  if (loadingEl) loadingEl.style.display = 'block';
  if (errorEl) errorEl.style.display = 'none';
}

function hideVideoLoading(videoId) {
  const loadingEl = document.getElementById(`loading-${videoId}`);
  if (loadingEl) loadingEl.style.display = 'none';
}

function showVideoError(videoId) {
  const loadingEl = document.getElementById(`loading-${videoId}`);
  const errorEl = document.getElementById(`error-${videoId}`);
  if (loadingEl) loadingEl.style.display = 'none';
  if (errorEl) errorEl.style.display = 'block';
  console.error(`Video ${videoId} failed to load`);
}

function retryVideo(videoId) {
  const videoContainer = document.getElementById(`video-${videoId}`);
  const video = videoContainer.querySelector('video');
  if (video) {
    showVideoLoading(videoId);
    video.load(); // Reload the video
  }
}

// Video interaction functions
function toggleVideoPlay(playButton) {
  const videoContainer = playButton.closest('.video-item');
  const video = videoContainer.querySelector('video');
  const playOverlay = videoContainer.querySelector('.play-overlay');
  
  if (video.paused) {
    video.play().catch(e => {
      console.log('Video play failed:', e);
      showToast('Gagal memutar video', 'error');
    });
    playOverlay.classList.add('hidden');
  } else {
    video.pause();
    playOverlay.classList.remove('hidden');
  }
}

async function toggleLike(videoId, button) {
  try {
    const response = await fetch(`${API_BASE_URL}/feed/video/${videoId}/like`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      button.classList.toggle('liked', data.is_liked);
      const countElement = button.querySelector('.action-count');
      countElement.textContent = formatNumber(data.likes_count);
      
      // Update Bootstrap Icon
      const iconElement = button.querySelector('.like-icon i');
      if (iconElement) {
        if (data.is_liked) {
          iconElement.className = 'bi bi-heart-fill';
        } else {
          iconElement.className = 'bi bi-heart';
        }
      }
      
      // Add animation effect
      button.style.animation = 'likePulse 0.3s ease';
      setTimeout(() => {
        button.style.animation = '';
      }, 300);
    }
  } catch (error) {
    console.error('Error toggling like:', error);
    // Show error message to user
    showToast('Gagal mengubah status like', 'error');
  }
}

async function showComments(videoId) {
  try {
    const response = await fetch(`${API_BASE_URL}/feed/video/${videoId}/comments?page=1&per_page=50`);
    const data = await response.json();
    
    if (data.success) {
      // Create modal for comments
      createCommentsModal(videoId, data.comments || []);
    } else {
      showToast('Gagal memuat komentar', 'error');
    }
  } catch (error) {
    console.error('Error loading comments:', error);
    showToast('Gagal memuat komentar', 'error');
    // Still show modal with empty comments
    createCommentsModal(videoId, []);
  }
}

// Store current video data for sharing
let currentShareVideoData = null;

async function shareVideo(videoId) {
  try {
    // Get video data from DOM
    const videoElement = document.getElementById(`video-${videoId}`);
    if (!videoElement) {
      showToast('Video tidak ditemukan', 'error');
      return;
    }
    
    // Extract video data
    const videoTitle = videoElement.querySelector('.video-title')?.textContent || 'Video Menarik';
    const videoCaption = videoElement.querySelector('.video-description')?.textContent || 'Lihat video ini!';
    const videoAuthor = videoElement.querySelector('.video-author-info h4')?.textContent || '';
    
    // Store video data for sharing
    currentShareVideoData = {
      id: videoId,
      title: videoTitle,
      caption: videoCaption,
      author: videoAuthor,
      url: `${window.location.origin}/explore#video-${videoId}`
    };
    
    // Increment share count in UI (client-side only for now)
    // API call is optional - just for tracking purposes
    try {
      const response = await fetch(`${API_BASE_URL}/feed/video/${videoId}/share`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      // API call succeeded, but we increment locally regardless
    } catch (apiError) {
      // API call failed, but we still increment locally
      console.log('Share API call failed (non-critical):', apiError);
    }
    
    // Always increment share count in UI
    const shareBtn = videoElement.querySelector('.video-action-btn:last-child .action-count');
    if (shareBtn) {
      const currentCount = parseInt(shareBtn.textContent.replace(/\D/g, '')) || 0;
      shareBtn.textContent = formatNumber(currentCount + 1);
    }
    
    // Open share modal
    openShareModal();
  } catch (error) {
    console.error('Error sharing video:', error);
    showToast('Gagal membagikan video', 'error');
  }
}

function openShareModal() {
  const modal = document.getElementById('shareModal');
  if (modal) {
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
  }
}

function getShareUrl() {
  if (currentShareVideoData) {
    return currentShareVideoData.url;
  }
  return window.location.href;
}

function getShareText() {
  if (currentShareVideoData) {
    const title = currentShareVideoData.title || 'Video Menarik';
    const caption = currentShareVideoData.caption || '';
    const author = currentShareVideoData.author ? ` - ${currentShareVideoData.author}` : '';
    return `${title}${caption ? ' - ' + caption : ''}${author}`;
  }
  return 'Lihat video menarik ini di Inemi!';
}

function shareToWhatsApp() {
  const url = encodeURIComponent(getShareUrl());
  const text = encodeURIComponent(getShareText());
  window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
}

function shareToFacebook() {
  const url = encodeURIComponent(getShareUrl());
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareToTwitter() {
  const url = encodeURIComponent(getShareUrl());
  const text = encodeURIComponent(getShareText());
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
}

function shareToTelegram() {
  const url = encodeURIComponent(getShareUrl());
  const text = encodeURIComponent(getShareText());
  window.open(`https://t.me/share/url?url=${url}&text=${text}`, '_blank');
}

function shareToInstagram() {
  // Instagram doesn't support direct sharing via URL, so copy link instead
  copyShareLink();
  showToast('Salin link dan bagikan di Instagram Story atau Post', 'info');
}

function copyShareLink(event) {
  const url = getShareUrl();
  navigator.clipboard.writeText(url).then(() => {
    showToast('Link berhasil disalin!', 'success');
    if (event) {
      const button = event.target.closest('button');
      if (button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check-circle fs-4"></i><div class="mt-2">Tersalin!</div>';
        button.classList.remove('btn-outline-light');
        button.classList.add('btn-success');
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('btn-success');
          button.classList.add('btn-outline-light');
        }, 2000);
      }
    }
  }).catch(err => {
    console.error('Failed to copy: ', err);
    showToast('Gagal menyalin link', 'error');
  });
}

// Use native Web Share API if available
function useNativeShare() {
  if (navigator.share && currentShareVideoData) {
    navigator.share({
      title: currentShareVideoData.title || 'Video Menarik',
      text: getShareText(),
      url: getShareUrl()
    }).then(() => {
      console.log('Shared successfully');
    }).catch((error) => {
      console.log('Error sharing:', error);
    });
  } else {
    // Fallback to modal
    openShareModal();
  }
}

// Create comments modal
function createCommentsModal(videoId, comments) {
  // Remove existing modal if any
  const existingModal = document.querySelector('.comments-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.className = 'comments-modal';
  modal.innerHTML = `
    <div class="modal-overlay" onclick="closeCommentsModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Komentar</h3>
        <button class="close-btn" onclick="closeCommentsModal()"></button>
      </div>
      <div class="modal-body">
        <div class="comments-list" id="commentsList">
          ${comments && comments.length > 0 ? comments.map(comment => {
            // Check if we have a stored timestamp for this comment (from when it was created)
            let timestamp = commentTimestamps.get(comment.id);
            
            if (!timestamp) {
              // No stored timestamp, use server timestamp
              timestamp = comment.created_at || new Date().toISOString();
              
              // Validate timestamp - only replace if invalid or in the future
              const serverTime = new Date(timestamp);
              const now = new Date();
              
              // Only replace timestamp if it's invalid or in the future (not if it's old)
              // Old timestamps are valid and should be used as-is
              if (isNaN(serverTime.getTime()) || serverTime > now) {
                // Invalid or future timestamp, use current time as fallback
                timestamp = new Date().toISOString();
                console.warn('Invalid or future timestamp detected, using current time:', {
                  comment_id: comment.id,
                  server_timestamp: comment.created_at,
                  using: timestamp
                });
              } else {
                // Valid server timestamp, store it for future reference
                commentTimestamps.set(comment.id, serverTime.getTime());
              }
            } else {
              // Use stored timestamp (convert from milliseconds to ISO string)
              timestamp = new Date(timestamp).toISOString();
            }
            
            return `
            <div class="comment-item">
              <img src="${comment.user?.avatar_url || '/static/assets/image/default.jpg'}" alt="${comment.user?.username || 'User'}" class="comment-avatar" onerror="this.src='/static/assets/image/default.jpg'">
              <div class="comment-content">
                <div class="comment-header">
                  <span class="comment-username">${comment.user?.username || 'User'}</span>
                  <span class="comment-time" data-timestamp="${timestamp}">${formatTimeAgo(timestamp)}</span>
                </div>
                <div class="comment-text">${comment.comment || comment.text || ''}</div>
              </div>
            </div>
          `;
          }).join('') : '<div class="no-comments">Belum ada komentar. Jadilah yang pertama berkomentar!</div>'}
        </div>
        <div class="comment-input">
          <input type="text" placeholder="Tulis komentar..." id="commentInput" onkeypress="handleCommentKeyPress(event, ${videoId})">
          <button onclick="addComment(${videoId})" id="commentSubmitBtn">Kirim</button>
        </div>
      </div>
    </div>
  `;
  
  // Add modal styles
  const style = document.createElement('style');
  style.textContent = `
    .comments-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
    }
    
    .modal-content {
      background: #1a1a1a;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      z-index: 1001;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #333;
    }
    
    .modal-header h3 {
      color: #fff;
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .comment-item {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .comment-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }
    
    .comment-content {
      flex: 1;
    }
    
    .comment-header {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
    }
    
    .comment-username {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
    
    .comment-time {
      color: #999;
      font-size: 12px;
    }
    
    .comment-text {
      color: #fff;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .no-comments {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-size: 14px;
    }
    
    .comment-input {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-top: 1px solid #333;
    }
    
    .comment-input input {
      flex: 1;
      background: #333;
      border: none;
      border-radius: 20px;
      padding: 10px 15px;
      color: #fff;
      font-size: 14px;
      outline: none;
    }
    
    .comment-input input:focus {
      background: #404040;
    }
    
    .comment-input button {
      background: #ff6b6b;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .comment-input button:hover {
      background: #ff5252;
    }
    
    .comment-input button:disabled {
      background: #666;
      cursor: not-allowed;
    }
  `;
  
  document.head.appendChild(style);
  document.body.appendChild(modal);
  
  // Start auto-update timestamps for comments
  startCommentTimestampUpdater();
  
  // Focus on input
  setTimeout(() => {
    const input = document.getElementById('commentInput');
    if (input) input.focus();
  }, 100);
}

function closeCommentsModal() {
  // Stop timestamp updater when modal closes
  stopCommentTimestampUpdater();
  
  const modal = document.querySelector('.comments-modal');
  if (modal) {
    modal.remove();
  }
}

// Handle Enter key press in comment input
function handleCommentKeyPress(event, videoId) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    addComment(videoId);
  }
}

async function addComment(videoId) {
  const input = document.getElementById('commentInput');
  const submitBtn = document.getElementById('commentSubmitBtn');
  const comment = input.value.trim();
  
  if (!comment) {
    showToast('Komentar tidak boleh kosong', 'error');
    return;
  }
  
  // Disable button and input while submitting
  if (submitBtn) submitBtn.disabled = true;
  if (input) input.disabled = true;
  
  try {
    const response = await fetch(`${API_BASE_URL}/feed/video/${videoId}/comment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ comment })
    });
    
    const data = await response.json();
    
    if (data.success) {
      input.value = '';
      showToast('Komentar berhasil ditambahkan!', 'success');
      
      // Update comment count in video actions
      const videoElement = document.getElementById(`video-${videoId}`);
      if (videoElement) {
        const commentBtn = videoElement.querySelector('.video-action-btn:nth-child(2) .action-count');
        if (commentBtn) {
          const currentCount = parseInt(commentBtn.textContent.replace(/\D/g, '')) || 0;
          commentBtn.textContent = formatNumber(currentCount + 1);
        }
      }
      
      // Add new comment directly to the list with real-time timestamp
      const commentsList = document.getElementById('commentsList');
      if (commentsList && data.comment) {
        // Always use current client time for new comments (not server time which might be wrong)
        // This ensures "Baru saja" is displayed correctly
        const commentTimestamp = new Date();
        const commentTimestampISO = commentTimestamp.toISOString();
        
        // Store the timestamp in memory so it persists even after refresh
        if (data.comment.id) {
          commentTimestamps.set(data.comment.id, commentTimestamp.getTime());
          console.log('Stored comment timestamp:', {
            comment_id: data.comment.id,
            timestamp: commentTimestampISO,
            timestamp_ms: commentTimestamp.getTime()
          });
        }
        
        console.log('Adding new comment:', {
          comment_id: data.comment.id,
          server_timestamp: data.comment.created_at,
          client_timestamp: commentTimestampISO,
          comment_text: data.comment.comment || data.comment.text
        });
        
        // Create new comment element
        const newCommentHTML = `
          <div class="comment-item">
            <img src="${data.comment.user?.avatar_url || '/static/assets/image/default.jpg'}" alt="${data.comment.user?.username || 'User'}" class="comment-avatar" onerror="this.src='/static/assets/image/default.jpg'">
            <div class="comment-content">
              <div class="comment-header">
                <span class="comment-username">${data.comment.user?.username || 'User'}</span>
                <span class="comment-time" data-timestamp="${commentTimestampISO}">Baru saja</span>
              </div>
              <div class="comment-text">${data.comment.comment || data.comment.text || ''}</div>
            </div>
          </div>
        `;
        
        // Remove "no comments" message if exists
        const noCommentsMsg = commentsList.querySelector('.no-comments');
        if (noCommentsMsg) {
          noCommentsMsg.remove();
        }
        
        // Add new comment at the top of the list (newest first)
        commentsList.insertAdjacentHTML('afterbegin', newCommentHTML);
        
        // Scroll to top to show new comment
        commentsList.scrollTop = 0;
        
        // Update timestamp immediately and start auto-update
        updateCommentTimestamps();
        startCommentTimestampUpdater();
      } else {
        // Fallback: refresh comments list
        await refreshCommentsList(videoId);
      }
    } else {
      showToast(data.error || 'Gagal menambahkan komentar', 'error');
    }
  } catch (error) {
    console.error('Error adding comment:', error);
    showToast('Gagal menambahkan komentar', 'error');
  } finally {
    // Re-enable button and input
    if (submitBtn) submitBtn.disabled = false;
    if (input) {
      input.disabled = false;
      input.focus();
    }
  }
}

// Store comment timestamps in memory to preserve real-time timestamps
const commentTimestamps = new Map();

// Refresh comments list without closing modal
async function refreshCommentsList(videoId) {
  try {
    const response = await fetch(`${API_BASE_URL}/feed/video/${videoId}/comments?page=1&per_page=50`);
    const data = await response.json();
    
    if (data.success && data.comments) {
      const commentsList = document.getElementById('commentsList');
      if (commentsList) {
        if (data.comments.length > 0) {
          // Sort comments by created_at descending (newest first)
          const sortedComments = [...data.comments].sort((a, b) => {
            // Use stored timestamp if available, otherwise use server timestamp
            const timeA = commentTimestamps.get(a.id) || (a.created_at ? new Date(a.created_at).getTime() : 0);
            const timeB = commentTimestamps.get(b.id) || (b.created_at ? new Date(b.created_at).getTime() : 0);
            return timeB - timeA; // Descending order
          });
          
          commentsList.innerHTML = sortedComments.map(comment => {
            // Check if we have a stored timestamp for this comment (from when it was created)
            let timestamp = commentTimestamps.get(comment.id);
            
            if (!timestamp) {
              // No stored timestamp, use server timestamp
              timestamp = comment.created_at || new Date().toISOString();
              
              // Validate timestamp - only replace if invalid or in the future
              const serverTime = new Date(timestamp);
              const now = new Date();
              
              // Only replace timestamp if it's invalid or in the future (not if it's old)
              // Old timestamps are valid and should be used as-is
              if (isNaN(serverTime.getTime()) || serverTime > now) {
                // Invalid or future timestamp, use current time as fallback
                timestamp = new Date().toISOString();
                console.warn('Invalid or future timestamp detected, using current time:', {
                  comment_id: comment.id,
                  server_timestamp: comment.created_at,
                  using: timestamp
                });
              } else {
                // Valid server timestamp, store it for future reference
                commentTimestamps.set(comment.id, serverTime.getTime());
              }
            } else {
              // Use stored timestamp (real-time from when comment was created)
              timestamp = new Date(timestamp).toISOString();
            }
            
            return `
            <div class="comment-item">
              <img src="${comment.user?.avatar_url || '/static/assets/image/default.jpg'}" alt="${comment.user?.username || 'User'}" class="comment-avatar" onerror="this.src='/static/assets/image/default.jpg'">
              <div class="comment-content">
                <div class="comment-header">
                  <span class="comment-username">${comment.user?.username || 'User'}</span>
                  <span class="comment-time" data-timestamp="${timestamp}">${formatTimeAgo(timestamp)}</span>
                </div>
                <div class="comment-text">${comment.comment || comment.text || ''}</div>
              </div>
            </div>
          `;
          }).join('');
          
          // Start auto-update timestamps
          startCommentTimestampUpdater();
        } else {
          commentsList.innerHTML = '<div class="no-comments">Belum ada komentar. Jadilah yang pertama berkomentar!</div>';
        }
        
        // Scroll to bottom to show new comment
        commentsList.scrollTop = commentsList.scrollHeight;
      }
    }
  } catch (error) {
    console.error('Error refreshing comments:', error);
  }
}

// Toast notification function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  
  // Add toast styles
  const style = document.createElement('style');
  style.textContent = `
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10000;
      animation: slideInRight 0.3s ease;
    }
    
    .toast-success {
      background: #4caf50;
    }
    
    .toast-error {
      background: #f44336;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  `;
  
  if (!document.querySelector('.toast-styles')) {
    style.className = 'toast-styles';
    document.head.appendChild(style);
  }
  
  document.body.appendChild(toast);
  
  // Remove toast after 3 seconds
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Retry loading videos function
async function retryLoadVideos() {
  console.log('Retrying to load videos...');
  const feedContainer = document.getElementById('videoFeed');
  
  // Show loading state
  feedContainer.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; text-align: center;">
      <div>
        <div class="spinner" style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>Mencoba memuat ulang video...</p>
      </div>
    </div>
  `;
  
  // Reset state
  videos = [];
  nextCursor = null;
  hasMoreVideos = true;
  isLoading = false;
  
  // Try to load videos again
  await loadVideosFromAPI();
}

// Test API endpoints function
async function testAPIEndpoints() {
  console.log('Testing API endpoints...');
  const endpoints = [
    '/api/feed/videos/cursor?limit=5',
    '/api/feed/videos?page=1&per_page=5',
    '/api/videos?page=1&per_page=5',
    '/api/list_videos_db'
  ];
  
  for (let endpoint of endpoints) {
    try {
      console.log(`Testing: ${endpoint}`);
      const response = await fetch(endpoint);
      const data = await response.json();
      console.log(` ${endpoint}:`, data);
    } catch (error) {
      console.log(` ${endpoint}:`, error);
    }
  }
}

// Navigation functions
function goToProfile() {
  window.location.href = '/profile';
}

function goToMenu() {
  // Toggle menu or navigate to menu page
  console.log('Menu clicked');
}

function goToHome() {
  window.location.href = '/';
}

function goToSparkle() {
  // Navigate to sparkle/featured page
  console.log('Sparkle clicked');
}

function goToExplore() {
  // Already on explore page
  console.log('Explore clicked');
}

// Show native share button if available
document.addEventListener('DOMContentLoaded', function() {
  if (navigator.share) {
    const nativeShareBtn = document.getElementById('nativeShareBtn');
    if (nativeShareBtn) {
      nativeShareBtn.style.display = 'block';
    }
  }
});
</script>

{% endblock %}