{% extends "base.html" %}

{% block content %}
<style>
  /* Fix untuk Safari Mac - pastikan background full screen */
  html, body {
    height: 100% !important;
    min-height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow-x: hidden !important;
  }
  
  body, .bg-dark-grad {
    background: linear-gradient(135deg, #181c2b 0%, #232946 100%) !important;
    min-height: 100vh !important;
    height: 100% !important;
    width: 100% !important;
    position: relative !important;
  }
  
  /* Safari Mac specific fixes */
  @supports (-webkit-appearance: none) {
    html, body {
      height: 100% !important;
      min-height: 100vh !important;
    }
    body {
      background-attachment: fixed !important;
      background-size: cover !important;
    }
  }
  
  /* Fix untuk mencegah scrollbar horizontal di Safari Mac */
  * {
    box-sizing: border-box !important;
  }
  
  html {
    overflow-x: hidden !important;
    width: 100% !important;
  }
  
  body {
    overflow-x: hidden !important;
    width: 100% !important;
    max-width: 100vw !important;
  }
  .glass-card {
    background: rgba(30,32,44,0.82);
    backdrop-filter: blur(12px);
    border-radius: 1.5rem;
    box-shadow: 0 8px 32px 0 #181c2b55;
    padding: 2.2rem 1.2rem 1.2rem 1.2rem;
    margin: 2.5rem auto 1.5rem auto;
    animation: fadeInUp 0.8s cubic-bezier(.39,.575,.565,1) both;
    max-width: 100%;
    width: 100%;
  }
  @keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(40px) scale(0.98); }
    100% { opacity: 1; transform: none; }
  }
  .search-bar-modern {
    background: #232946;
    border-radius: 2rem;
    box-shadow: 0 2px 12px 0 #23294633;
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.7rem;
    margin-bottom: 1.5rem;
    border: 1.5px solid #343a40;
    transition: box-shadow 0.2s, border-color 0.2s;
  }
  .search-bar-modern:focus-within {
    box-shadow: 0 0 0 2px #6c63ff44;
    border-color: #6c63ff;
  }
  .search-bar-modern input {
    background: transparent;
    border: none;
    color: #fff;
    flex: 1;
    font-size: 1.08rem;
    outline: none;
    padding: 0.4rem 0;
  }
  .search-bar-modern button {
    background: linear-gradient(90deg, #6c63ff 0%, #ff4ecd 100%);
    color: #fff;
    border: none;
    border-radius: 2rem;
    padding: 0.4rem 1.2rem;
    font-weight: 600;
    font-size: 1rem;
    transition: background 0.18s, transform 0.18s, box-shadow 0.18s;
    box-shadow: 0 2px 12px 0 #6c63ff22;
  }
  .search-bar-modern button:hover, .search-bar-modern button:focus {
    background: linear-gradient(90deg, #ff4ecd 0%, #6c63ff 100%);
    transform: scale(1.05);
    box-shadow: 0 4px 24px 0 #ff4ecd33;
  }
  .recent-title {
    color: #bcbcbc;
    font-size: 1.02rem;
    margin-bottom: 0.7rem;
    margin-left: 0.2rem;
    font-weight: 600;
    letter-spacing: 0.2px;
  }
  .search-result {
    background: rgba(35,41,70,0.92);
    border-radius: 1.2rem;
    box-shadow: 0 2px 12px 0 #23294633;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.7rem 1.1rem;
    margin-bottom: 0.7rem;
    transition: box-shadow 0.18s, transform 0.18s;
    position: relative;
    overflow: hidden;
  }
  .search-result:hover {
    box-shadow: 0 4px 24px 0 #6c63ff33;
    transform: scale(1.015);
    z-index: 2;
  }
  .search-result .left {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
  }
  .search-result img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #6c63ff;
    background: #232946;
    transition: box-shadow 0.18s, transform 0.18s;
  }
  .search-result .left:hover img {
    box-shadow: 0 4px 16px 0 #ff4ecd44;
    transform: scale(1.08) rotate(-2deg);
  }
  .btn-group {
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .btn-following, .btn-remove {
    border: none;
    outline: none;
    font-size: 0.93rem;
    border-radius: 2rem;
    padding: 0.3rem 1.1rem;
    font-weight: 600;
    transition: background 0.18s, color 0.18s, transform 0.18s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .btn-following {
    background: linear-gradient(90deg, #6c63ff 0%, #ff4ecd 100%);
    color: #fff;
  }
  .btn-following[aria-pressed="true"] {
    background: #444;
    color: #bcbcbc;
  }
  .btn-following:active::after, .btn-remove:active::after {
    content: '';
    position: absolute;
    left: 50%; top: 50%;
    width: 120%; height: 120%;
    background: rgba(255,255,255,0.08);
    border-radius: 50%;
    transform: translate(-50%,-50%) scale(1.1);
    animation: ripple 0.4s linear;
    z-index: 1;
  }
  .btn-following:hover, .btn-following:focus {
    background: linear-gradient(90deg, #ff4ecd 0%, #6c63ff 100%);
    color: #fff;
    transform: scale(1.07);
  }
  .btn-remove {
    background: transparent;
    color: #ff4ecd;
    font-size: 1.2rem;
    padding: 0.3rem 0.7rem;
  }
  .btn-remove:hover, .btn-remove:focus {
    background: #232946;
    color: #fff;
    transform: scale(1.15);
  }
  .gallery {
    margin-top: 2.2rem;
  }
  .gallery .row {
    --bs-gutter-x: 0.7rem;
    --bs-gutter-y: 0.7rem;
  }
  .gallery-item {
    position: relative;
    border-radius: 1.1rem;
    overflow: hidden;
    background: #232946;
    box-shadow: 0 2px 12px 0 #23294633;
    transition: box-shadow 0.18s, transform 0.18s;
    cursor: pointer;
  }
  .gallery-item:hover {
    box-shadow: 0 8px 32px 0 #ff4ecd44;
    transform: scale(1.03) rotate(-2deg);
    z-index: 2;
  }
  .gallery-item img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
    display: block;
    transition: transform 0.22s;
  }
  .gallery-item:hover img {
    transform: scale(1.08);
  }
  .caption-overlay {
    position: absolute;
    left: 0; right: 0; bottom: 0;
    width: 100%;
    color: #fff;
    background: linear-gradient(to top, rgba(30,32,44,0.92) 70%, transparent 100%);
    padding: 0.7rem 0.8rem 0.5rem 0.8rem;
    font-size: 0.97rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.22s;
    z-index: 2;
  }
  .gallery-item:hover .caption-overlay,
  .gallery-item:focus .caption-overlay {
    opacity: 1;
    pointer-events: auto;
  }
  .caption-overlay img {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    margin-right: 7px;
    object-fit: cover;
    border: 1.5px solid #6c63ff;
    background: #232946;
  }
  .no-content {
    text-align: center;
    color: #a5b4fc;
    font-size: 1.2rem;
    margin: 3rem 0;
    padding: 2rem;
    background: rgba(35,41,70,0.3);
    border-radius: 1rem;
    border: 1px solid #343a40;
  }
  .no-content h4 {
    color: #fff;
    margin-bottom: 0.5rem;
  }
  .no-content p {
    color: #bcbcbc;
    margin: 0;
  }
  
  /* Loading Spinner Styles */
  .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
  }
  
  .spinner-border.text-primary {
    color: #6c63ff !important;
  }
  /* Container full screen untuk Safari Mac */
  .bg-dark-grad {
    min-height: 100vh !important;
    height: 100% !important;
    width: 100% !important;
    position: relative !important;
  }
  
  /* Responsive untuk MacBook dan layar besar */
  @media (min-width: 1200px) {
    .glass-card {
      max-width: 95vw;
      margin: 1rem auto;
      padding: 2.5rem 2rem;
    }
    .gallery .row {
      --bs-gutter-x: 1rem;
      --bs-gutter-y: 1rem;
    }
  }
  
  @media (min-width: 1400px) {
    .glass-card {
      max-width: 90vw;
      padding: 3rem 2.5rem;
    }
  }
  
  /* Safari Mac specific fixes untuk background */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    body {
      background-attachment: fixed !important;
      background-repeat: no-repeat !important;
      background-position: center center !important;
      background-size: cover !important;
    }
  }
  
  @media (max-width: 576px) {
    .glass-card { padding: 1.2rem 0.3rem 1.2rem 0.3rem; }
    .gallery .row { --bs-gutter-x: 0.3rem; --bs-gutter-y: 0.3rem; }
    .search-bar-modern button {
      margin-left: -100px;
    }
  }
</style>
<div class="bg-dark-grad py-3">
  <div class="glass-card w-100">
    <!-- Search Bar -->
    <form class="search-bar-modern mb-3" autocomplete="off" method="get" action="/search">
      <i class="bi bi-search text-white"></i>
      <input type="text" name="q" placeholder="Cari pengguna atau feed..." class="text-white" value="{{ search_query|default('') }}"/>
      <button type="submit">Cari</button>
    </form>
    {% if found_users %}
    <div class="recent-title">Hasil</div>
    <!-- Hasil Pencarian -->
    <div x-data="{}">
      {% for user in found_users %}
      <div class="search-result mb-2" x-data="{ following: true }">
        <div class="left" @click="window.location.href='/user/{{ user.username }}'">
          <img src="{{ user.avatar_url or '/static/assets/image/default.jpg' }}" />
          {{ user.username }}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    <!-- Galeri Feed -->
    <div class="gallery mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-white mb-0">
          <i class="bi bi-images me-2"></i>
          Semua Foto
          <span class="badge bg-primary ms-2" id="total-count">Loading...</span>
        </h5>
        <small class="text-muted" id="load-status">
          Scroll ke bawah untuk memuat lebih banyak
        </small>
      </div>
      
      <div class="row g-2" id="gallery-container">
        {% if images %}
        {% for item in images %}
        <div class="col-6 col-md-4 col-lg-3" tabindex="0" onclick="window.location.href='/post_image/{{ item.id }}'">
          <div class="gallery-item">
            <img src="{{ item.image_url}}" alt="{{ item.caption or 'Image' }}" />
            <div class="caption-overlay d-flex align-items-center">
              <img src="{{ item.user.avatar_url or '/static/assets/image/default.jpg' }}" alt="{{ item.user.username }}" />
              <div>
                <strong>{{ item.user.username }}</strong><br/>
                <small>{{ item.caption[:30] + '...' if item.caption and item.caption|length > 30 else item.caption or '' }}</small>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12 text-center">
          <div class="no-content">
            <i class="bi bi-image" style="font-size: 3rem; color: #6c63ff; margin-bottom: 1rem;"></i>
            <h4>Belum ada foto</h4>
            <p>Jadilah yang pertama mengunggah foto!</p>
          </div>
        </div>
        {% endif %}
      </div>
      
      <!-- Loading Spinner -->
      <div id="loading-spinner" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">Memuat foto lebih banyak...</p>
      </div>
    </div>
    
  </div>
</div>

<script>
// Global variables for infinite scroll
let currentPage = 1;
let isLoading = false;
let hasMore = true;

document.addEventListener('DOMContentLoaded', function() {
  console.log('Search page loaded, initializing infinite scroll...');
  
  // Initialize infinite scroll
  initInfiniteScroll();
  
  // Load total count
  loadTotalCount();
});

// Initialize infinite scroll
function initInfiniteScroll() {
  console.log('Initializing infinite scroll...');
  
  // Add scroll event listener with throttling
  let scrollTimeout;
  window.addEventListener('scroll', function() {
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    
    scrollTimeout = setTimeout(function() {
      if (isLoading || !hasMore) {
        console.log('Skipping load - isLoading:', isLoading, 'hasMore:', hasMore);
        return;
      }
      
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      
      console.log('Scroll check - scrollTop:', scrollTop, 'windowHeight:', windowHeight, 'documentHeight:', documentHeight);
      
      // Load more when user is near bottom (200px threshold)
      if (scrollTop + windowHeight >= documentHeight - 200) {
        console.log('Near bottom detected, loading more items...');
        loadMoreItems();
      }
    }, 100); // Throttle to 100ms
  });
  
  console.log('Infinite scroll initialized successfully');
}

// Load more items for infinite scroll
async function loadMoreItems() {
  console.log('loadMoreItems called - currentPage:', currentPage, 'isLoading:', isLoading, 'hasMore:', hasMore);
  
  if (isLoading || !hasMore) {
    console.log('Skipping loadMoreItems - already loading or no more items');
    return;
  }
  
  isLoading = true;
  currentPage++;
  
  console.log('Loading page:', currentPage);
  
  const loadingSpinner = document.getElementById('loading-spinner');
  const loadStatus = document.getElementById('load-status');
  
  if (loadingSpinner) {
    loadingSpinner.style.display = 'block';
  }
  
  if (loadStatus) {
    loadStatus.textContent = 'Memuat foto lebih banyak...';
  }
  
  try {
    const url = `/api/search/infinite?page=${currentPage}&per_page=20`;
    console.log('Fetching from URL:', url);
    
    const response = await fetch(url);
    console.log('Response status:', response.status);
    
    const data = await response.json();
    console.log('Response data:', data);
    
    if (data.success && data.items.length > 0) {
      console.log('Appending', data.items.length, 'items to gallery');
      appendItemsToGallery(data.items);
      hasMore = data.has_more;
      
      if (loadStatus) {
        if (hasMore) {
          loadStatus.textContent = 'Scroll ke bawah untuk memuat lebih banyak';
        } else {
          loadStatus.textContent = 'Semua foto telah dimuat';
        }
      }
    } else {
      console.log('No more items or error in response');
      hasMore = false;
      if (loadStatus) {
        loadStatus.textContent = 'Semua foto telah dimuat';
      }
    }
  } catch (error) {
    console.error('Error loading more items:', error);
    hasMore = false;
    if (loadStatus) {
      loadStatus.textContent = 'Error memuat foto';
    }
  } finally {
    isLoading = false;
    
    if (loadingSpinner) {
      loadingSpinner.style.display = 'none';
    }
    
    console.log('loadMoreItems completed - hasMore:', hasMore);
  }
}

// Append new items to gallery
function appendItemsToGallery(items) {
  console.log('appendItemsToGallery called with', items.length, 'items');
  
  const container = document.getElementById('gallery-container');
  if (!container) {
    console.error('Gallery container not found!');
    return;
  }
  
  console.log('Container found, appending items...');
  
  items.forEach((item, index) => {
    console.log(`Creating item ${index + 1}:`, item);
    
    const colDiv = document.createElement('div');
    colDiv.className = 'col-6 col-md-4 col-lg-3';
    colDiv.setAttribute('tabindex', '0');
    colDiv.onclick = () => window.location.href = `/post_image/${item.id}`;
    
    colDiv.innerHTML = `
      <div class="gallery-item">
        <img src="${item.url}" alt="${item.title}" />
        <div class="caption-overlay d-flex align-items-center">
          <img src="${item.user.avatar_url}" alt="${item.user.username}" />
          <div>
            <strong>${item.user.username}</strong><br/>
            <small>${item.title.length > 30 ? item.title.substring(0, 30) + '...' : item.title}</small>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(colDiv);
  });
  
  console.log('All items appended successfully');
}

// Load total count
async function loadTotalCount() {
  console.log('Loading total count...');
  
  try {
    const response = await fetch('/api/search/infinite?page=1&per_page=1');
    console.log('Total count response status:', response.status);
    
    const data = await response.json();
    console.log('Total count data:', data);
    
    if (data.success) {
      const totalCount = document.getElementById('total-count');
      if (totalCount) {
        totalCount.textContent = `${data.total} foto`;
        console.log('Total count updated:', data.total);
      } else {
        console.error('Total count element not found!');
      }
    }
  } catch (error) {
    console.error('Error loading total count:', error);
  }
}
</script>

{% endblock %}