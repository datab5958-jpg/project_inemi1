{% extends 'base.html' %}
{% block head %}
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0E0B2C">
<meta name="msapplication-navbutton-color" content="#0E0B2C">
{% endblock %}
{% block content %}
<style>
    /* Font Import & Base */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        box-sizing: border-box;
    }
    
    /* Prevent horizontal scroll globally */
    html, body {
        overflow-x: hidden;
        max-width: 100vw;
        width: 100%;
    }

    /* HTML element background fix for Safari */
    html {
        background-color: #0E0B2C !important;
        background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
        min-height: 100vh !important;
        min-height: -webkit-fill-available !important; /* iOS Safari fix */
        /* Don't add padding to html - use body::after instead */
    }

    /* Color Variables */
    :root {
        --bg-dark: #0E0B2C;
        --bg-darker: #0E0B25;
        --bg-main: #14122E;
        --bg-card: #1D1B3F;
        --bg-bubble-user: #25234F;
        --bg-bubble-ai: #1D1B3F;
        --bg-sidebar: #0E0B25;
        --bg-input: #18163A;
        --bg-input-extra: #1E1C40;
        --bg-chip: #28264C;
        --bg-chip-active: #1D1B3A;
        --accent-neon: #4C7EFF;
        --accent-neon-glow: #5D5FEF;
        --text-primary: #FFFFFF;
        --text-secondary: #B8B8D9;
        --text-muted: #A0A0C4;
        --border-neon: rgba(76, 126, 255, 0.35);
        --shadow-glow: 0 0 20px rgba(76, 126, 255, 0.2);
        --shadow-glow-strong: 0 0 30px rgba(93, 95, 239, 0.3);
    }

    /* iOS/macOS Safari Fix - Background must have solid fallback */
    body {
        background-color: #0E0B2C !important; /* Solid fallback for Safari */
        background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
        background-attachment: fixed !important;
        background-repeat: no-repeat !important;
        background-size: 100% 100% !important;
        background-position: center top !important;
        color: var(--text-primary) !important;
        min-height: 100vh !important;
        min-height: -webkit-fill-available !important; /* iOS Safari viewport fix */
        margin: 0 !important;
        padding: 0 !important;
        position: relative !important;
        /* Don't add padding to body - use body::after overlay instead */
    }

    /* Safari-specific fixes */
    @supports (-webkit-appearance: none) {
        body {
            background-color: #0E0B2C !important;
            background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
            -webkit-background-size: 100% 100% !important;
        }
    }

    /* iOS Safari specific */
    @media screen and (-webkit-min-device-pixel-ratio: 0) {
        html, body {
            background-color: #0E0B2C !important;
            background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
            background-attachment: scroll !important;
            -webkit-background-attachment: scroll !important;
            /* Ensure background covers safe area */
            background-size: cover !important;
            background-position: center top !important;
        }
    }

    /* Override base.html body::before that covers background */
    body::before {
        display: none !important;
        content: none !important;
        background: none !important;
    }

    /* Force background on document root for iOS - must be at root level */
    html {
        background-color: #0E0B2C !important;
        background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
        background-size: cover !important;
        background-attachment: fixed !important;
        min-height: 100vh !important;
        min-height: -webkit-fill-available !important;
    }

    body {
        background-color: #0E0B2C !important;
        background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
        background-size: cover !important;
        background-attachment: fixed !important;
    }

    /* Ensure containers are transparent to show body background */
    .ai-container, .ai-main, .ai-chat-area {
        background-color: transparent !important;
    }

    /* Fix for iOS notch and status bar area - create overlay behind everything */
    body::after {
        content: '';
        position: fixed;
        top: -200px;
        left: -200px;
        right: -200px;
        bottom: -200px;
        width: calc(100vw + 400px);
        height: calc(100vh + 400px);
        background-color: #0E0B2C !important;
        background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
        background-size: cover !important;
        background-position: center top !important;
        background-attachment: scroll !important;
        z-index: -9999 !important;
        pointer-events: none;
    }

    /* Additional iOS Safari specific overlay */
    @supports (-webkit-touch-callout: none) {
        html::before {
            content: '';
            position: fixed;
            top: calc(-1 * env(safe-area-inset-top, 0px));
            left: calc(-1 * env(safe-area-inset-left, 0px));
            right: calc(-1 * env(safe-area-inset-right, 0px));
            bottom: calc(-1 * env(safe-area-inset-bottom, 0px));
            background-color: #0E0B2C !important;
            background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
            z-index: -10000;
            pointer-events: none;
        }
    }

    /* Main Container - Mobile First */
    .ai-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 12px;
        min-height: calc(100vh - 80px);
        position: relative;
        overflow-x: hidden;
        overflow-y: visible;
        visibility: visible !important;
        opacity: 1 !important;
        background: transparent !important; /* Ensure container is transparent to show body background */
    }
    
    /* Background Light Effects */
    .ai-container::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background:
            radial-gradient(1200px 800px at 10% 50%, rgba(76, 126, 255, 0.08), transparent 60%),
            radial-gradient(1000px 700px at 90% 80%, rgba(93, 95, 239, 0.06), transparent 55%);
        z-index: 0;
    }

    /* Sidebar - Top Navigation on Mobile */
    .ai-sidebar {
        display: flex;
        flex-direction: row;
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        background: var(--bg-sidebar);
        border-bottom: 1px solid var(--border-neon);
        padding: 10px 12px;
        gap: 8px;
        align-items: center;
        justify-content: space-around;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 20px rgba(76, 126, 255, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 12px;
        border-radius: 0 0 16px 16px;
    }
    
    .ai-sidebar-logo {
        display: none;
    }
    
    .ai-sidebar-item {
        flex: 1;
        min-width: 0;
        height: 44px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        color: var(--text-secondary);
        font-size: 18px;
        cursor: pointer;
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        max-width: 50px;
    }
    
    .ai-sidebar-item:hover {
        color: var(--text-primary);
        background: rgba(76, 126, 255, 0.1);
    }
    
    .ai-sidebar-item.active {
        color: var(--accent-neon);
        background: rgba(76, 126, 255, 0.15);
        border: 1px solid var(--accent-neon);
        box-shadow: 0 0 12px rgba(76, 126, 255, 0.3);
    }
    
    /* Settings dropdown on mobile - positioned below */
    .ai-sidebar-item.settings {
        position: relative;
    }
    
    .ai-settings-dropdown {
        position: fixed;
        top: auto;
        left: auto;
        right: auto;
        bottom: auto;
        width: calc(100% - 32px);
        max-width: 280px;
        background: var(--bg-card);
        border: 1px solid var(--border-neon);
        border-radius: 12px;
        padding: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(76, 126, 255, 0.2);
        opacity: 0;
        visibility: hidden;
        transform: translateX(-50%) translateY(-8px) scale(0.95);
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1001;
        backdrop-filter: blur(10px);
    }
    
    .ai-settings-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0) scale(1);
    }
    
    .ai-settings-dropdown::before {
        content: '';
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
        width: 12px;
        height: 12px;
        background: var(--bg-card);
        border-left: 1px solid var(--border-neon);
        border-top: 1px solid var(--border-neon);
    }
    
    .ai-settings-item {
        padding: 12px 14px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-primary);
        font-size: 14px;
        transition: all 150ms;
        position: relative;
        overflow: hidden;
    }
    
    .ai-settings-item::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, transparent, rgba(76, 126, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 300ms;
    }
    
    .ai-settings-item:hover::before {
        transform: translateX(100%);
    }
    
    .ai-settings-item:hover {
        background: rgba(76, 126, 255, 0.15);
        color: var(--accent-neon);
    }
    
    .ai-settings-item.success:hover {
        background: rgba(76, 255, 126, 0.15);
        color: #4CFF7E;
    }
    
    .ai-settings-item.danger:hover {
        background: rgba(255, 77, 77, 0.15);
        color: #FF4D4D;
    }
    
    /* Remove bottom padding for mobile */
    .ai-container {
        padding-bottom: 12px;
    }

    /* Main Chat Area */
    .ai-main {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        flex: 1;
        overflow: hidden;
        overflow-x: hidden;
    }

    .ai-chat-area {
        flex: 1;
        background: var(--bg-main) !important;
        border-radius: 16px;
        border: 1px solid rgba(76, 126, 255, 0.15);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        position: relative;
        width: 100%;
        max-width: 100%;
        min-height: 400px;
    }

    /* Empty State - Feature Cards */
    .ai-empty-hero {
        padding: 24px 16px 32px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        overflow: hidden;
        align-items: center;
        justify-content: flex-start;
        /* Subtle glow + center focus */
        background: radial-gradient(1200px 400px at 50% 0%, rgba(76,126,255,0.09), transparent 60%);
    }

    .ai-feature-cards {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        overflow-y: hidden;
        padding-bottom: 12px;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-neon) transparent;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        justify-content: flex-start;
    }
    
    .ai-feature-cards::after {
        content: '';
        flex-shrink: 0;
        width: 1px;
    }

    .ai-feature-cards::-webkit-scrollbar {
        height: 6px;
    }

    .ai-feature-cards::-webkit-scrollbar-thumb {
        background: var(--accent-neon);
        border-radius: 3px;
    }

    .ai-feature-card {
        min-width: 160px;
        max-width: 200px;
        width: 160px;
        flex-shrink: 0;
        background: linear-gradient(180deg, rgba(29,27,58,0.85) 0%, rgba(21,18,58,0.85) 100%);
        border: 1px solid rgba(76, 126, 255, 0.2);
        border-radius: 14px;
        padding: 14px 16px;
        cursor: pointer;
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--text-primary);
        box-shadow: 0 4px 20px rgba(46, 55, 166, 0.25);
        backdrop-filter: blur(6px);
    }

    .ai-feature-card:hover {
        transform: translateY(-2px) scale(1.02);
        border-color: var(--accent-neon);
        box-shadow: 0 16px 36px rgba(76, 126, 255, 0.35);
        background: linear-gradient(180deg, rgba(37,35,79,0.9) 0%, rgba(21,18,58,0.9) 100%);
    }

    /* Desktop: center the feature cards in the middle, keep sizes */
    @media (min-width: 1024px) {
        .ai-feature-cards {
            overflow-x: visible;
            justify-content: center;
            flex-wrap: wrap;
            gap: 14px;
        }
    }

    /* Mobile: keep card size comfortable and enable horizontal scroll */
    @media (max-width: 768px) {
        .ai-feature-cards {
            overflow-x: auto;
            gap: 12px;
            padding-left: 8px;
            padding-right: 8px;
            scroll-snap-type: x mandatory;
        }
        .ai-feature-card {
            width: 240px;
            min-width: 240px;
            max-width: 240px;
            scroll-snap-align: start;
        }
    }

    .ai-feature-card-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ai-feature-card-desc {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    /* Chat Stream */
    .ai-chat-stream {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        overflow-x: hidden;
        display: none;
        flex-direction: column;
        gap: 16px;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-neon) transparent;
        width: 100%;
        background: transparent !important; /* Ensure transparent to show body background */
    }

    /* Premium Custom Scrollbar */
    .ai-chat-stream::-webkit-scrollbar {
        width: 8px;
    }

    .ai-chat-stream::-webkit-scrollbar-track {
        background: rgba(76, 126, 255, 0.05);
        border-radius: 10px;
        margin: 8px 0;
    }

    .ai-chat-stream::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--accent-neon) 0%, rgba(93, 95, 239, 0.8) 100%);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
        transition: all 0.3s ease;
    }

    .ai-chat-stream::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, rgba(76, 126, 255, 0.9) 0%, rgba(93, 95, 239, 1) 100%);
        border: 1px solid rgba(76, 126, 255, 0.3);
    }


    .ai-chat-stream.active {
        display: flex;
    }

    /* Messages */
    .ai-message {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        animation: fadeSlideIn 250ms ease-out;
    }

    @keyframes fadeSlideIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-message.user {
        flex-direction: row-reverse;
    }

    .ai-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .ai-message.user .ai-message-avatar {
        background: var(--bg-bubble-user);
        color: var(--accent-neon);
        box-shadow: 0 0 12px rgba(76, 126, 255, 0.3);
    }

    .ai-message.assistant .ai-message-avatar {
        background: var(--bg-bubble-ai);
        color: var(--accent-neon);
        box-shadow: 0 0 12px rgba(76, 126, 255, 0.3);
    }

    .ai-message-bubble {
        max-width: 85%;
        min-width: 0;
        border-radius: 14px;
        padding: 12px 16px;
        position: relative;
        line-height: 1.5;
        font-size: 14px;
        color: var(--text-primary);
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow: visible; /* Allow actions to overflow */
    }

    .ai-message.user .ai-message-bubble {
        background: linear-gradient(135deg, rgba(37, 35, 79, 0.95) 0%, rgba(29, 27, 63, 0.95) 100%);
        border: 1px solid rgba(76, 126, 255, 0.25);
        backdrop-filter: blur(10px);
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.05),
            0 0 20px rgba(76, 126, 255, 0.1);
    }

    .ai-message.assistant .ai-message-bubble {
        background: linear-gradient(135deg, rgba(29, 27, 63, 0.95) 0%, rgba(21, 18, 58, 0.95) 100%);
        border: 1px solid rgba(76, 126, 255, 0.3);
        backdrop-filter: blur(10px);
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.05),
            0 0 25px rgba(76, 126, 255, 0.15);
    }

    .ai-message-meta {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ai-message-actions {
        position: absolute;
        top: 6px;
        right: 6px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 150ms;
        z-index: 10;
    }

    .ai-message-bubble:hover .ai-message-actions {
        opacity: 1;
    }

    .ai-message-actions button {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 12px;
        transition: all 150ms;
        flex-shrink: 0;
    }

    .ai-message-actions button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
    }

    /* Mobile: Force show actions and make them bigger */
    @media (max-width: 768px) {
        .ai-message-actions {
            opacity: 1 !important; /* Always visible on mobile */
            top: 8px;
            right: 8px;
            gap: 6px;
            /* Ensure buttons don't get cut off */
            flex-wrap: nowrap;
            z-index: 15 !important; /* Higher z-index for mobile */
        }

        .ai-message-bubble {
            /* Ensure bubble has enough padding for actions */
            padding-right: 50px !important;
            overflow: visible !important;
            position: relative;
        }

        /* Ensure result label doesn't overlap with actions */
        .ai-result-label {
            margin-top: 0 !important;
            padding-right: 50px !important; /* Space for action buttons */
            position: relative;
            z-index: 1;
            word-break: break-word; /* Prevent text overflow */
            max-width: 100%;
        }
        
        /* Ensure actions are positioned correctly relative to bubble */
        .ai-message.assistant .ai-message-bubble {
            padding-right: 50px !important;
        }

        .ai-message-actions button {
            width: 36px !important;
            height: 36px !important;
            min-width: 36px !important;
            min-height: 36px !important;
            font-size: 16px !important;
            background: rgba(76, 126, 255, 0.3) !important;
            border: 1px solid rgba(76, 126, 255, 0.5) !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4) !important;
            color: var(--accent-neon) !important;
            backdrop-filter: blur(10px) !important;
        }

        .ai-message-actions button:active {
            background: rgba(76, 126, 255, 0.5) !important;
            transform: scale(0.95);
        }

        /* Ensure message bubble doesn't clip actions */
        .ai-message .ai-message-bubble {
            position: relative;
            overflow: visible;
        }

        /* Ensure chat stream doesn't clip buttons */
        .ai-chat-stream {
            overflow-x: visible !important;
            padding-right: 8px !important; /* Extra padding for buttons */
        }

        /* Make sure message container doesn't clip */
        .ai-message {
            overflow: visible !important;
            position: relative;
        }
    }

    /* Media Results */
    .ai-result-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--accent-neon);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ai-media-grid {
        display: grid;
        gap: 12px;
        margin-top: 10px;
        grid-template-columns: 1fr;
        width: 100%;
        overflow: hidden;
    }

    /* Variations Grid - 3 Images (Desktop: Horizontal, Mobile: Vertical) */
    .ai-variations-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Desktop: 3 kolom horizontal */
        gap: 16px;
        margin: 16px 0;
        width: 100%;
    }

    /* Tablet - 2 columns */
    @media (max-width: 1024px) and (min-width: 769px) {
        .ai-variations-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }
    }

    /* Mobile - 1 column (vertical stack) */
    @media (max-width: 768px) {
        .ai-variations-grid {
            grid-template-columns: 1fr !important; /* Mobile: 1 kolom vertikal */
            gap: 20px;
            margin: 12px 0;
        }
    }

    .ai-image-variation {
        position: relative;
        border-radius: 14px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .ai-image-variation:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(76, 126, 255, 0.3);
        border-color: var(--accent-neon);
    }

    /* Disable hover effect on mobile */
    @media (max-width: 768px) {
        .ai-image-variation:hover {
            transform: none;
        }
    }

    .ai-image-variation img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 14px 14px 0 0;
        cursor: pointer;
        object-fit: cover;
        aspect-ratio: 1 / 1; /* Square images for consistency */
        background: rgba(0, 0, 0, 0.2);
    }

    /* Mobile: allow natural aspect ratio */
    @media (max-width: 768px) {
        .ai-image-variation img {
            aspect-ratio: auto;
            max-height: 400px;
            object-fit: contain;
        }
    }

    .ai-variation-number {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: var(--text-primary);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Download Button Overlay - Pojok Kanan Atas */
    .ai-variation-download {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(76, 126, 255, 0.25);
        border: 1px solid rgba(76, 126, 255, 0.5);
        color: var(--accent-neon);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 18px;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        text-decoration: none;
    }

    .ai-variation-download:hover {
        background: rgba(76, 126, 255, 0.4);
        border-color: var(--accent-neon);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(76, 126, 255, 0.5);
    }

    .ai-variation-download:active {
        transform: scale(0.95);
    }

    @media (max-width: 768px) {
        .ai-variation-number {
            top: 10px;
            left: 10px;
            padding: 6px 12px;
            font-size: 12px;
        }

        .ai-variation-download {
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
    }

    /* Simplified Actions - Analisa & Copy URL */
    .ai-variation-actions {
        display: flex;
        gap: 8px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        justify-content: center;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ai-variation-actions button {
        padding: 0;
        width: 44px;
        height: 44px;
        background: rgba(76, 126, 255, 0.2);
        border: 1px solid rgba(76, 126, 255, 0.4);
        border-radius: 10px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        display: grid;
        place-items: center;
        font-size: 18px;
        flex: 0 0 auto;
    }

    .ai-variation-actions button:first-child {
        background: rgba(147, 51, 234, 0.2);
        border-color: rgba(147, 51, 234, 0.4);
    }

    .ai-variation-actions button:first-child:hover {
        background: rgba(147, 51, 234, 0.3);
        border-color: rgba(147, 51, 234, 0.6);
    }

    .ai-variation-actions button:first-child i {
        color: #a78bfa;
    }

    .ai-variation-actions button:hover {
        background: rgba(76, 126, 255, 0.3);
        border-color: var(--accent-neon);
        transform: translateY(-2px);
    }

    .ai-variation-actions button:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .ai-variation-actions {
            padding: 10px;
        }

        .ai-variation-actions button {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
    }

    .ai-media-grid img,
    .ai-media-grid video {
        width: 100%;
        max-width: 100%;
        height: auto;
        border-radius: 14px;
        border: 2px solid rgba(76, 126, 255, 0.2);
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.4),
            0 0 20px rgba(76, 126, 255, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        object-fit: contain;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(0, 0, 0, 0.2);
    }

    .ai-media-grid img:hover,
    .ai-media-grid video:hover {
        transform: translateY(-4px) scale(1.02);
        border-color: rgba(76, 126, 255, 0.5);
        box-shadow: 
            0 16px 48px rgba(0, 0, 0, 0.5),
            0 0 30px rgba(76, 126, 255, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .ai-result-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .ai-result-actions a,
    .ai-result-actions button {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-neon);
        background: rgba(76, 126, 255, 0.1);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 150ms;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .ai-result-actions a:hover,
    .ai-result-actions button:hover {
        background: rgba(76, 126, 255, 0.2);
        border-color: var(--accent-neon);
        transform: translateY(-1px);
    }

    /* Music Card - Keren dan Rapi */
    .ai-music-card {
        background: var(--bg-card);
        border: 1px solid var(--border-neon);
        border-radius: 16px;
        overflow: hidden;
        margin-top: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 20px rgba(76, 126, 255, 0.1);
        transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
    }

    .ai-music-card:hover {
        border-color: var(--accent-neon);
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.4), 0 0 30px rgba(76, 126, 255, 0.15);
        transform: translateY(-2px);
    }

    .ai-music-cover {
        width: 100%;
        aspect-ratio: 1;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(76, 126, 255, 0.1) 0%, rgba(93, 95, 239, 0.1) 100%);
        position: relative;
    }

    .ai-music-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .ai-music-player-wrapper {
        padding: 16px;
        background: var(--bg-card);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ai-music-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .ai-music-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .ai-music-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 12px;
        color: var(--text-muted);
    }

    .ai-music-model {
        padding: 4px 10px;
        background: rgba(76, 126, 255, 0.15);
        border: 1px solid rgba(76, 126, 255, 0.3);
        border-radius: 12px;
        color: var(--accent-neon);
        font-weight: 500;
    }

    .ai-music-duration {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .ai-music-audio-player {
        width: 100%;
        margin-top: 4px;
    }

    .ai-music-audio-player audio {
        width: 100%;
        height: 40px;
        outline: none;
        border-radius: 8px;
    }

    .ai-music-audio-player audio::-webkit-media-controls-panel {
        background-color: var(--bg-input-extra);
        border-radius: 8px;
    }

    .ai-music-audio-player audio::-webkit-media-controls-play-button {
        background-color: var(--accent-neon);
        border-radius: 50%;
    }

    .ai-action-btn {
        padding: 8px 14px;
        font-size: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-neon);
        background: rgba(76, 126, 255, 0.1);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }

    .ai-action-btn:hover {
        background: rgba(76, 126, 255, 0.2);
        border-color: var(--accent-neon);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 126, 255, 0.2);
    }

    .ai-action-btn:active {
        transform: translateY(0);
    }

    /* Typing Indicator */
    .ai-typing {
        display: none;
        align-items: center;
        gap: 6px;
        padding: 0 16px 12px;
        color: var(--text-secondary);
    }

    .ai-typing.active {
        display: flex;
    }

    .ai-typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-neon);
        opacity: 0.4;
        animation: typingBlink 1.2s infinite;
    }

    .ai-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .ai-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingBlink {
        0%, 80%, 100% {
            opacity: 0.2;
        }
        40% {
            opacity: 1;
        }
    }

    /* Input Area - Bottom */
    .ai-input-area {
        background: var(--bg-input);
        border-radius: 14px;
        padding: 16px;
        margin-top: 16px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3), var(--shadow-glow);
        border: 1px solid rgba(76, 126, 255, 0.2);
        position: sticky;
        bottom: 12px;
        z-index: 10;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Mode Chips */
    .ai-mode-chips {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding-bottom: 4px;
    }
    
    .ai-mode-chips::-webkit-scrollbar {
        display: none;
    }

    .ai-mode-chip {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 200ms;
        border: 1px solid transparent;
        background: var(--bg-chip);
        color: var(--text-muted);
        white-space: nowrap;
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ai-mode-chip:hover {
        color: var(--text-primary);
        background: rgba(76, 126, 255, 0.1);
    }

    .ai-mode-chip.active {
        background: var(--bg-chip-active);
        color: var(--text-primary);
        border-color: var(--accent-neon);
        box-shadow: 0 0 8px rgba(76, 126, 255, 0.3);
        font-weight: 600;
    }

    /* Prompt Input */
    .ai-prompt-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-input-extra);
        border: 1px solid var(--border-neon);
        border-radius: 12px;
        padding: 10px 12px;
        transition: all 200ms;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        overflow: hidden;
    }

    .ai-prompt-wrapper:focus-within {
        border-color: var(--accent-neon);
        box-shadow: 0 0 16px rgba(76, 126, 255, 0.2);
    }

    /* Attachment Button */
    .ai-attach-btn {
        width: 36px;
        height: 36px;
        min-width: 36px;
        border-radius: 8px;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 18px;
        transition: all 150ms;
        flex-shrink: 0;
    }

    .ai-attach-btn:hover {
        color: var(--accent-neon);
        background: rgba(76, 126, 255, 0.1);
    }

    .ai-attach-btn:active {
        transform: scale(0.95);
    }

    /* Attachment Preview */
    .ai-attachment-preview {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(76, 126, 255, 0.15);
        animation: slideDown 200ms ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-attachment-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        padding: 8px;
    }

    @media (max-width: 768px) {
        .ai-attachment-list {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
    }

    .ai-attachment-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: var(--bg-input-extra);
        border: 2px solid var(--border-neon);
        transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .ai-attachment-item:hover {
        border-color: var(--accent-neon);
        box-shadow: 0 8px 20px rgba(76, 126, 255, 0.3);
        transform: translateY(-4px) scale(1.05);
    }

    .ai-attachment-item.uploading {
        opacity: 0.6;
        pointer-events: none;
    }

    .ai-attachment-item.uploading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-neon), rgba(76, 126, 255, 0.5));
        animation: upload-progress 2s linear infinite;
    }

    @keyframes upload-progress {
        0% {
            transform: translateX(-100%);
        }
        100% {
            transform: translateX(100%);
        }
    }

    .ai-attachment-item img,
    .ai-attachment-item video {
        display: block;
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-radius: 10px 10px 0 0;
        transition: transform 300ms ease;
    }

    .ai-attachment-item:hover img,
    .ai-attachment-item:hover video {
        transform: scale(1.1);
    }

    .ai-attachment-item video {
        background: #000;
        width: 100%;
        height: 140px;
    }

    .ai-attachment-remove {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.75);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 14px;
        transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(8px);
        opacity: 0;
        transform: scale(0.8);
    }

    .ai-attachment-item:hover .ai-attachment-remove {
        opacity: 1;
        transform: scale(1);
    }

    .ai-attachment-remove:hover {
        background: rgba(255, 77, 77, 0.95);
        border-color: rgba(255, 255, 255, 0.4);
        transform: scale(1.15) rotate(90deg);
        box-shadow: 0 4px 12px rgba(255, 77, 77, 0.4);
    }

    .ai-attachment-info {
        padding: 8px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(76, 126, 255, 0.1);
    }

    /* Upload Progress Indicator */
    .ai-upload-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: rgba(76, 126, 255, 0.2);
        overflow: hidden;
    }

    .ai-upload-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-neon), rgba(93, 95, 239, 0.8));
        width: 0%;
        transition: width 0.3s ease;
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }
        100% {
            background-position: 1000px 0;
        }
    }

    /* File Count Badge */
    .ai-drop-zone-file-count {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--accent-neon);
        color: #fff;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        opacity: 0;
        transform: scale(0.8);
        transition: all 300ms ease;
        pointer-events: none;
    }

    .ai-drop-zone.dragover .ai-drop-zone-file-count {
        opacity: 1;
        transform: scale(1);
    }

    /* Drag & Drop Zone */
    .ai-drop-zone {
        margin-bottom: 12px;
        padding: 32px 24px;
        border: 2px dashed rgba(76, 126, 255, 0.3);
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(76, 126, 255, 0.05) 0%, rgba(93, 95, 239, 0.03) 100%);
        cursor: pointer;
        transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .ai-drop-zone::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(76, 126, 255, 0.1), transparent);
        transition: left 0.5s;
    }

    .ai-drop-zone:hover::before {
        left: 100%;
    }

    .ai-drop-zone:hover {
        border-color: rgba(76, 126, 255, 0.6);
        background: linear-gradient(135deg, rgba(76, 126, 255, 0.1) 0%, rgba(93, 95, 239, 0.08) 100%);
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(76, 126, 255, 0.15);
    }

    .ai-drop-zone.dragover {
        border-color: var(--accent-neon);
        background: linear-gradient(135deg, rgba(76, 126, 255, 0.2) 0%, rgba(93, 95, 239, 0.15) 100%);
        border-style: solid;
        box-shadow: 0 0 40px rgba(76, 126, 255, 0.4), inset 0 0 60px rgba(76, 126, 255, 0.1);
        transform: scale(1.03);
        animation: glow-pulse 2s ease-in-out infinite;
    }

    @keyframes glow-pulse {
        0%, 100% {
            box-shadow: 0 0 40px rgba(76, 126, 255, 0.4), inset 0 0 60px rgba(76, 126, 255, 0.1);
        }
        50% {
            box-shadow: 0 0 60px rgba(76, 126, 255, 0.6), inset 0 0 80px rgba(76, 126, 255, 0.15);
        }
    }

    .ai-drop-zone.has-attachments {
        display: none;
    }

    .ai-drop-zone.uploading {
        pointer-events: none;
        opacity: 0.7;
    }

    .ai-drop-zone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
    }

    .ai-drop-zone-icon {
        font-size: 56px;
        color: var(--accent-neon);
        margin-bottom: 12px;
        transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        filter: drop-shadow(0 4px 8px rgba(76, 126, 255, 0.3));
    }

    .ai-drop-zone:hover .ai-drop-zone-icon {
        transform: translateY(-6px) scale(1.15) rotate(5deg);
        filter: drop-shadow(0 8px 16px rgba(76, 126, 255, 0.4));
    }

    .ai-drop-zone.dragover .ai-drop-zone-icon {
        transform: scale(1.3) rotate(-5deg);
        animation: float-bounce 1.5s ease-in-out infinite;
        filter: drop-shadow(0 8px 20px rgba(76, 126, 255, 0.6));
    }

    @keyframes float-bounce {
        0%, 100% {
            transform: translateY(0) scale(1.3) rotate(-5deg);
        }
        50% {
            transform: translateY(-10px) scale(1.35) rotate(5deg);
        }
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }

    .ai-drop-zone-text {
        display: flex;
        flex-direction: column;
        gap: 4px;
        color: var(--text-primary);
    }

    .ai-drop-zone-text strong {
        font-size: 16px;
        color: var(--accent-neon);
        font-weight: 600;
    }

    .ai-drop-zone-text span {
        font-size: 13px;
        color: var(--text-muted);
    }

    .ai-drop-zone-hint {
        margin-top: 4px;
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
        opacity: 0.8;
    }

    .ai-drop-zone-hint i {
        font-size: 14px;
        color: var(--accent-neon);
    }

    /* Premium Lightbox Modal */
    .ai-lightbox {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 10000;
        background: rgba(0, 0, 0, 0.92);
        backdrop-filter: blur(20px);
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    }

    .ai-lightbox.active {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .ai-lightbox-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ai-lightbox-content img,
    .ai-lightbox-content video {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 16px;
        box-shadow: 
            0 25px 50px -12px rgba(0, 0, 0, 0.8),
            0 0 60px rgba(76, 126, 255, 0.3);
        border: 2px solid rgba(76, 126, 255, 0.3);
        animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .ai-lightbox-close {
        position: absolute;
        top: -50px;
        right: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 20px;
        transition: all 0.3s ease;
    }

    .ai-lightbox-close:hover {
        background: rgba(255, 77, 77, 0.9);
        border-color: rgba(255, 77, 77, 1);
        transform: rotate(90deg) scale(1.1);
    }

    /* AI Recommendations Modal */
    .ai-recommendations-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 10001;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(20px);
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
    }

    .ai-recommendations-modal.active {
        display: flex;
    }

    .ai-recommendations-content {
        background: linear-gradient(135deg, rgba(29, 27, 63, 0.98) 0%, rgba(21, 18, 58, 0.98) 100%);
        border: 2px solid rgba(76, 126, 255, 0.3);
        border-radius: 20px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 
            0 25px 50px -12px rgba(0, 0, 0, 0.8),
            0 0 40px rgba(76, 126, 255, 0.3);
        backdrop-filter: blur(20px);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-recommendations-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid rgba(76, 126, 255, 0.2);
    }

    .ai-recommendations-header h3 {
        margin: 0;
        color: var(--accent-neon);
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ai-recommendations-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: all 0.2s ease;
        font-size: 16px;
    }

    .ai-recommendations-close:hover {
        background: rgba(255, 77, 77, 0.2);
        border-color: rgba(255, 77, 77, 0.5);
        transform: rotate(90deg);
    }

    .ai-recommendations-body {
        padding: 20px 24px;
    }

    .ai-recommendations-image-preview {
        margin-bottom: 20px;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
    }

    .ai-recommendations-image-preview img {
        width: 100%;
        height: auto;
        max-height: 300px;
        object-fit: contain;
        display: block;
    }

    .ai-recommendations-analysis {
        margin-bottom: 20px;
        padding: 16px;
        background: rgba(76, 126, 255, 0.08);
        border: 1px solid rgba(76, 126, 255, 0.2);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 13px;
        line-height: 1.6;
    }

    .ai-recommendations-loading {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ai-skeleton {
        height: 12px;
        background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
        background-size: 200% 100%;
        border-radius: 6px;
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .ai-recommendations-models {
        margin-bottom: 20px;
    }

    .ai-recommendations-models-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--accent-neon);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-model-recommendations {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .ai-model-chip {
        padding: 10px 16px;
        background: rgba(76, 126, 255, 0.15);
        border: 1px solid rgba(76, 126, 255, 0.3);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-model-chip.recommended {
        background: rgba(76, 126, 255, 0.25);
        border-color: var(--accent-neon);
        box-shadow: 0 0 15px rgba(76, 126, 255, 0.3);
    }

    .ai-model-chip:hover {
        background: rgba(76, 126, 255, 0.3);
        border-color: var(--accent-neon);
        transform: translateY(-2px);
    }

    .ai-model-chip i {
        color: var(--accent-neon);
        font-size: 14px;
    }

    .ai-recommendations-suggestions {
        margin-bottom: 20px;
    }

    .ai-recommendations-suggestions-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--accent-neon);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-suggestion-item {
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin-bottom: 8px;
        color: var(--text-primary);
        font-size: 13px;
        line-height: 1.5;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .ai-suggestion-item i {
        color: var(--accent-neon);
        font-size: 14px;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .ai-recommendations-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .ai-recommendations-actions-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--accent-neon);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-quick-action-btn {
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(76, 126, 255, 0.2) 0%, rgba(93, 95, 239, 0.2) 100%);
        border: 1px solid rgba(76, 126, 255, 0.4);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .ai-quick-action-btn:hover {
        background: linear-gradient(135deg, rgba(76, 126, 255, 0.3) 0%, rgba(93, 95, 239, 0.3) 100%);
        border-color: var(--accent-neon);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 126, 255, 0.3);
    }

    .ai-quick-action-btn .action-info {
        flex: 1;
    }

    .ai-quick-action-btn .action-label {
        font-weight: 600;
        color: var(--accent-neon);
        margin-bottom: 4px;
    }

    .ai-quick-action-btn .action-prompt {
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0.8;
    }

    .ai-quick-action-btn .action-icon {
        font-size: 18px;
        color: var(--accent-neon);
    }

    @media (max-width: 768px) {
        .ai-recommendations-content {
            max-width: 95vw;
            margin: 10px;
            max-height: 95vh;
        }

        .ai-recommendations-header,
        .ai-recommendations-body {
            padding: 16px;
        }

        .ai-model-chip,
        .ai-quick-action-btn {
            font-size: 12px;
            padding: 10px 14px;
        }
    }

    /* Premium Loading Skeleton */
    .ai-skeleton {
        background: linear-gradient(
            90deg,
            rgba(76, 126, 255, 0.1) 0%,
            rgba(76, 126, 255, 0.2) 50%,
            rgba(76, 126, 255, 0.1) 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 12px;
    }

    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }
        100% {
            background-position: 200% 0;
        }
    }

    .ai-skeleton-image {
        width: 100%;
        height: 200px;
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .ai-skeleton-text {
        height: 16px;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .ai-skeleton-text:last-child {
        width: 60%;
    }

    /* Premium Toast Notification */
    .ai-toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    }

    .ai-toast {
        pointer-events: auto;
        min-width: 320px;
        max-width: 400px;
        padding: 16px 20px;
        border-radius: 14px;
        background: linear-gradient(135deg, rgba(29, 27, 63, 0.95) 0%, rgba(21, 18, 58, 0.95) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(76, 126, 255, 0.3);
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.5),
            0 0 20px rgba(76, 126, 255, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .ai-toast::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--accent-neon);
    }

    .ai-toast.success::before {
        background: linear-gradient(180deg, #4CFF7E 0%, #22C55E 100%);
    }

    .ai-toast.error::before {
        background: linear-gradient(180deg, #FF4D4D 0%, #EF4444 100%);
    }

    .ai-toast.warning::before {
        background: linear-gradient(180deg, #FBBF24 0%, #F59E0B 100%);
    }

    @keyframes slideInRight {
        from {
            transform: translateX(120%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(120%);
            opacity: 0;
        }
    }

    .ai-toast-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        font-size: 20px;
        flex-shrink: 0;
        background: rgba(76, 126, 255, 0.15);
        border: 1px solid rgba(76, 126, 255, 0.3);
    }

    .ai-toast.success .ai-toast-icon {
        background: rgba(76, 255, 126, 0.15);
        border-color: rgba(76, 255, 126, 0.3);
        color: #4CFF7E;
    }

    .ai-toast.error .ai-toast-icon {
        background: rgba(255, 77, 77, 0.15);
        border-color: rgba(255, 77, 77, 0.3);
        color: #FF4D4D;
    }

    .ai-toast.warning .ai-toast-icon {
        background: rgba(251, 191, 36, 0.15);
        border-color: rgba(251, 191, 36, 0.3);
        color: #FBBF24;
    }

    .ai-toast-content {
        flex: 1;
        min-width: 0;
    }

    .ai-toast-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .ai-toast-message {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    .ai-toast-close {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: none;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .ai-toast-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        transform: rotate(90deg);
    }

    @media (max-width: 768px) {
        .ai-toast {
            min-width: 280px;
            max-width: calc(100vw - 40px);
        }
    }

    .ai-prompt-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-size: 14px;
        line-height: 1.5;
        resize: none;
        min-height: 22px;
        max-height: 120px;
        font-family: inherit;
        min-width: 0;
        max-width: 100%;
        width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow-x: hidden;
        overflow-y: auto;
    }

    .ai-prompt-input::placeholder {
        color: var(--text-muted);
        font-style: italic;
    }

    .ai-send-btn {
        width: 40px;
        height: 40px;
        min-width: 40px;
        border-radius: 10px;
        background: var(--accent-neon-glow);
        color: var(--text-primary);
        border: none;
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 16px;
        transition: all 200ms;
        box-shadow: 0 0 12px rgba(93, 95, 239, 0.3);
        flex-shrink: 0;
    }

    .ai-send-btn:hover {
        transform: scale(1.08);
        box-shadow: 0 0 20px rgba(93, 95, 239, 0.4);
    }

    .ai-send-btn:active {
        transform: scale(0.98);
    }

    .ai-send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Small static hint under input */
    .ai-drop-hint {
        margin-top: 6px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, rgba(76,126,255,0.15), rgba(93,95,239,0.12));
        border: 1px solid rgba(76,126,255,0.35);
        color: var(--text-primary);
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        width: max-content;
        transition: all .2s ease;
        cursor: pointer;
        user-select: none;
    }
    .ai-drop-hint i { color: var(--accent-neon); font-size: 14px; }
    .ai-drop-hint:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(76,126,255,0.2);
        border-color: var(--accent-neon);
        background: linear-gradient(135deg, rgba(76,126,255,0.22), rgba(93,95,239,0.18));
    }
    .ai-drop-hint .kbd {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 6px;
        padding: 2px 6px;
        font-size: 11px;
        color: var(--text-secondary);
    }

    /* Smart Prompt Quality Indicator */
    .ai-prompt-quality {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: rgba(76, 126, 255, 0.08);
        border: 1px solid rgba(76, 126, 255, 0.2);
        border-radius: 10px;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .ai-prompt-quality.hidden {
        display: none;
    }

    .ai-prompt-quality-score {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .ai-prompt-quality-bar {
        width: 60px;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }

    .ai-prompt-quality-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease, background 0.3s ease;
    }

    .ai-prompt-quality-fill.low {
        background: linear-gradient(90deg, #ff6b6b, #ff8787);
    }

    .ai-prompt-quality-fill.medium {
        background: linear-gradient(90deg, #fbbf24, #fcd34d);
    }

    .ai-prompt-quality-fill.high {
        background: linear-gradient(90deg, #4CFF7E, #22C55E);
    }

    .ai-prompt-quality-text {
        color: var(--text-secondary);
        font-size: 11px;
    }

    .ai-prompt-enhance-btn {
        margin-left: auto;
        padding: 4px 10px;
        background: rgba(76, 126, 255, 0.2);
        border: 1px solid rgba(76, 126, 255, 0.4);
        border-radius: 6px;
        color: var(--accent-neon);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .ai-prompt-enhance-btn:hover {
        background: rgba(76, 126, 255, 0.3);
        border-color: var(--accent-neon);
        transform: translateY(-1px);
    }

    .ai-prompt-enhance-btn.loading {
        opacity: 0.6;
        cursor: wait;
    }

    /* Contextual Suggestions */
    .ai-contextual-suggestions {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        animation: fadeIn 0.3s ease;
    }

    .ai-suggestion-chip {
        padding: 6px 12px;
        background: rgba(76, 126, 255, 0.1);
        border: 1px solid rgba(76, 126, 255, 0.3);
        border-radius: 20px;
        color: var(--text-primary);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .ai-suggestion-chip:hover {
        background: rgba(76, 126, 255, 0.2);
        border-color: var(--accent-neon);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 126, 255, 0.2);
    }

    .ai-suggestion-chip i {
        font-size: 10px;
        color: var(--accent-neon);
    }

    /* Error Predictions */
    .ai-error-predictions {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        animation: fadeIn 0.3s ease;
    }

    .ai-error-predictions.hidden {
        display: none;
    }

    .ai-error-item {
        padding: 10px 12px;
        background: rgba(255, 77, 77, 0.1);
        border: 1px solid rgba(255, 77, 77, 0.3);
        border-left: 3px solid #FF4D4D;
        border-radius: 8px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-size: 12px;
    }

    .ai-error-item.severity-medium {
        background: rgba(251, 191, 36, 0.1);
        border-color: rgba(251, 191, 36, 0.3);
        border-left-color: #FBBF24;
    }

    .ai-error-item.severity-low {
        background: rgba(76, 126, 255, 0.1);
        border-color: rgba(76, 126, 255, 0.3);
        border-left-color: var(--accent-neon);
    }

    .ai-error-icon {
        font-size: 16px;
        color: #FF4D4D;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .ai-error-item.severity-medium .ai-error-icon {
        color: #FBBF24;
    }

    .ai-error-item.severity-low .ai-error-icon {
        color: var(--accent-neon);
    }

    .ai-error-content {
        flex: 1;
    }

    .ai-error-message {
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 4px;
    }

    .ai-error-suggestion {
        color: var(--text-secondary);
        font-size: 11px;
        line-height: 1.4;
    }

    .ai-error-action {
        margin-top: 6px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .ai-error-action-btn {
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .ai-error-action-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--accent-neon);
    }

    /* Compact inline drop zone inside input bar */
    #promptWrapper {
        position: relative;
    }
    .ai-inline-drop-zone {
        position: absolute;
        inset: 0;
        border: 2px dashed var(--accent-neon);
        border-radius: 14px;
        background: rgba(76, 126, 255, 0.08);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10;
        pointer-events: none;
    }
    .ai-inline-drop-zone.active { display: flex; }
    .ai-inline-drop-zone .ai-drag-overlay-text { padding: 10px; font-size: 14px; }

    /* Hide the large drop zone to save space */
    #dropZone { display: none; }

    /* Drag & Drop Overlay */
    .ai-drag-overlay {
        position: absolute;
        inset: 0;
        background: rgba(76, 126, 255, 0.1);
        border: 2px dashed var(--accent-neon);
        border-radius: 14px;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        pointer-events: none;
        backdrop-filter: blur(4px);
    }

    .ai-drag-overlay.active {
        display: flex;
    }

    .ai-drag-overlay-text {
        color: var(--accent-neon);
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        padding: 20px;
    }
    
    /* Mode Dropdown */
    .ai-mode-dropdown {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
        padding-top: 12px;
        border-top: 1px dashed rgba(76, 126, 255, 0.3);
        width: 100%;
        max-width: 100%;
    }
    
    .ai-mode-select {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg-input-extra);
        border: 1px solid var(--border-neon);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
        outline: none;
        transition: all 150ms;
        min-height: 40px;
    }
    
    .ai-mode-select:focus {
        border-color: var(--accent-neon);
        box-shadow: 0 0 8px rgba(76, 126, 255, 0.2);
    }

    .ai-auto-detect-btn {
        width: 100%;
        padding: 10px 14px;
        background: transparent;
        border: 1px solid var(--accent-neon);
        border-radius: 10px;
        color: var(--accent-neon);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 150ms;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-height: 40px;
    }

    .ai-auto-detect-btn:hover {
        background: rgba(76, 126, 255, 0.1);
        box-shadow: 0 0 8px rgba(76, 126, 255, 0.2);
    }

    .ai-auto-detect-btn.active {
        background: rgba(76, 126, 255, 0.15);
        box-shadow: 0 0 12px rgba(76, 126, 255, 0.3);
    }

    /* Tablet Styles */
    @media (min-width: 768px) {
        .ai-container {
            padding: 16px;
            max-width: 1200px;
        }
        
        .ai-empty-hero {
            padding: 32px 20px 40px;
        }
        
        .ai-feature-card {
            min-width: 180px;
            max-width: 220px;
            width: 180px;
            padding: 16px 18px;
        }
        
        .ai-feature-card-title {
            font-size: 15px;
        }
        
        .ai-feature-card-desc {
            font-size: 13px;
        }
        
        .ai-chat-stream {
            padding: 20px;
        }
        
        .ai-message-bubble {
            max-width: 75%;
            font-size: 15px;
            padding: 14px 18px;
        }
        
        .ai-message-avatar {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }
        
        .ai-input-area {
            padding: 20px;
        }
        
        .ai-mode-chips {
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .ai-mode-chip {
            padding: 8px 14px;
            font-size: 13px;
        }
        
        .ai-prompt-wrapper {
            padding: 12px 14px;
            gap: 12px;
        }
        
        .ai-prompt-input {
            font-size: 15px;
        }
        
        .ai-send-btn {
            width: 44px;
            height: 44px;
            font-size: 18px;
        }
        
        .ai-extra-inputs {
            flex-direction: row;
            align-items: stretch;
        }
        
        .ai-extra-inputs input {
            flex: 1;
        }
        
        .ai-generate-btn {
            width: auto;
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .ai-media-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    /* Desktop Styles */
    @media (min-width: 1024px) {
        .ai-container {
            flex-direction: row;
            gap: 20px;
            padding: 20px;
            padding-bottom: 20px;
            max-width: 1400px;
        }
        
        .ai-sidebar {
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 20px;
            height: fit-content;
            width: 80px;
            flex-shrink: 0;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-neon);
            border-radius: 18px;
            padding: 16px 0 20px;
            align-items: center;
            gap: 36px;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            bottom: auto;
            left: auto;
            right: auto;
            overflow: visible;
        }
        
        .ai-sidebar-logo {
            display: block;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            padding: 4px 8px;
            line-height: 1.4;
            letter-spacing: 0.5px;
        }
        
        .ai-sidebar-item {
            width: 44px;
            height: 44px;
            max-width: 44px;
            flex: none;
            border-radius: 12px;
            display: grid;
            place-items: center;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .ai-sidebar-item:hover {
            color: var(--text-primary);
            background: rgba(76, 126, 255, 0.1);
        }
        
        .ai-sidebar-item.active {
            color: var(--accent-neon);
            background: rgba(76, 126, 255, 0.15);
            border: 1px solid var(--accent-neon);
            box-shadow: 0 0 12px rgba(76, 126, 255, 0.3);
        }
        
        .ai-sidebar-item[title]::after {
            content: attr(title);
            position: absolute;
            left: calc(100% + 12px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 150ms;
            border: 1px solid var(--border-neon);
            box-shadow: var(--shadow-glow);
        }
        
        .ai-sidebar-item:hover[title]::after {
            opacity: 1;
        }

        /* Settings Dropdown - Desktop (muncul di atas settings button) */
        .ai-sidebar-item.settings {
            position: relative;
        }

        .ai-settings-dropdown {
            position: absolute;
            /* bottom: calc(100% + 12px); */
            left: calc(100% + 12px);
            transform: translateY(-8px) scale(0.95);
            background: var(--bg-card);
            border: 1px solid var(--border-neon);
            border-radius: 14px;
            padding: 6px;
            min-width: 220px;
            width: auto;
            max-width: none;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(76, 126, 255, 0.2),
                0 0 30px rgba(76, 126, 255, 0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 99999;
            backdrop-filter: blur(12px);
            overflow: hidden;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .ai-settings-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .ai-settings-dropdown::before {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 20px;
            transform: rotate(45deg);
            width: 12px;
            height: 12px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-neon);
            border-bottom: 1px solid var(--border-neon);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .ai-settings-dropdown::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(76, 126, 255, 0.05) 0%, rgba(93, 95, 239, 0.03) 100%);
            pointer-events: none;
            border-radius: 14px;
        }

        .ai-settings-item {
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .ai-settings-item:last-child {
            margin-bottom: 0;
        }

        .ai-settings-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(76, 126, 255, 0.12), transparent);
            transform: translateX(-100%);
            transition: transform 400ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ai-settings-item:hover::before {
            transform: translateX(100%);
        }

        .ai-settings-item:hover {
            background: rgba(76, 126, 255, 0.12);
            color: var(--accent-neon);
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(76, 126, 255, 0.15);
        }

        .ai-settings-item:active {
            transform: translateX(3px) scale(0.98);
        }

        .ai-settings-item i {
            font-size: 17px;
            width: 22px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 200ms;
        }

        .ai-settings-item:hover i {
            transform: scale(1.1);
        }

        .ai-settings-item span {
            flex: 1;
            white-space: nowrap;
        }

        .ai-settings-item.danger {
            color: #ff6b6b;
        }

        .ai-settings-item.danger:hover {
            background: rgba(255, 107, 107, 0.12);
            color: #ff6b6b;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.15);
        }

        .ai-settings-item.danger i {
            color: #ff6b6b;
        }

        .ai-settings-item.success {
            color: #6bcf7f;
        }

        .ai-settings-item.success:hover {
            background: rgba(107, 207, 127, 0.12);
            color: #6bcf7f;
            box-shadow: 0 2px 8px rgba(107, 207, 127, 0.15);
        }

        .ai-settings-item.success i {
            color: #6bcf7f;
        }
        
        .ai-main {
            flex: 1;
            min-width: 0;
        }
        
        .ai-feature-card {
            min-width: 200px;
            max-width: 240px;
            width: 200px;
            padding: 18px 20px;
        }
        
        .ai-message-bubble {
            max-width: 75%;
        }
        
        .ai-input-area {
            padding: 20px 24px 24px;
            margin-top: 20px;
        }
        
        .ai-mode-dropdown {
            flex-direction: row;
        }
        
        .ai-mode-select {
            flex: 1;
        }
        
        .ai-auto-detect-btn {
            width: auto;
            min-width: 120px;
        }
    }
</style>

<div class="ai-container">
    <!-- Sidebar Left - Desktop Only -->
    <div class="ai-sidebar">
        <div class="ai-sidebar-logo">AI<br>Generate</div>
        <div class="ai-sidebar-item active" title="Chat" data-mode="">
            <i class="bi bi-chat-dots"></i>
        </div>
        <div class="ai-sidebar-item" title="Gambar" data-mode="image_generate">
            <i class="bi bi-image"></i>
        </div>
        <div class="ai-sidebar-item" title="Video" data-mode="video_generate">
            <i class="bi bi-camera-reels"></i>
        </div>
        <div class="ai-sidebar-item" title="Musik" data-mode="music_generate">
            <i class="bi bi-music-note-beamed"></i>
        </div>
        <div class="ai-sidebar-item" title="Video Face Swap" data-mode="video_face_swap">
            <i class="bi bi-person-badge"></i>
        </div>
        <div class="ai-sidebar-item settings" title="Pengaturan" id="settingsBtn">
            <i class="bi bi-gear"></i>
            <div class="ai-settings-dropdown" id="settingsDropdown">
                <div class="ai-settings-item success" id="downloadHistoryBtn">
                    <i class="bi bi-download"></i>
                    <span>Download Riwayat Chat</span>
                </div>
                <div class="ai-settings-item danger" id="clearHistoryBtn">
                    <i class="bi bi-trash"></i>
                    <span>Hapus Riwayat Chat</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="ai-main">
        <div class="ai-chat-area">
            <!-- Empty State - Feature Cards -->
            <div class="ai-empty-hero" id="emptyHero">
                <div class="ai-feature-cards" id="featureCards">
                    <div class="ai-feature-card" data-text="Buat gambar naga biru terbang di atas kota cyberpunk, gaya 3D realistis, pencahayaan neon.">
                        <div class="ai-feature-card-title">
                            <span></span> Gambar Sinematik
                        </div>
                        <div class="ai-feature-card-desc">3D, neon, cyberpunk</div>
                    </div>
                    <div class="ai-feature-card" data-text="Edit gambar ini menjadi versi anime dengan rambut berwarna perak dan pakaian futuristik.">
                        <div class="ai-feature-card-title">
                            <span></span> Edit jadi Anime
                        </div>
                        <div class="ai-feature-card-desc">Perubahan gaya</div>
                    </div>
                    <div class="ai-feature-card" data-text="Ubah gambar ini jadi video loop 6 detik yang halus, nuansa elegan.">
                        <div class="ai-feature-card-title">
                            <span></span> Gambar ke Video
                        </div>
                        <div class="ai-feature-card-desc">Loop 6 detik</div>
                    </div>
                    <div class="ai-feature-card" data-text="Buat video pendek pemandangan hutan berkabut saat matahari terbit, gaya dokumenter sinematik.">
                        <div class="ai-feature-card-title">
                            <span></span> Video Sinematik
                        </div>
                        <div class="ai-feature-card-desc">Vibe natural</div>
                    </div>
                    <div class="ai-feature-card" data-text="Buat musik lo-fi santai dengan sentuhan jazz, tempo 85 BPM, suasana malam kota.">
                        <div class="ai-feature-card-title">
                            <span></span> Musik Lo-Fi
                        </div>
                        <div class="ai-feature-card-desc">85 BPM, jazzy</div>
                    </div>
                </div>
            </div>

            <!-- Chat Stream -->
            <div class="ai-chat-stream" id="chatStream"></div>

            <!-- Typing Indicator -->
            <div class="ai-typing" id="typing">
                <span class="ai-typing-dot"></span>
                <span class="ai-typing-dot"></span>
                <span class="ai-typing-dot"></span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="ai-input-area" id="inputArea">
            <!-- Attachment Preview Area -->
            <div class="ai-attachment-preview" id="attachmentPreview" style="display: none;">
                <div class="ai-attachment-list" id="attachmentList"></div>
            </div>

            <!-- Drag & Drop Zone -->
            <div class="ai-drop-zone" id="dropZone">
                <div class="ai-drop-zone-file-count" id="fileCountBadge"></div>
                <div class="ai-drop-zone-content">
                    <div class="ai-drop-zone-icon">
                        <i class="bi bi-cloud-upload"></i>
                    </div>
                    <div class="ai-drop-zone-text">
                        <strong>Seret gambar ke sini</strong>
                        <span>atau klik untuk memilih</span>
                    </div>
                    <div class="ai-drop-zone-hint">
                        <i class="bi bi-images"></i> Bisa upload banyak gambar sekaligus
                    </div>
                </div>
            </div>

            <!-- Mode Chips -->
            <div class="ai-mode-chips">
                <div class="ai-mode-chip active" data-mode="">Auto</div>
                <div class="ai-mode-chip" data-mode="image_generate">Gambar</div>
                <div class="ai-mode-chip" data-mode="image_edit">Edit</div>
                <div class="ai-mode-chip" data-mode="image_to_video" title="Gambar ke Video">GV</div>
                <div class="ai-mode-chip" data-mode="video_generate">Video</div>
                <div class="ai-mode-chip" data-mode="music_generate">Musik</div>
                <div class="ai-mode-chip" data-mode="video_face_swap" title="Video Face Swap">Video Face Swap</div>
            </div>

            <!-- Prompt Input - ChatGPT Style -->
            <div class="ai-prompt-wrapper" id="promptWrapper">
                <button type="button" id="attachBtn" class="ai-attach-btn" title="Lampirkan file">
                    <i class="bi bi-paperclip"></i>
                </button>
                <textarea id="aiPrompt" class="ai-prompt-input" rows="1" placeholder="Ketik ide atau perintah AI di sini"></textarea>
                <button type="button" id="runBtn" class="ai-send-btn" title="Kirim">
                    <i class="bi bi-send"></i>
                </button>
            </div>
            
            <!-- Smart Prompt Quality Indicator -->
            <div class="ai-prompt-quality hidden" id="promptQuality">
                <div class="ai-prompt-quality-score">
                    <span class="ai-prompt-quality-text">Kualitas:</span>
                    <div class="ai-prompt-quality-bar">
                        <div class="ai-prompt-quality-fill" id="qualityFill" style="width: 0%"></div>
                    </div>
                    <span class="ai-prompt-quality-text" id="qualityScore">0</span>
                </div>
                <button type="button" class="ai-prompt-enhance-btn" id="enhanceBtn" title="Enhance prompt dengan AI">
                    <i class="bi bi-magic"></i> <span>Enhance</span>
                </button>
            </div>
            
            <!-- Error Prediction Warnings -->
            <div class="ai-error-predictions hidden" id="errorPredictions"></div>
            
            <!-- Contextual Suggestions -->
            <div class="ai-contextual-suggestions" id="contextualSuggestions"></div>
            
            <div class="ai-drop-hint" id="dropHint" title="Seret gambar ke kotak input, atau klik untuk memilih">
                <i class="bi bi-cloud-upload"></i>
                <span>Drag & drop gambar</span>
                <span class="kbd">atau klik</span>
            </div>

            <!-- Hidden File Input -->
            <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display: none;" />

            <!-- Mode Selector Dropdown (Hidden by default) -->
            <div class="ai-mode-dropdown" id="modeDropdown" style="display: none;">
                <select id="mode" class="ai-mode-select">
                    <option value="">Auto Detect</option>
                    <option value="image_generate">Generate Image</option>
                    <option value="image_edit">Edit Image</option>
                    <option value="image_to_video">Gambar ke Video</option>
                    <option value="video_generate">Generate Video</option>
                    <option value="music_generate">Generate Music</option>
                    <option value="video_face_swap">Video Face Swap</option>
                </select>
                <button type="button" id="autoDetectBtn" class="ai-auto-detect-btn" title="Auto Detect Mode">
                    <i class="bi bi-sliders"></i> Auto Detect
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Premium Lightbox Modal -->
<div class="ai-lightbox" id="lightbox">
    <div class="ai-lightbox-content">
        <button class="ai-lightbox-close" id="lightboxClose">
            <i class="bi bi-x-lg"></i>
        </button>
        <img id="lightboxImage" src="" alt="Preview">
    </div>
</div>

<!-- AI Recommendations Modal -->
<div class="ai-recommendations-modal" id="recommendationsModal">
    <div class="ai-recommendations-content">
        <div class="ai-recommendations-header">
            <h3><i class="bi bi-magic"></i> Rekomendasi AI</h3>
            <button class="ai-recommendations-close" id="recommendationsClose">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="ai-recommendations-body">
            <div class="ai-recommendations-image-preview">
                <img id="recommendationsImage" src="" alt="Preview">
            </div>
            <div class="ai-recommendations-analysis" id="recommendationsAnalysis">
                <div class="ai-recommendations-loading">
                    <div class="ai-skeleton"></div>
                    <div class="ai-skeleton"></div>
                    <div class="ai-skeleton"></div>
                </div>
            </div>
            <div class="ai-recommendations-models" id="recommendationsModels"></div>
            <div class="ai-recommendations-suggestions" id="recommendationsSuggestions"></div>
            <div class="ai-recommendations-actions" id="recommendationsActions"></div>
        </div>
    </div>
</div>

<!-- Premium Toast Container -->
<div class="ai-toast-container" id="toastContainer"></div>

<script>
// Error handling and Android compatibility
(function() {
    'use strict';
    
    // iOS Safari Background Fix - Apply immediately
    function fixIOSBackground() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                     (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        
        if (isIOS) {
            // Force set background on html and body
            document.documentElement.style.backgroundColor = '#0E0B2C';
            document.documentElement.style.backgroundImage = 'linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%)';
            document.body.style.backgroundColor = '#0E0B2C';
            document.body.style.backgroundImage = 'linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%)';
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center top';
            
            // Create overlay for safe area - covers entire screen including status bar
            let overlay = document.getElementById('ios-background-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'ios-background-overlay';
                const safeTop = getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top') || '0px';
                overlay.style.cssText = `
                    position: fixed;
                    top: -100px;
                    left: -100px;
                    right: -100px;
                    bottom: -100px;
                    width: calc(100vw + 200px);
                    height: calc(100vh + 200px);
                    background-color: #0E0B2C !important;
                    background-image: linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%) !important;
                    background-size: cover !important;
                    background-position: center top !important;
                    background-attachment: scroll !important;
                    z-index: -99999;
                    pointer-events: none;
                `;
                document.body.appendChild(overlay);
            } else {
                // Update existing overlay
                overlay.style.backgroundColor = '#0E0B2C';
                overlay.style.backgroundImage = 'linear-gradient(180deg, #0E0B2C 0%, #1B1F46 50%, #0E0B2C 100%)';
            }
            
            // Hide base.html body::before
            const bodyBefore = window.getComputedStyle(document.body, '::before');
            if (bodyBefore) {
                const style = document.createElement('style');
                style.textContent = 'body::before { display: none !important; content: none !important; }';
                document.head.appendChild(style);
            }
        }
    }
    
    // Apply immediately
    fixIOSBackground();
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    function init() {
        try {
            // Re-apply iOS fix after DOM ready
            fixIOSBackground();
            
            // Ensure container is visible
            const container = document.querySelector('.ai-container');
            if (container) {
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                container.style.display = 'flex';
            }
            
            // Initialize all components
            initializeComponents();
        } catch (e) {
            console.error('AI Generate initialization error:', e);
            // Show error message to user
            const container = document.querySelector('.ai-container');
            if (container) {
                container.innerHTML = '<div style="padding: 20px; color: #fff; text-align: center;">Error loading AI Generate. Please refresh the page.</div>';
            }
        }
    }
    
    function initializeComponents() {
        // Constants with null checks
        const stream = document.getElementById('chatStream');
        const runBtn = document.getElementById('runBtn');
        const emptyHero = document.getElementById('emptyHero');
        const typing = document.getElementById('typing');
        const promptInput = document.getElementById('aiPrompt');
        const modeSelect = document.getElementById('mode');
        const autoDetectBtn = document.getElementById('autoDetectBtn');
        const attachBtn = document.getElementById('attachBtn');
        const fileInput = document.getElementById('fileInput');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const attachmentList = document.getElementById('attachmentList');
        const inputArea = document.getElementById('inputArea');
        const dropZone = document.getElementById('dropZone');
        const promptWrapperEl = document.getElementById('promptWrapper');
        const dropHint = document.getElementById('dropHint');
        const promptQuality = document.getElementById('promptQuality');
        const qualityFill = document.getElementById('qualityFill');
        const qualityScoreText = document.getElementById('qualityScore');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const contextualSuggestions = document.getElementById('contextualSuggestions');
        const errorPredictions = document.getElementById('errorPredictions');
        
        // Create compact inline drop zone inside input bar
        let inlineDropZone = document.getElementById('inlineDropZone');
        if (!inlineDropZone && promptWrapperEl) {
            inlineDropZone = document.createElement('div');
            inlineDropZone.id = 'inlineDropZone';
            inlineDropZone.className = 'ai-inline-drop-zone';
            inlineDropZone.innerHTML = '<div class="ai-drag-overlay-text">Lepaskan gambar di sini</div>';
            promptWrapperEl.appendChild(inlineDropZone);
        }
        const fileCountBadge = document.getElementById('fileCountBadge');
        
        // Store attachments
        let attachments = [];
        let uploadingFiles = new Set();
        
        if (!stream || !runBtn || !promptInput) {
            console.error('Required elements not found');
            return;
        }

        
        // Mode Chips
        const modeChips = document.querySelectorAll('.ai-mode-chip');
        modeChips.forEach(chip => {
            chip.addEventListener('click', () => {
                modeChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                if (modeSelect) {
                    modeSelect.value = chip.dataset.mode || '';
                }
            });
        });
        
        // Mode select change handler
        if (modeSelect) {
            modeSelect.addEventListener('change', () => {
                // Update active chip
                modeChips.forEach(c => {
                    c.classList.toggle('active', c.dataset.mode === modeSelect.value);
                });
            });
        }

        // Sidebar Items
        const sidebarItems = document.querySelectorAll('.ai-sidebar-item');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const downloadHistoryBtn = document.getElementById('downloadHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        
        sidebarItems.forEach(item => {
            item.addEventListener('click', (e) => {
                // Don't toggle mode if clicking settings
                if (item === settingsBtn) {
                    e.stopPropagation();
                    // Toggle settings dropdown
                    if (settingsDropdown) {
                        const isShowing = settingsDropdown.classList.contains('show');
                        if (isShowing) {
                            settingsDropdown.classList.remove('show');
                        } else {
                            // Calculate position dynamically
                            const rect = settingsBtn.getBoundingClientRect();
                            const isDesktop = window.innerWidth >= 1024;
                            
                            if (isDesktop) {
                                // Desktop: reset any inline styles and use CSS positioning
                                settingsDropdown.style.position = '';
                                settingsDropdown.style.left = '';
                                settingsDropdown.style.top = '';
                                settingsDropdown.style.bottom = '';
                                settingsDropdown.style.right = '';
                                settingsDropdown.style.transform = '';
                                // Just show it - CSS will handle positioning
                                settingsDropdown.classList.add('show');
                            } else {
                                // Mobile: position below settings button in top nav
                                // Calculate position relative to settings button
                                const dropdownHeight = 100; // Approximate height
                                settingsDropdown.style.position = 'fixed';
                                settingsDropdown.style.left = `${rect.left + rect.width / 2}px`;
                                settingsDropdown.style.top = `${rect.bottom + 8}px`;
                                settingsDropdown.style.bottom = 'auto';
                                settingsDropdown.style.right = 'auto';
                                settingsDropdown.style.transform = 'translateX(-50%) translateY(-8px) scale(0.95)';
                                
                                settingsDropdown.classList.add('show');
                                
                                // Update transform when showing
                                setTimeout(() => {
                                    settingsDropdown.style.transform = 'translateX(-50%) translateY(0) scale(1)';
                                }, 10);
                            }
                        }
                    }
                    return;
                }
                
                // Close settings dropdown if open
                if (settingsDropdown) {
                    settingsDropdown.classList.remove('show');
                }
                
                if (item.dataset.mode !== undefined) {
                    sidebarItems.forEach(s => s.classList.remove('active'));
                    item.classList.add('active');
                    if (modeSelect) {
                        modeSelect.value = item.dataset.mode || '';
                    }
                    modeChips.forEach(c => {
                        c.classList.toggle('active', c.dataset.mode === item.dataset.mode);
                    });
                }
            });
        });
        
        // Update dropdown position on window resize (mobile only)
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (settingsDropdown && settingsDropdown.classList.contains('show') && settingsBtn) {
                    const isDesktop = window.innerWidth >= 1024;
                    
                    if (!isDesktop) {
                        // Mobile: recalculate position
                        const rect = settingsBtn.getBoundingClientRect();
                        settingsDropdown.style.left = `${rect.left + rect.width / 2}px`;
                        settingsDropdown.style.top = `${rect.bottom + 8}px`;
                        settingsDropdown.style.transform = 'translateX(-50%) translateY(0) scale(1)';
                    } else {
                        // Desktop: reset all inline styles to use CSS
                        settingsDropdown.style.position = '';
                        settingsDropdown.style.left = '';
                        settingsDropdown.style.top = '';
                        settingsDropdown.style.bottom = '';
                        settingsDropdown.style.right = '';
                        settingsDropdown.style.transform = '';
                    }
                }
            }, 100);
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (settingsDropdown && settingsBtn && !settingsBtn.contains(e.target) && !settingsDropdown.contains(e.target)) {
                settingsDropdown.classList.remove('show');
            }
        });
        
        // Download History
        if (downloadHistoryBtn) {
            downloadHistoryBtn.addEventListener('click', () => {
                try {
                    const HISTORY_KEY = 'ai_generate_history_v2';
                    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                    
                    if (history.length === 0) {
                        alert('Riwayat chat kosong. Tidak ada yang bisa diunduh.');
                        if (settingsDropdown) settingsDropdown.classList.remove('show');
                        return;
                    }
                    
                    // Create download data with metadata
                    const downloadData = {
                        export_date: new Date().toISOString(),
                        version: '1.0',
                        total_messages: history.length,
                        history: history
                    };
                    
                    // Create blob and download
                    const blob = new Blob([JSON.stringify(downloadData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ai_generate_history_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Show success feedback
                    downloadHistoryBtn.innerHTML = '<i class="bi bi-check-circle"></i><span>Berhasil!</span>';
                    setTimeout(() => {
                        downloadHistoryBtn.innerHTML = '<i class="bi bi-download"></i><span>Download Riwayat Chat</span>';
                    }, 2000);
                    
                    if (settingsDropdown) settingsDropdown.classList.remove('show');
                } catch (error) {
                    console.error('Download history error:', error);
                    alert('Gagal mengunduh riwayat chat. ' + error.message);
                }
            });
        }
        
        // Clear History
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', () => {
                if (!confirm('Yakin ingin menghapus semua riwayat chat? Tindakan ini tidak dapat dibatalkan.')) {
                    if (settingsDropdown) settingsDropdown.classList.remove('show');
                    return;
                }
                
                try {
                    const HISTORY_KEY = 'ai_generate_history_v2';
                    localStorage.removeItem(HISTORY_KEY);
                    
                    // Clear chat stream
                    if (stream) {
                        stream.innerHTML = '';
                    }
                    
                    // Show empty state
                    if (emptyHero) {
                        emptyHero.style.display = 'flex';
                    }
                    if (stream) {
                        stream.classList.remove('active');
                    }
                    
                    // Show success feedback
                    clearHistoryBtn.innerHTML = '<i class="bi bi-check-circle"></i><span>Berhasil!</span>';
                    setTimeout(() => {
                        clearHistoryBtn.innerHTML = '<i class="bi bi-trash"></i><span>Hapus Riwayat Chat</span>';
                    }, 2000);
                    
                    if (settingsDropdown) settingsDropdown.classList.remove('show');
                } catch (error) {
                    console.error('Clear history error:', error);
                    alert('Gagal menghapus riwayat chat. ' + error.message);
                }
            });
        }

        // Feature Cards
        document.querySelectorAll('.ai-feature-card').forEach(card => {
            card.addEventListener('click', () => {
                if (promptInput) {
                    promptInput.value = card.dataset.text || '';
                    promptInput.focus();
                    autoResizeTextarea();
                }
            });
        });

        // Auto Resize Textarea
        function autoResizeTextarea() {
            if (!promptInput) return;
            promptInput.style.height = 'auto';
            promptInput.style.height = Math.min(promptInput.scrollHeight, 120) + 'px';
        }
        if (promptInput) {
            promptInput.addEventListener('input', autoResizeTextarea);
        }

        // Smart Prompt Quality Analysis
        let qualityCheckTimeout;
        async function analyzePromptQuality() {
            if (!promptInput || !promptQuality) return;
            
            const prompt = promptInput.value.trim();
            
            // Hide if prompt is empty
            if (!prompt || prompt.length < 3) {
                promptQuality.classList.add('hidden');
                return;
            }
            
            // Show quality indicator
            promptQuality.classList.remove('hidden');
            
            // Simple quality calculation (fast, no API call)
            const wordCount = prompt.split(/\s+/).filter(w => w.length > 0).length;
            let score = 30;
            
            if (wordCount >= 5) score += 20;
            if (wordCount >= 10) score += 20;
            if (wordCount >= 20) score += 20;
            if (wordCount > 50) score -= 10; // Too long
            
            // Check for detail keywords
            const detailKeywords = ['detail', 'sharp', 'style', 'gaya', 'lighting', 'pencahayaan', 'quality', 'kualitas'];
            const hasDetails = detailKeywords.some(kw => prompt.toLowerCase().includes(kw));
            if (hasDetails) score += 10;
            
            score = Math.min(score, 100);
            
            // Update UI
            if (qualityFill) {
                qualityFill.style.width = score + '%';
                qualityFill.className = 'ai-prompt-quality-fill ' + 
                    (score < 50 ? 'low' : score < 75 ? 'medium' : 'high');
            }
            if (qualityScoreText) {
                qualityScoreText.textContent = score;
            }
        }

        // Debounced quality check
        if (promptInput) {
            promptInput.addEventListener('input', () => {
                clearTimeout(qualityCheckTimeout);
                qualityCheckTimeout = setTimeout(analyzePromptQuality, 500);
            });
            
            // Initial check
            setTimeout(analyzePromptQuality, 1000);
        }

        // Error Prediction
        let errorCheckTimeout;
        
        async function checkPromptErrors() {
            if (!promptInput || !errorPredictions) return;
            
            const prompt = promptInput.value.trim();
            if (!prompt || prompt.length < 3) {
                errorPredictions.classList.add('hidden');
                errorPredictions.innerHTML = '';
                return;
            }
            
            try {
                const mode = modeSelect ? modeSelect.value : '';
                const hasImage = attachments.length > 0 && attachments.some(a => a.type === 'image');
                
                const res = await fetch('/api/ai_generate/predict-errors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        prompt: prompt,
                        mode: mode,
                        has_image: hasImage
                    })
                });
                
                const data = await res.json();
                
                if (data.success && data.errors && data.errors.length > 0) {
                    errorPredictions.classList.remove('hidden');
                    errorPredictions.innerHTML = '';
                    
                    data.errors.forEach(error => {
                        const errorItem = document.createElement('div');
                        errorItem.className = `ai-error-item severity-${error.severity || 'medium'}`;
                        errorItem.innerHTML = `
                            <i class="bi bi-exclamation-triangle ai-error-icon"></i>
                            <div class="ai-error-content">
                                <div class="ai-error-message">${error.message}</div>
                                <div class="ai-error-suggestion"> ${error.suggestion}</div>
                                ${error.auto_fixable ? `
                                    <div class="ai-error-action">
                                        ${error.suggested_mode ? `
                                            <button class="ai-error-action-btn" onclick="
                                                const modeSelect = document.getElementById('mode');
                                                if (modeSelect) modeSelect.value = '${error.suggested_mode}';
                                                const modeChips = document.querySelectorAll('.ai-mode-chip');
                                                modeChips.forEach(c => c.classList.toggle('active', c.dataset.mode === '${error.suggested_mode}'));
                                            ">Ubah Mode</button>
                                        ` : ''}
                                        <button class="ai-error-action-btn" onclick="
                                            const enhanceBtn = document.getElementById('enhanceBtn');
                                            if (enhanceBtn) enhanceBtn.click();
                                        ">Enhance Prompt</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        errorPredictions.appendChild(errorItem);
                    });
                } else {
                    errorPredictions.classList.add('hidden');
                    errorPredictions.innerHTML = '';
                }
            } catch (error) {
                console.error('Error prediction check failed:', error);
            }
        }

        // Debounced error check
        if (promptInput && modeSelect) {
            const triggerErrorCheck = () => {
                clearTimeout(errorCheckTimeout);
                errorCheckTimeout = setTimeout(checkPromptErrors, 800);
            };
            
            promptInput.addEventListener('input', triggerErrorCheck);
            if (modeSelect) {
                modeSelect.addEventListener('change', triggerErrorCheck);
            }
        }

        // Enhance Prompt Button
        if (enhanceBtn && promptInput) {
            enhanceBtn.addEventListener('click', async () => {
                const prompt = promptInput.value.trim();
                if (!prompt) return;
                
                enhanceBtn.classList.add('loading');
                enhanceBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Enhancing...</span>';
                
                try {
                    const mode = modeSelect ? modeSelect.value : '';
                    const hasImage = attachments.length > 0 && attachments.some(a => a.type === 'image');
                    
                    const res = await fetch('/api/ai_generate/enhance-prompt', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            prompt: prompt,
                            mode: mode,
                            has_image: hasImage
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (data.success && data.enhanced) {
                        promptInput.value = data.enhanced;
                        autoResizeTextarea();
                        analyzePromptQuality();
                        
                        // Show toast
                        if (window.showToast) {
                            window.showToast('Prompt berhasil di-enhance!', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Enhance error:', error);
                    if (window.showToast) {
                        window.showToast('Gagal enhance prompt', 'error');
                    }
                } finally {
                    enhanceBtn.classList.remove('loading');
                    enhanceBtn.innerHTML = '<i class="bi bi-magic"></i> <span>Enhance</span>';
                }
            });
        }

        // Load Contextual Suggestions
        async function loadContextualSuggestions() {
            if (!contextualSuggestions) return;
            
            try {
                const mode = modeSelect ? modeSelect.value : '';
                const prompt = promptInput ? promptInput.value.trim().toLowerCase() : '';
                
                const res = await fetch('/api/ai_generate/contextual-suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        attachments: attachments,
                        mode: mode,
                        prompt: prompt
                    })
                });
                
                const data = await res.json();
                
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    contextualSuggestions.innerHTML = '';
                    data.suggestions.forEach(suggestion => {
                        const chip = document.createElement('div');
                        chip.className = 'ai-suggestion-chip';
                        chip.innerHTML = `<i class="bi bi-lightbulb"></i> <span>${suggestion.text}</span>`;
                        
                        chip.addEventListener('click', () => {
                            if (suggestion.action === 'suggest' && suggestion.prompt) {
                                if (promptInput) {
                                    promptInput.value = suggestion.prompt;
                                    promptInput.focus();
                                    autoResizeTextarea();
                                    analyzePromptQuality();
                                }
                            } else if (suggestion.action === 'set_mode' && suggestion.mode) {
                                if (modeSelect) {
                                    modeSelect.value = suggestion.mode;
                                    modeChips.forEach(c => {
                                        c.classList.toggle('active', c.dataset.mode === suggestion.mode);
                                    });
                                }
                            } else if (suggestion.action === 'enhance' && suggestion.keyword) {
                                if (promptInput) {
                                    const current = promptInput.value.trim();
                                    promptInput.value = current ? `${current}, ${suggestion.keyword}` : suggestion.keyword;
                                    promptInput.focus();
                                    autoResizeTextarea();
                                    analyzePromptQuality();
                                }
                            }
                        });
                        
                        contextualSuggestions.appendChild(chip);
                    });
                } else {
                    contextualSuggestions.innerHTML = '';
                }
            } catch (error) {
                console.error('Load suggestions error:', error);
            }
        }

        // Load suggestions on attachment change or mode change
        if (modeSelect) {
            modeSelect.addEventListener('change', () => {
                setTimeout(loadContextualSuggestions, 300);
            });
        }

        // Hook into updateAttachmentPreview to reload suggestions
        const originalUpdateAttachmentPreviewFunc = updateAttachmentPreview;
        if (typeof updateAttachmentPreview === 'function') {
            updateAttachmentPreview = function() {
                originalUpdateAttachmentPreviewFunc();
                setTimeout(loadContextualSuggestions, 300);
                setTimeout(checkPromptErrors, 500);
            };
        }

        // Initial load
        setTimeout(loadContextualSuggestions, 1000);

        // Enter to Send
        if (promptInput && runBtn) {
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Trigger click which will handle the submission
                    runBtn.click();
                }
            });
        }

        // Attachment Functions
        function addAttachment(fileData) {
            attachments.push(fileData);
            updateAttachmentPreview();
        }

        function removeAttachment(index) {
            attachments.splice(index, 1);
            updateAttachmentPreview();
        }

        function updateAttachmentPreview() {
            if (!attachmentList || !attachmentPreview) return;
            
            attachmentList.innerHTML = '';
            
            if (attachments.length === 0) {
                attachmentPreview.style.display = 'none';
                // Show drop zone when no attachments
                if (dropZone) {
                    dropZone.classList.remove('has-attachments');
                }
                if (dropHint) dropHint.style.display = 'inline-flex';
                return;
            }
            
            attachmentPreview.style.display = 'block';
            // Hide drop zone when has attachments
            if (dropZone) {
                dropZone.classList.add('has-attachments');
            }
            if (dropHint) dropHint.style.display = 'none';
            
            // Auto-detect Video Face Swap: check if has both image and video
            const hasImage = attachments.some(a => a.type === 'image');
            const hasVideo = attachments.some(a => a.type === 'video');
            
            if (hasImage && hasVideo && modeSelect) {
                // Auto-set mode to video_face_swap if mode is auto/empty
                const currentMode = modeSelect.value;
                if (currentMode === '' || currentMode === 'auto') {
                    modeSelect.value = 'video_face_swap';
                    // Update active chip
                    const modeChips = document.querySelectorAll('.ai-mode-chip');
                    modeChips.forEach(c => {
                        c.classList.toggle('active', c.dataset.mode === 'video_face_swap');
                    });
                    
                    // Show hint toast
                    if (window.showToast) {
                        setTimeout(() => {
                            window.showToast('Mode otomatis: Video Face Swap terdeteksi!', 'info', 'Auto-detect');
                        }, 500);
                    }
                }
            }
            
            attachments.forEach((att, index) => {
                const item = document.createElement('div');
                item.className = 'ai-attachment-item';
                
                if (att.type === 'image') {
                    item.innerHTML = `
                        <img src="${att.url}" alt="${att.filename}" />
                        <button class="ai-attachment-remove" onclick="window.removeAttachment(${index})" title="Hapus">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="ai-attachment-info">${att.filename}</div>
                    `;
                } else if (att.type === 'video') {
                    item.innerHTML = `
                        <video src="${att.url}" muted></video>
                        <button class="ai-attachment-remove" onclick="window.removeAttachment(${index})" title="Hapus">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="ai-attachment-info">${att.filename}</div>
                    `;
                }
                
                attachmentList.appendChild(item);
            });
            
            // Animate items in
            setTimeout(() => {
                attachmentList.querySelectorAll('.ai-attachment-item').forEach((item, idx) => {
                    item.style.animationDelay = `${idx * 0.05}s`;
                });
            }, 10);
        }

        // Expose removeAttachment globally
        window.removeAttachment = function(index) {
            removeAttachment(index);
        };

        // Helper function to create preview item for uploading file
        function createUploadPreview(file, previewUrl) {
            const item = document.createElement('div');
            item.className = 'ai-attachment-item uploading';
            item.dataset.fileName = file.name;
            
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            
            if (isImage && previewUrl) {
                item.innerHTML = `
                    <img src="${previewUrl}" alt="${file.name}" />
                    <div class="ai-upload-progress">
                        <div class="ai-upload-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="ai-attachment-info">${file.name}</div>
                `;
            } else if (isVideo) {
                item.innerHTML = `
                    <video src="${previewUrl || ''}" muted></video>
                    <div class="ai-upload-progress">
                        <div class="ai-upload-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="ai-attachment-info">${file.name}</div>
                `;
            }
            
            attachmentList.appendChild(item);
            attachmentPreview.style.display = 'block';
            if (dropZone) dropZone.classList.add('has-attachments');
            
            return item;
        }

        // Helper function to upload files
        async function uploadFiles(files) {
            if (!files || files.length === 0) return;
            
            const errors = [];
            const validFiles = [];
            
            // Validate files first
            for (const file of files) {
                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');
                
                if (!isImage && !isVideo) {
                    errors.push(`File ${file.name} tidak didukung. Gunakan gambar atau video.`);
                    continue;
                }

                const maxSize = isVideo ? 50 * 1024 * 1024 : 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    const maxSizeMB = isVideo ? 50 : 10;
                    errors.push(`File ${file.name} terlalu besar (maksimal ${maxSizeMB}MB)`);
                    continue;
                }
                
                validFiles.push(file);
            }
            
            if (validFiles.length === 0) {
                if (errors.length > 0) {
                    alert(errors.join('\n'));
                }
                return;
            }

            // Show uploading state
            if (dropZone) {
                dropZone.classList.add('uploading');
            }

            // Create preview items and upload
            const uploadPromises = validFiles.map(async (file) => {
                let previewItem = null;
                let previewUrl = null;
                
                // Create preview for images
                if (file.type.startsWith('image/')) {
                    try {
                        previewUrl = URL.createObjectURL(file);
                        previewItem = createUploadPreview(file, previewUrl);
                        uploadingFiles.add(file.name);
                    } catch (e) {
                        console.error('Preview error:', e);
                    }
                } else {
                    previewItem = createUploadPreview(file, null);
                    uploadingFiles.add(file.name);
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const xhr = new XMLHttpRequest();
                    
                    // Track upload progress
                    if (previewItem) {
                        const progressBar = previewItem.querySelector('.ai-upload-progress-bar');
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable && progressBar) {
                                const percent = (e.loaded / e.total) * 100;
                                progressBar.style.width = percent + '%';
                            }
                        });
                    }

                    const uploadPromise = new Promise((resolve, reject) => {
                        xhr.onload = () => {
                            if (xhr.status === 200) {
                                try {
                                    const data = JSON.parse(xhr.responseText);
                                    resolve(data);
                                } catch (e) {
                                    reject(new Error('Invalid response'));
                                }
                            } else {
                                try {
                                    const error = JSON.parse(xhr.responseText);
                                    reject(new Error(error.error || 'Upload failed'));
                                } catch (e) {
                                    reject(new Error('Upload failed'));
                                }
                            }
                        };
                        
                        xhr.onerror = () => reject(new Error('Network error'));
                        xhr.open('POST', '/api/ai_generate/upload');
                        xhr.send(formData);
                    });

                    const data = await uploadPromise;
                    
                    // Remove preview item
                    if (previewItem) {
                        previewItem.remove();
                    }
                    
                    // Clean up preview URL
                    if (previewUrl) {
                        URL.revokeObjectURL(previewUrl);
                    }
                    
                    uploadingFiles.delete(file.name);
                    
                    if (data.success) {
                        addAttachment({
                            url: data.url,
                            type: data.type,
                            filename: data.filename,
                            size: data.size
                        });
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    errors.push(`Gagal upload ${file.name}: ${error.message}`);
                    
                    // Remove preview item on error
                    if (previewItem) {
                        previewItem.remove();
                    }
                    if (previewUrl) {
                        URL.revokeObjectURL(previewUrl);
                    }
                    uploadingFiles.delete(file.name);
                }
            });

            await Promise.all(uploadPromises);
            
            // Remove uploading state
            if (dropZone) {
                dropZone.classList.remove('uploading');
            }

            // Show errors if any
            if (errors.length > 0) {
                alert(errors.join('\n'));
            }
        }

        // Drop Zone Click Handler
        if (dropZone && fileInput) {
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
        }
        if (dropHint && fileInput) {
            dropHint.addEventListener('click', () => fileInput.click());
        }

        // Inline Drop Zone Drag & Drop on input bar
        if (promptWrapperEl && inlineDropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                promptWrapperEl.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                promptWrapperEl.addEventListener(eventName, () => {
                    inlineDropZone.classList.add('active');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                promptWrapperEl.addEventListener(eventName, () => {
                    inlineDropZone.classList.remove('active');
                });
            });

            promptWrapperEl.addEventListener('drop', async (e) => {
                const files = Array.from(e.dataTransfer.files || []);
                if (files.length > 0) {
                    await uploadFiles(files);
                }
            });
        }

        // Drop Zone Drag & Drop (legacy hidden zone)
        if (dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    dropZone.classList.add('dragover');
                    // Show file count badge
                    if (e.dataTransfer && e.dataTransfer.files) {
                        const fileCount = e.dataTransfer.files.length;
                        if (fileCount > 0 && fileCountBadge) {
                            fileCountBadge.textContent = `${fileCount} file${fileCount > 1 ? 's' : ''}`;
                        }
                    }
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                    // Hide file count badge
                    if (fileCountBadge) {
                        fileCountBadge.textContent = '';
                    }
                });
            });

            dropZone.addEventListener('drop', async (e) => {
                const files = Array.from(e.dataTransfer.files || []);
                if (files.length > 0) {
                    await uploadFiles(files);
                }
            });
        }

        // Attachment Button Click
        if (attachBtn && fileInput) {
            attachBtn.addEventListener('click', () => {
                fileInput.click();
            });
        }

        // File Input Change
        if (fileInput) {
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length > 0) {
                    await uploadFiles(files);
                }
                // Reset file input
                fileInput.value = '';
            });
        }

        // Drag & Drop
        if (inputArea) {
            const dragOverlay = document.createElement('div');
            dragOverlay.className = 'ai-drag-overlay';
            dragOverlay.innerHTML = '<div class="ai-drag-overlay-text">Lepaskan file di sini untuk melampirkan</div>';
            inputArea.appendChild(dragOverlay);

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                inputArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                inputArea.addEventListener(eventName, () => {
                    dragOverlay.classList.add('active');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                inputArea.addEventListener(eventName, () => {
                    dragOverlay.classList.remove('active');
                });
            });

            inputArea.addEventListener('drop', async (e) => {
                const files = Array.from(e.dataTransfer.files || []);
                if (files.length > 0) {
                    await uploadFiles(files);
                }
            });
        }

        // Add Message
        window.addMessage = function(role, html) {
            if (!stream) return;
            const el = document.createElement('div');
            el.className = `ai-message ${role}`;
            try {
                el.innerHTML = `
                    <div class="ai-message-avatar">
                        ${role === 'user' ? '<i class="bi bi-person"></i>' : '<i class="bi bi-robot"></i>'}
                    </div>
                    <div class="ai-message-bubble">
                        ${html}
                        <div class="ai-message-actions">
                            <button title="Copy" onclick="window.copyMessage(this)"><i class="bi bi-clipboard"></i></button>
                            ${role === 'assistant' ? '<button title="Regenerate" onclick="window.regenerateMessage(this)"><i class="bi bi-arrow-repeat"></i></button>' : ''}
                        </div>
                        <div class="ai-message-meta">
                            ${role === 'user' ? 'You' : 'AI Assistant'}  ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                `;
                stream.appendChild(el);
                stream.scrollTop = stream.scrollHeight;
                // Smooth scroll with fallback
                try {
                    stream.scrollTo({ top: stream.scrollHeight, behavior: 'smooth' });
                } catch (e) {
                    stream.scrollTop = stream.scrollHeight;
                }
            } catch (e) {
                console.error('Error adding message:', e);
            }
        };

        // Show/Hide Stream
        window.ensureStreamVisible = function() {
            if (emptyHero) emptyHero.style.display = 'none';
            if (stream) stream.classList.add('active');
        };

        // Show/Hide Typing
        window.showTyping = function(show) {
            if (typing) typing.classList.toggle('active', show);
        };

        // Premium Lightbox Functionality
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxClose = document.getElementById('lightboxClose');

        function openLightbox(imageSrc) {
            if (lightbox && lightboxImage) {
                lightboxImage.src = imageSrc;
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Make openLightbox globally available
        window.openLightbox = openLightbox;

        // AI Recommendations Modal
        const recommendationsModal = document.getElementById('recommendationsModal');
        const recommendationsClose = document.getElementById('recommendationsClose');
        const recommendationsImage = document.getElementById('recommendationsImage');
        const recommendationsAnalysis = document.getElementById('recommendationsAnalysis');
        const recommendationsModels = document.getElementById('recommendationsModels');
        const recommendationsSuggestions = document.getElementById('recommendationsSuggestions');
        const recommendationsActions = document.getElementById('recommendationsActions');

        async function showAIRecommendations(imageSrc) {
            if (!recommendationsModal || !recommendationsImage) return;
            
            // Show modal dengan loading state
            recommendationsImage.src = imageSrc;
            recommendationsModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Show loading
            recommendationsAnalysis.innerHTML = `
                <div class="ai-recommendations-loading">
                    <div class="ai-skeleton" style="width: 100%"></div>
                    <div class="ai-skeleton" style="width: 80%"></div>
                    <div class="ai-skeleton" style="width: 90%"></div>
                </div>
            `;
            recommendationsModels.innerHTML = '';
            recommendationsSuggestions.innerHTML = '';
            recommendationsActions.innerHTML = '';
            
            try {
                // Call API untuk analyze image
                const res = await fetch('/api/ai_generate/analyze-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        image_url: imageSrc
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Show analysis
                    if (data.analysis) {
                        recommendationsAnalysis.innerHTML = `
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <i class="bi bi-eye" style="color: var(--accent-neon); font-size: 16px; margin-top: 2px;"></i>
                                <div style="flex: 1;">
                                    <strong style="color: var(--accent-neon); display: block; margin-bottom: 6px;">Analisis Gambar:</strong>
                                    <div>${data.analysis}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        recommendationsAnalysis.innerHTML = '';
                    }
                    
                    // Show recommended models
                    if (data.recommended_models && data.recommended_models.length > 0) {
                        const modelNames = {
                            'imagen4-ultra': { name: 'Imagen 4 Ultra', icon: 'bi-stars' },
                            'gpt-image-1': { name: 'GPT Image 1', icon: 'bi-image' },
                            'nano-banana': { name: 'Nano Banana', icon: 'bi-palette' }
                        };
                        
                        recommendationsModels.innerHTML = `
                            <div class="ai-recommendations-models-title">
                                <i class="bi bi-cpu"></i> Model yang Direkomendasikan
                            </div>
                            <div class="ai-model-recommendations">
                                ${data.recommended_models.map((model, idx) => {
                                    const modelInfo = modelNames[model] || { name: model, icon: 'bi-circle' };
                                    return `
                                        <div class="ai-model-chip ${idx === 0 ? 'recommended' : ''}" onclick="
                                            const modeSelect = document.getElementById('mode');
                                            if (modeSelect) modeSelect.value = 'image_generate';
                                            const modeChips = document.querySelectorAll('.ai-mode-chip');
                                            modeChips.forEach(c => c.classList.toggle('active', c.dataset.mode === 'image_generate'));
                                            if (window.showToast) window.showToast('Model ${modelInfo.name} dipilih', 'success');
                                            closeRecommendations();
                                        ">
                                            <i class="bi ${modelInfo.icon}"></i>
                                            <span>${modelInfo.name}</span>
                                            ${idx === 0 ? '<i class="bi bi-star-fill" style="color: #FBBF24; font-size: 12px;"></i>' : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    // Show suggestions
                    if (data.suggestions && data.suggestions.length > 0) {
                        recommendationsSuggestions.innerHTML = `
                            <div class="ai-recommendations-suggestions-title">
                                <i class="bi bi-lightbulb"></i> Saran
                            </div>
                            ${data.suggestions.map(suggestion => `
                                <div class="ai-suggestion-item">
                                    <i class="bi bi-check-circle"></i>
                                    <span>${suggestion}</span>
                                </div>
                            `).join('')}
                        `;
                    }
                    
                    // Show quick actions
                    if (data.quick_actions && data.quick_actions.length > 0) {
                        recommendationsActions.innerHTML = `
                            <div class="ai-recommendations-actions-title">
                                <i class="bi bi-lightning"></i> Quick Actions
                            </div>
                            ${data.quick_actions.map((action, idx) => {
                                const actionIcons = {
                                    'edit': 'bi-pencil',
                                    'generate': 'bi-magic',
                                    'video': 'bi-play-circle',
                                    'enhance': 'bi-stars',
                                    'style_transfer': 'bi-palette'
                                };
                                const actionLabel = action.label || (action.action === 'edit' ? 'Edit' : action.action === 'generate' ? 'Generate' : action.action === 'style_transfer' ? 'Style Transfer' : 'Action');
                                return `
                                    <button class="ai-quick-action-btn" onclick="
                                        const promptInput = document.getElementById('aiPrompt');
                                        const modeSelect = document.getElementById('mode');
                                        const attachInput = document.getElementById('fileInput');
                                        
                                        // Set prompt and mode
                                        if (promptInput) promptInput.value = '${action.prompt.replace(/'/g, "\\'")}';
                                        if (modeSelect) modeSelect.value = '${action.mode}';
                                        
                                        // Update mode chips
                                        const modeChips = document.querySelectorAll('.ai-mode-chip');
                                        modeChips.forEach(c => c.classList.toggle('active', c.dataset.mode === '${action.mode}'));
                                        
                                        // For edit mode, set image if available
                                        if ('${action.mode}' === 'image_edit' && attachInput) {
                                            // User perlu upload image untuk edit
                                            if (window.showToast) window.showToast('Upload gambar untuk edit', 'info');
                                        }
                                        
                                        if (promptInput) {
                                            promptInput.focus();
                                            if (typeof autoResizeTextarea === 'function') autoResizeTextarea();
                                            if (typeof analyzePromptQuality === 'function') analyzePromptQuality();
                                        }
                                        closeRecommendations();
                                        if (window.showToast) window.showToast('Quick action: ${actionLabel}', 'success');
                                    ">
                                        <div class="action-info">
                                            <div class="action-label">${actionLabel}</div>
                                            <div class="action-prompt">${action.prompt}</div>
                                        </div>
                                        <i class="bi ${actionIcons[action.action] || 'bi-arrow-right'} action-icon"></i>
                                    </button>
                                `;
                            }).join('')}
                        `;
                    }
                    
                    // Show style transfer options if available
                    if (data.style_transfer && data.style_transfer.length > 0) {
                        const styleTransferHTML = `
                            <div class="ai-recommendations-actions-title" style="margin-top: 20px;">
                                <i class="bi bi-palette"></i> Style Transfer
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-top: 12px;">
                                ${data.style_transfer.map(style => `
                                    <button class="ai-model-chip" onclick="
                                        const promptInput = document.getElementById('aiPrompt');
                                        const modeSelect = document.getElementById('mode');
                                        if (promptInput) promptInput.value = '${style.prompt.replace(/'/g, "\\'")}';
                                        if (modeSelect) modeSelect.value = '${style.mode}';
                                        const modeChips = document.querySelectorAll('.ai-mode-chip');
                                        modeChips.forEach(c => c.classList.toggle('active', c.dataset.mode === '${style.mode}'));
                                        if (promptInput) {
                                            promptInput.focus();
                                            if (typeof autoResizeTextarea === 'function') autoResizeTextarea();
                                            if (typeof analyzePromptQuality === 'function') analyzePromptQuality();
                                        }
                                        closeRecommendations();
                                        if (window.showToast) window.showToast('Style: ${style.name}', 'success');
                                    ">
                                        <i class="bi bi-palette"></i>
                                        <span>${style.name}</span>
                                    </button>
                                `).join('')}
                            </div>
                        `;
                        recommendationsActions.innerHTML += styleTransferHTML;
                    }
                    
                    // Show batch suggestions if available
                    if (data.batch_suggestions && data.batch_suggestions.length > 0) {
                        const batchHTML = `
                            <div class="ai-recommendations-suggestions-title" style="margin-top: 20px;">
                                <i class="bi bi-layers"></i> Batch Processing
                            </div>
                            ${data.batch_suggestions.map(suggestion => `
                                <div class="ai-suggestion-item">
                                    <i class="bi bi-stack"></i>
                                    <span>${suggestion}</span>
                                </div>
                            `).join('')}
                        `;
                        recommendationsSuggestions.innerHTML += batchHTML;
                    }
                } else {
                    recommendationsAnalysis.innerHTML = `
                        <div style="color: #ff6b6b;">
                            <i class="bi bi-exclamation-triangle"></i> Gagal menganalisis gambar: ${data.message || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error analyzing image:', error);
                recommendationsAnalysis.innerHTML = `
                    <div style="color: #ff6b6b;">
                        <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
                    </div>
                `;
            }
        }

        function closeRecommendations() {
            if (recommendationsModal) {
                recommendationsModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        if (recommendationsClose) {
            recommendationsClose.addEventListener('click', closeRecommendations);
        }

        if (recommendationsModal) {
            recommendationsModal.addEventListener('click', (e) => {
                if (e.target === recommendationsModal) {
                    closeRecommendations();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && recommendationsModal.classList.contains('active')) {
                    closeRecommendations();
                }
            });
        }

        // Make showAIRecommendations globally available
        window.showAIRecommendations = showAIRecommendations;

        function closeLightbox() {
            if (lightbox) {
                lightbox.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        if (lightboxClose) {
            lightboxClose.addEventListener('click', closeLightbox);
        }

        if (lightbox) {
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && lightbox.classList.contains('active')) {
                    closeLightbox();
                }
            });
        }

        // Premium Toast Notification System
        const toastContainer = document.getElementById('toastContainer');

        window.showToast = function(message, type = 'info', title = '') {
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `ai-toast ${type}`;

            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };

            const titles = {
                success: 'Berhasil',
                error: 'Error',
                warning: 'Peringatan',
                info: 'Info'
            };

            toast.innerHTML = `
                <div class="ai-toast-icon">
                    <i class="bi ${icons[type] || icons.info}"></i>
                </div>
                <div class="ai-toast-content">
                    ${title ? `<div class="ai-toast-title">${title || titles[type]}</div>` : ''}
                    <div class="ai-toast-message">${message}</div>
                </div>
                <button class="ai-toast-close" onclick="this.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            `;

            toastContainer.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
        };

        // Add click handler to media images for lightbox
        document.addEventListener('click', (e) => {
            const img = e.target.closest('.ai-media-grid img, .ai-attachment-item img');
            if (img && img.src) {
                e.preventDefault();
                openLightbox(img.src);
            }
        });

        // Render Assistant Result
        window.renderAssistantResult = function(resp) {
            if (!resp || !resp.success) {
                const msg = (resp && resp.message) || 'Gagal memproses.';
                window.addMessage('assistant', `<div style="color: #ff6b6b;">${msg}</div>`);
                return;
            }

            const type = resp.type;
            let html = '';

            if (type === 'chat') {
                // Chat response from Gemini
                const message = resp.message || '';
                // Format message with line breaks
                const formattedMessage = message.replace(/\n/g, '<br>');
                html = `<div style="white-space: pre-wrap; line-height: 1.6;">${formattedMessage}</div>`;
                window.addMessage('assistant', html);
                return;
            }

            if (type === 'image') {
                // Handle different response structures
                const data = resp.data || {};
                const action = resp.action || 'generate';  // 'edit' or 'generate'
                let url = resp.url;
                if (!url && data) {
                    url = data.photo_url || data.url || data.image_url;
                }
                if (!url) {
                    window.addMessage('assistant', `<div style="color: #ffd93d;">Tidak ada URL gambar.</div>`);
                    return;
                }
                
                const modelUsed = data.model_used || (action === 'edit' ? 'nano-banana' : 'imagen4-ultra');
                
                // Get all variations (3 images)
                let variations = data.variations || data.images || [];
                if (variations.length === 0 && url) {
                    variations = [url];  // Fallback to single image
                }
                
                const count = variations.length || 1;
                const actionLabel = action === 'edit' ? 'Edit' : 'Gambar';
                
                // Build grid for multiple variations
                let gridItems = '';
                variations.forEach((imgUrl, index) => {
                    gridItems += `
                        <div class="ai-image-variation" data-index="${index}">
                            <img src="${imgUrl}" alt="AI ${actionLabel} Variasi ${index + 1}" onclick="
                                // Show AI recommendations on click
                                if (window.showAIRecommendations) {
                                    window.showAIRecommendations('${imgUrl}');
                                } else {
                                    window.openLightbox('${imgUrl}');
                                }
                            " style="cursor: pointer;" />
                            <div class="ai-variation-number">Variasi ${index + 1}</div>
                            <a href="${imgUrl}" download class="ai-variation-download" title="Download">
                                <i class="bi bi-download"></i>
                            </a>
                            <div class="ai-variation-actions">
                                <button onclick="
                                    // Show AI recommendations
                                    if (window.showAIRecommendations) {
                                        window.showAIRecommendations('${imgUrl}');
                                    } else {
                                        window.openLightbox('${imgUrl}');
                                    }
                                " title="Analisa dengan AI">
                                    <i class="bi bi-magic"></i>
                                </button>
                                <button onclick="
                                    navigator.clipboard.writeText('${imgUrl}');
                                    if (window.showToast) window.showToast('URL disalin!', 'success');
                                " title="Salin URL">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html = `
                    <div class="ai-result-label"> Hasil: ${count} Variasi ${actionLabel} (${modelUsed})</div>
                    <div class="ai-media-grid ai-variations-grid">
                        ${gridItems}
                    </div>
                    <div class="ai-result-actions">
                        <a href="${variations[0]}" target="_blank"><i class="bi bi-box-arrow-up-right"></i> Buka Semua</a>
                        <button onclick="navigator.clipboard.writeText('${variations.join('\\n')}')"><i class="bi bi-clipboard"></i> Copy Semua URL</button>
                    </div>
                `;
            } else if (type === 'video') {
                const d = resp.data || {};
                const vurl = d.url || d.video_url || (d.result && d.result.video_url) || '';
                if (!vurl) {
                    html = `<div style="color: #6bcf7f;">Video sedang diproses. Silakan cek halaman video.</div>`;
                } else {
                    // Generate unique filename
                    const timestamp = Date.now();
                    const filename = `ai_video_${timestamp}.mp4`;
                    // Check if it's face swap video
                    const message = d.message || '';
                    const isFaceSwap = message.includes('Face Swap') || message.includes('face swap');
                    const resultLabel = isFaceSwap ? ' Hasil: Video Face Swap' : ' Hasil: Video Sinematik';
                    
                    html = `
                        <div class="ai-result-label">${resultLabel}</div>
                        <div class="ai-media-grid">
                            <video src="${vurl}" controls style="max-width: 100%; border-radius: 12px;"></video>
                        </div>
                        <div class="ai-result-actions">
                            <a href="${vurl}" target="_blank"><i class="bi bi-box-arrow-up-right"></i> Buka Video</a>
                            <button onclick="navigator.clipboard.writeText('${vurl}'); if (window.showToast) window.showToast('URL disalin!', 'success');"><i class="bi bi-clipboard"></i> Copy URL</button>
                            <button onclick="window.downloadVideo('${vurl}', '${filename}', this)"><i class="bi bi-download"></i> Download</button>
                        </div>
                    `;
                }
            } else if (type === 'music') {
                const d = resp.data || {};
                const aurl = d.url || d.audio_url || (d.result && d.result.audio_url) || '';
                const title = d.title || 'Musik AI';
                const modelName = d.model_name || 'V4_5PLUS';
                const duration = d.duration || 0;
                const musicId = d.music_id || (resp.music_id) || '';
                
                if (!aurl) {
                    // Still processing
                    html = `<div style="color: #6bcf7f;"> Musik sedang diproses oleh Suno AI. Silakan tunggu...</div>`;
                } else {
                    // Music completed
                    const durationText = duration > 0 ? `${Math.floor(duration / 60)}:${String(duration % 60).padStart(2, '0')}` : '0:00';
                    // Build link to post_musik page if music_id is available
                    const detailLink = musicId ? `/post_musik/${musicId}` : '';
                    html = `
                        <div class="ai-result-label"> Hasil: ${title}</div>
                        <div class="ai-music-card">
                            ${d.image_url ? `
                                <div class="ai-music-cover">
                                    <img src="${d.image_url}" alt="Cover" />
                                </div>
                            ` : ''}
                            <div class="ai-music-player-wrapper">
                                <div class="ai-music-info">
                                    <div class="ai-music-title">${title}</div>
                                    <div class="ai-music-meta">
                                        <span class="ai-music-model">${modelName}</span>
                                        <span class="ai-music-duration">${durationText}</span>
                                    </div>
                                </div>
                                <div class="ai-music-audio-player">
                                    <audio controls src="${aurl}">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            </div>
                        </div>
                        <div class="ai-result-actions">
                            ${detailLink ? `<a href="${detailLink}" class="ai-action-btn"><i class="bi bi-eye"></i> Lihat Detail</a>` : ''}
                            <a href="${aurl}" target="_blank" class="ai-action-btn"><i class="bi bi-box-arrow-up-right"></i> Buka</a>
                            <button onclick="navigator.clipboard.writeText('${aurl}')" class="ai-action-btn"><i class="bi bi-clipboard"></i> Copy URL</button>
                            <a href="${aurl}" download class="ai-action-btn"><i class="bi bi-download"></i> Download</a>
                        </div>
                    `;
                }
            } else {
                html = `<div style="color: #a0a0c4;">Permintaan selesai.</div>`;
            }

            window.addMessage('assistant', html);
        };

        // Send Message
        if (runBtn) {
            runBtn.addEventListener('click', async (e) => {
            // Prevent any form submission or default behavior
            if (e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
            }
            
                const prompt = promptInput ? promptInput.value.trim() : '';
                let mode = modeSelect ? modeSelect.value : '';
                
                // Normalize mode: empty string or 'auto' means auto-detect
                if (mode === 'auto' || mode === '') {
                    mode = ''; // Send empty string to backend for auto-detect
                }
                
                // IMPORTANT: Snapshot attachments BEFORE clearing them
                // This ensures we capture the current state for backend processing
                const hasActiveAttachments = attachments.length > 0;
                const attachmentsSnapshot = hasActiveAttachments ? JSON.parse(JSON.stringify(attachments)) : [];
                const imageUrl = (hasActiveAttachments && attachments[0] && attachments[0].url) ? attachments[0].url : '';

                if (!prompt && !hasActiveAttachments) {
                    if (e) e.preventDefault();
                    return false;
                }
                
                // Auto-detect mode if not set (mode is empty) and has attachments
                // Only auto-detect if user hasn't explicitly selected a mode
                if (!mode && hasActiveAttachments) {
                    const hasImage = attachments.some(a => a.type === 'image');
                    const hasVideo = attachments.some(a => a.type === 'video');
                    const promptLower = prompt.toLowerCase();
                    
                    // Priority 1: Video Face Swap (if has both image and video)
                    if (hasImage && hasVideo) {
                        if (modeSelect) {
                            modeSelect.value = 'video_face_swap';
                            mode = 'video_face_swap';
                            // Update active chip
                            const modeChips = document.querySelectorAll('.ai-mode-chip');
                            modeChips.forEach(c => {
                                c.classList.toggle('active', c.dataset.mode === 'video_face_swap');
                            });
                        }
                    }
                    // Priority 2: Image edit or image to video (if has image only)
                    else if (hasImage) {
                        // Only auto-detect if prompt contains explicit action keywords
                        const hasActionKeyword = promptLower.includes('edit') || promptLower.includes('ubah') || 
                                                promptLower.includes('video') || promptLower.includes('i2v') || 
                                                promptLower.includes('gambar jadi video');
                        
                        if (hasActionKeyword) {
                            if (promptLower.includes('edit') || promptLower.includes('ubah')) {
                                if (modeSelect) {
                                    modeSelect.value = 'image_edit';
                                    mode = 'image_edit';
                                }
                            } else if (promptLower.includes('video') || promptLower.includes('i2v') || promptLower.includes('gambar jadi video')) {
                                if (modeSelect) {
                                    modeSelect.value = 'image_to_video';
                                    mode = 'image_to_video';
                                }
                            }
                        }
                    }
                    // If no specific mode detected or no action keyword, keep mode empty for chat
                }

            window.ensureStreamVisible();
            
            // Build message HTML with attachments (before clearing)
            let messageHtml = prompt;
            if (hasActiveAttachments) {
                messageHtml += '<div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">';
                attachments.forEach(att => {
                    if (att.type === 'image') {
                        messageHtml += `<img src="${att.url}" alt="${att.filename}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;" />`;
                    } else if (att.type === 'video') {
                        messageHtml += `<video src="${att.url}" controls style="max-width: 200px; max-height: 200px; border-radius: 8px;" muted></video>`;
                    }
                });
                messageHtml += '</div>';
            }
            
            window.addMessage('user', messageHtml);
            if (promptInput) promptInput.value = '';
            autoResizeTextarea();
            
            // Clear attachments AFTER capturing needed data
            attachments = [];
            updateAttachmentPreview();

            runBtn.disabled = true;
            runBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            window.showTyping(true);

            // Input area animation
            const inputArea = document.querySelector('.ai-input-area');
            if (inputArea) {
                inputArea.style.transform = 'translateY(-4px)';
                setTimeout(() => {
                    inputArea.style.transform = 'translateY(0)';
                }, 200);
            }

            try {
                // First check session status
                const sessionCheck = await fetch('/api/ai_generate/check-session', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (sessionCheck.ok) {
                    const sessionData = await sessionCheck.json();
                    console.log('Session status:', sessionData);
                    if (!sessionData.logged_in) {
                        window.addMessage('assistant', `<div style="color: #ff6b6b;">Sesi Anda telah berakhir. Silakan <a href="/login" style="color: #4C7EFF; text-decoration: underline;">login ulang</a>.</div>`);
                        return;
                    }
                }
                
                // Only send image_url if we had active attachments when capturing
                // Use the captured hasActiveAttachments state, not current attachments (which are already cleared)
                const payload = { 
                    prompt, 
                    image_url: (hasActiveAttachments && imageUrl) ? imageUrl : '', 
                    mode,
                    attachments: attachmentsSnapshot
                };
                
                // Debug logging
                console.log('[AI Generate] Sending payload:', {
                    prompt: prompt.substring(0, 50),
                    hasActiveAttachments,
                    image_url: imageUrl ? `${imageUrl.substring(0, 50)}...` : '(empty)',
                    mode: mode || '(auto)'
                });
                const res = await fetch('/api/ai_generate', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin',
                    redirect: 'manual'
                });
                
                // Check if response is a redirect
                if (res.type === 'opaqueredirect' || res.status === 302 || res.status === 301) {
                    window.addMessage('assistant', `<div style="color: #ff6b6b;">Server mengirim redirect yang tidak diharapkan. Silakan refresh halaman.</div>`);
                    return;
                }
                
                // Check response status
                if (!res.ok) {
                    // Try to get error message from JSON
                    let errorData;
                    try {
                        errorData = await res.json();
                    } catch (e) {
                        errorData = { message: `HTTP ${res.status}: ${res.statusText}` };
                    }
                    
                    // Don't redirect for 401, just show error message
                    if (res.status === 401) {
                        window.addMessage('assistant', `<div style="color: #ff6b6b;">${errorData.message || 'Sesi Anda telah berakhir. Silakan login ulang.'}</div>`);
                        return;
                    }
                    
                    window.addMessage('assistant', `<div style="color: #ff6b6b;">${errorData.message || 'Terjadi kesalahan pada server.'}</div>`);
                    return;
                }
                
                // Parse JSON response
                let data;
                try {
                    const text = await res.text();
                    if (!text) {
                        throw new Error('Response kosong');
                    }
                    data = JSON.parse(text);
                } catch (e) {
                    window.addMessage('assistant', `<div style="color: #ff6b6b;">Gagal memparse response: ${e.message}</div>`);
                    return;
                }
                
                // Handle music generation with async polling
                if (data.type === 'music' && data.status === 'processing' && data.task_id) {
                    console.log('[AI Generate] Starting music polling for task_id:', data.task_id);
                    // Show processing message
                    window.addMessage('assistant', `<div style="color: #6bcf7f;"> Musik sedang diproses oleh Suno AI. Silakan tunggu...</div>`);
                    // Start polling
                    window.pollMusicStatus(data.task_id);
                } else {
                    window.renderAssistantResult(data);
                }
                
                // Save user message with prompt and attachments (prioritize attachments array)
                const userHistoryItem = {
                    role: 'user',
                    content: prompt,
                    attachments: attachments.length > 0 ? attachments.map(a => a.url) : []
                };
                // Only add image field if no attachments (for backward compatibility)
                if (attachments.length === 0 && imageUrl) {
                    userHistoryItem.image = imageUrl;
                }
                saveHistoryItem(userHistoryItem);
                saveHistoryItem({ role: 'assistant', content: data });
            } catch (e) {
                window.addMessage('assistant', `<div style="color: #ff6b6b;">${e?.message || 'Terjadi kesalahan. Pastikan Anda masih terhubung ke internet.'}</div>`);
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="bi bi-send"></i>';
                window.showTyping(false);
            }
        });
        }

        // Auto Detect Button
        if (autoDetectBtn) {
            autoDetectBtn.addEventListener('click', (e) => {
                // Prevent any form submission
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                const prompt = promptInput ? promptInput.value.trim() : '';
                if (!prompt && attachments.length === 0) return;
                
                autoDetectBtn.classList.add('active');
                // Simple auto-detect logic
                const text = prompt.toLowerCase();
                if (modeSelect) {
                    // Check if has attachments
                    if (attachments.length > 0) {
                        const hasImage = attachments.some(a => a.type === 'image');
                        const hasVideo = attachments.some(a => a.type === 'video');
                        
                        // Priority 1: Video Face Swap (both image and video)
                        if (hasImage && hasVideo) {
                            modeSelect.value = 'video_face_swap';
                        }
                        // Priority 2: Image edit (image only)
                        else if (hasImage && (text.includes('edit') || text.includes('ubah'))) {
                            modeSelect.value = 'image_edit';
                        }
                        // Priority 3: Image to video (image only)
                        else if (hasImage && (text.includes('video') || text.includes('vidio') || text.includes('i2v'))) {
                            modeSelect.value = 'image_to_video';
                        }
                    }
                    
                    // Text-based detection
                    if (text.includes('face swap') || text.includes('faceswap') || text.includes('swap face') || text.includes('tukar wajah') || text.includes('ganti wajah')) {
                        modeSelect.value = 'video_face_swap';
                    } else if (text.includes('video') || text.includes('vidio')) {
                        modeSelect.value = 'video_generate';
                    } else if (text.includes('musik') || text.includes('music') || text.includes('lagu')) {
                        modeSelect.value = 'music_generate';
                    } else if (text.includes('image') || text.includes('gambar') || text.includes('foto')) {
                        modeSelect.value = 'image_generate';
                    }
                }
                
                modeChips.forEach(c => {
                    c.classList.toggle('active', c.dataset.mode === (modeSelect ? modeSelect.value : ''));
                });
                
                setTimeout(() => {
                    autoDetectBtn.classList.remove('active');
                }, 1000);
            });
        }

        // Helper Functions
        window.copyMessage = function(btn) {
            try {
                const bubble = btn.closest('.ai-message-bubble');
                if (!bubble) return;
                const text = bubble.innerText.replace(/\s+$/, '');
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text);
                }
                btn.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            } catch (e) {
                console.error('Copy error:', e);
            }
        };

        // Download Video Function
        window.downloadVideo = async function(url, filename, button) {
            // Show loading state
            const downloadBtn = button || (event && event.target ? event.target.closest('button') : null);
            const originalHTML = downloadBtn ? downloadBtn.innerHTML : '<i class="bi bi-download"></i> Download';
            
            try {
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                    downloadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
                }

                // Fetch the video as blob
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                
                // Create download link
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename || 'ai_video.mp4';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the URL object
                setTimeout(() => {
                    window.URL.revokeObjectURL(downloadUrl);
                }, 100);

                // Restore button state
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = '<i class="bi bi-check"></i> Downloaded';
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalHTML;
                    }, 2000);
                }
            } catch (error) {
                console.error('Download error:', error);
                // Fallback: try direct download link
                try {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename || 'ai_video.mp4';
                    link.target = '_blank';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {
                    console.error('Fallback download error:', e);
                    alert('Gagal mendownload video. Silakan coba klik kanan pada video dan pilih "Save video as..."');
                }

                // Restore button state on error
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = originalHTML;
                }
            }
        };

        window.regenerateMessage = function(btn) {
            // Find the last assistant message with image result
            const assistantMessages = Array.from(document.querySelectorAll('.ai-message.assistant'));
            let lastAssistantMsg = null;
            
            // Find the last assistant message that has image result
            for (let i = assistantMessages.length - 1; i >= 0; i--) {
                const msg = assistantMessages[i];
                const hasImage = msg.querySelector('.ai-media-grid img, .ai-variations-grid');
                if (hasImage) {
                    lastAssistantMsg = msg;
                    break;
                }
            }
            
            if (!lastAssistantMsg) {
                // If no image found, try to get last user message
                const userMessages = Array.from(document.querySelectorAll('.ai-message.user'));
                const lastUser = userMessages[userMessages.length - 1];
                if (lastUser && runBtn) {
                    runBtn.click();
                    return;
                }
                return;
            }
            
            // Find the corresponding user message (the one before this assistant message)
            const allMessages = Array.from(document.querySelectorAll('.ai-message'));
            const assistantIndex = allMessages.indexOf(lastAssistantMsg);
            if (assistantIndex > 0) {
                const userMsg = allMessages[assistantIndex - 1];
                if (userMsg && userMsg.classList.contains('user')) {
                    // Extract prompt from user message
                    const promptText = userMsg.querySelector('.ai-message-bubble');
                    if (promptText) {
                        // Get text content (remove images)
                        const textParts = [];
                        const textNodes = promptText.childNodes;
                        textNodes.forEach(node => {
                            if (node.nodeType === 3) { // Text node
                                const text = node.textContent.trim();
                                if (text) textParts.push(text);
                            }
                        });
                        const prompt = textParts.join(' ').trim();
                        
                        // Also check for attachments in user message
                        const userImages = userMsg.querySelectorAll('img');
                        let imageUrl = '';
                        if (userImages.length > 0) {
                            // Get first image URL (could be base64 or URL)
                            imageUrl = userImages[0].src;
                        }
                        
                        if (prompt && promptInput) {
                            // Set prompt and trigger send
                            promptInput.value = prompt;
                            autoResizeTextarea();
                            
                            // Set attachments if there are images
                            if (imageUrl && imageUrl.startsWith('http')) {
                                // If it's a URL, add to attachments
                                attachments = [{
                                    url: imageUrl,
                                    type: 'image',
                                    filename: 'regenerated_image.jpg'
                                }];
                                updateAttachmentPreview();
                            }
                            
                            // DO NOT remove the last assistant message - keep it!
                            // Foto lama tetap ada, foto baru akan ditambahkan setelahnya
                            
                            // Trigger send to generate new variations
                            if (runBtn) {
                                runBtn.click();
                            }
                        }
                    }
                }
            }
        };

        // Local Storage History
        const HISTORY_KEY = 'ai_generate_history_v2';
        window.saveHistoryItem = function(item) {
            try {
                const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                arr.push(item);
                if (arr.length > 50) arr.shift(); // Keep last 50
                localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
            } catch (e) {
                console.error('Save history error:', e);
            }
        };

        window.restoreHistory = function() {
            try {
                const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                if (!arr.length) return;
                window.ensureStreamVisible();
                arr.forEach(it => {
                    if (it.role === 'user') {
                        // Build message HTML similar to when sending (prompt + attachments/images)
                        let messageHtml = it.content || '';
                        
                        // Handle attachments array (preferred format)
                        if (it.attachments && Array.isArray(it.attachments) && it.attachments.length > 0) {
                            messageHtml += '<div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">';
                            it.attachments.forEach(attUrl => {
                                // Check if it's base64 or URL
                                if (attUrl.startsWith('data:image/')) {
                                    // Base64 image
                                    messageHtml += `<img src="${attUrl}" alt="Uploaded image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;" />`;
                                } else if (attUrl.startsWith('data:video/')) {
                                    // Base64 video
                                    messageHtml += `<video src="${attUrl}" controls style="max-width: 200px; max-height: 200px; border-radius: 8px;" muted></video>`;
                                } else if (attUrl.startsWith('http://') || attUrl.startsWith('https://')) {
                                    // Regular URL - try to detect type from extension or assume image
                                    const isVideo = /\.(mp4|webm|ogg|mov)(\?|$)/i.test(attUrl);
                                    if (isVideo) {
                                        messageHtml += `<video src="${attUrl}" controls style="max-width: 200px; max-height: 200px; border-radius: 8px;" muted></video>`;
                                    } else {
                                        messageHtml += `<img src="${attUrl}" alt="Uploaded image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;" />`;
                                    }
                                }
                            });
                            messageHtml += '</div>';
                        } else if (it.image) {
                            // Legacy format: single image (could be base64 or URL)
                            messageHtml += '<div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">';
                            if (it.image.startsWith('data:image/')) {
                                // Base64 image
                                messageHtml += `<img src="${it.image}" alt="Uploaded image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;" />`;
                            } else if (it.image.startsWith('http://') || it.image.startsWith('https://')) {
                                // Regular URL
                                messageHtml += `<img src="${it.image}" alt="Uploaded image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;" />`;
                            }
                            messageHtml += '</div>';
                        }
                        
                        window.addMessage('user', messageHtml);
                    } else if (it.role === 'assistant') {
                        // Skip music items that are still processing (no audio_url)
                        if (it.content && it.content.type === 'music') {
                            const d = it.content.data || {};
                            const aurl = d.url || d.audio_url || (it.content.url) || '';
                            // Only render if music is completed (has audio_url)
                            if (aurl) {
                                window.renderAssistantResult(it.content);
                            } else {
                                // Skip processing messages - they will be restored as completed if available
                                console.log('[AI Generate] Skipping incomplete music in history');
                            }
                        } else {
                            window.renderAssistantResult(it.content);
                        }
                    }
                });
            } catch (e) {
                console.error('Restore history error:', e);
            }
        };

        // Poll Music Status
        window.pollMusicStatus = async function(task_id) {
            if (!task_id) {
                console.error('[AI Generate] No task_id provided for polling');
                return;
            }
            
            console.log('[AI Generate] Starting music polling for task_id:', task_id);
            let pollCount = 0;
            const maxPolls = 240; // 20 minutes (240 * 5 seconds)
            const pollInterval = 5000; // 5 seconds
            let processingMessageElement = null;
            
            // Find the processing message element
            const findProcessingMessage = () => {
                const messages = document.querySelectorAll('.ai-message.assistant');
                for (let i = messages.length - 1; i >= 0; i--) {
                    const msg = messages[i];
                    const bubble = msg.querySelector('.ai-message-bubble');
                    if (bubble && bubble.textContent.includes('Musik sedang diproses')) {
                        return { message: msg, bubble: bubble };
                    }
                }
                return null;
            };
            
            const poll = async () => {
                try {
                    pollCount++;
                    console.log(`[AI Generate] Polling attempt ${pollCount}/${maxPolls} for task_id: ${task_id}`);
                    
                    const res = await fetch(`/api/ai_generate/music-status/${task_id}`, {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    
                    const data = await res.json();
                    console.log('[AI Generate] Poll response:', data);
                    
                    if (data.success && data.status === 'completed') {
                        console.log('[AI Generate] Music completed! Updating UI...');
                        
                        // Save completed music data to history (replace processing status)
                        // Find the last assistant message in history and update it
                        try {
                            const HISTORY_KEY = 'ai_generate_history_v2';
                            const historyArr = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                            // Find and update the last assistant message with type 'music' and status 'processing'
                            for (let i = historyArr.length - 1; i >= 0; i--) {
                                if (historyArr[i].role === 'assistant' && 
                                    historyArr[i].content && 
                                    historyArr[i].content.type === 'music' && 
                                    (historyArr[i].content.status === 'processing' || !historyArr[i].content.data?.url)) {
                                    // Update with completed data
                                    historyArr[i].content = data;
                                    localStorage.setItem(HISTORY_KEY, JSON.stringify(historyArr));
                                    console.log('[AI Generate] Updated history with completed music data');
                                    break;
                                }
                            }
                        } catch (e) {
                            console.error('[AI Generate] Error updating history:', e);
                        }
                        
                        // Find and update processing message
                        const processingMsg = findProcessingMessage();
                        if (processingMsg) {
                            // Update the existing message
                            processingMsg.bubble.innerHTML = '';
                            window.renderAssistantResult(data);
                            processingMsg.message.remove();
                        } else {
                            // No processing message found, just add result
                            window.renderAssistantResult(data);
                        }
                        
                        console.log('[AI Generate] UI updated successfully');
                        return; // Stop polling
                    }
                    
                    // Still processing - update message with progress
                    if (pollCount % 12 === 0) { // Every minute (12 * 5 seconds)
                        const processingMsg = findProcessingMessage();
                        if (processingMsg && processingMsg.bubble) {
                            const minutes = Math.floor(pollCount / 12);
                            processingMsg.bubble.innerHTML = `<div style="color: #6bcf7f;"> Musik sedang diproses oleh Suno AI. Silakan tunggu... (${minutes} menit)</div>`;
                        }
                    }
                    
                    // Check timeout
                    if (pollCount >= maxPolls) {
                        console.log('[AI Generate] Polling timeout reached');
                        const processingMsg = findProcessingMessage();
                        if (processingMsg && processingMsg.bubble) {
                            processingMsg.bubble.innerHTML = `<div style="color: #ff6b6b;"> Timeout menunggu hasil. Silakan cek halaman musik atau coba lagi.</div>`;
                        }
                        return; // Stop polling
                    }
                    
                    // Continue polling
                    setTimeout(poll, pollInterval);
                } catch (error) {
                    console.error('[AI Generate] Poll music status error:', error);
                    pollCount++;
                    
                    if (pollCount >= maxPolls) {
                        // Timeout
                        const processingMsg = findProcessingMessage();
                        if (processingMsg && processingMsg.bubble) {
                            processingMsg.bubble.innerHTML = `<div style="color: #ff6b6b;"> Error: ${error.message}. Silakan refresh halaman dan coba lagi.</div>`;
                        }
                        return;
                    }
                    
                    // Continue polling on error (with backoff)
                    setTimeout(poll, pollInterval * 2); // Longer delay on error
                }
            };
            
            // Start polling immediately (not after delay)
            poll();
        };

        // Restore history on load
        setTimeout(() => {
            window.restoreHistory();
        }, 100);
    }
})();
</script>
{% endblock %}
