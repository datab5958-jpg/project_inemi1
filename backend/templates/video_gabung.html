{% extends "base.html" %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg border-0 rounded-4 p-4 bg-dark text-light">
        <h2 class="mb-4 text-center fw-bold inemi-gradient-title" style="font-family:'Playfair Display',serif;">INEMI Video AI</h2>
        <form id="uploadForm" action="/video_gabung/upload" method="POST" enctype="multipart/form-data" style="background:rgba(34,34,50,0.85); border-radius:18px; box-shadow:0 8px 32px 0 rgba(31,38,135,0.37); border:1px solid rgba(127,90,240,0.18);">
          <div class="mb-3">
            <label class="form-label fw-semibold">Upload Video (.mp4)</label>
            <input class="form-control" type="file" id="videos" name="videos" accept=".mp4" multiple>
            <small class="text-info">Anda bisa memilih dari galeri <b>atau</b> upload manual, tidak wajib keduanya.</small>
            <button type="button" class="btn btn-outline-info mt-2" id="btn-gallery-video">Pilih dari Galeri</button>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Upload Gambar (.jpg, .png)</label>
            <input class="form-control" type="file" id="images" name="images" accept=".jpg,.jpeg,.png" multiple>
            <small class="text-info">Anda bisa memilih dari galeri <b>atau</b> upload manual, tidak wajib keduanya.</small>
            <button type="button" class="btn btn-outline-info mt-2" id="btn-gallery-image">Pilih dari Galeri</button>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Upload Audio (.mp3)</label>
            <input class="form-control" type="file" id="audios" name="audios" accept=".mp3" multiple>
            <small class="text-info">Anda bisa memilih dari galeri <b>atau</b> upload manual, tidak wajib keduanya.</small>
            <button type="button" class="btn btn-outline-info mt-2" id="btn-gallery-audio">Pilih dari Galeri</button>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Upload Subtitle (.srt)</label>
            <input class="form-control" type="file" id="subtitle" name="subtitle" accept=".srt">
            <textarea class="form-control mt-2" id="subtitle_text" name="subtitle_text" rows="2" placeholder="Tulis subtitle di sini, satu baris per subtitle..."></textarea>
            <div class="form-text">Contoh: Baris 1 akan tampil di detik 0-2, baris 2 di detik 2-4, dst.</div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="subtitle_otomatis" name="subtitle_otomatis">
              <label class="form-check-label" for="subtitle_otomatis">Subtitle Otomatis dari Lirik Lagu (jika audio dari galeri)</label>
            </div>
          </div>
          
          <!-- Opsi Orientasi Video -->
          <div class="mb-4">
            <label class="form-label fw-semibold mb-3">
              <i class="fas fa-video me-2"></i>Orientasi Video
            </label>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="orientation-card" data-orientation="landscape">
                  <div class="orientation-preview landscape-preview">
                    <div class="preview-frame">
                      <i class="fas fa-desktop"></i>
                    </div>
                  </div>
                  <div class="orientation-content">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="video_orientation" id="orientation_landscape" value="landscape" checked>
                      <label class="form-check-label" for="orientation_landscape">
                        <strong>Landscape (16:9)</strong>
                      </label>
                    </div>
                    <div class="orientation-details">
                      <span class="resolution">1920√ó1080</span>
                      <span class="platforms">YouTube ‚Ä¢ TV ‚Ä¢ Desktop</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="orientation-card" data-orientation="portrait">
                  <div class="orientation-preview portrait-preview">
                    <div class="preview-frame">
                      <i class="fas fa-mobile-alt"></i>
                    </div>
                  </div>
                  <div class="orientation-content">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="video_orientation" id="orientation_portrait" value="portrait">
                      <label class="form-check-label" for="orientation_portrait">
                        <strong>Portrait (9:16)</strong>
                      </label>
                    </div>
                    <div class="orientation-details">
                      <span class="resolution">1080√ó1920</span>
                      <span class="platforms">TikTok ‚Ä¢ Instagram ‚Ä¢ Mobile</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <button type="submit" class="btn btn-primary w-100 fw-bold py-3">Proses & Generate</button>
          </div>
        </form>
        <div class="mb-3">
          <h5 class="fw-bold" style="color:#7f5af0; letter-spacing:1px;">Ringkasan File</h5>
          <ul class="list-group list-group-flush bg-dark" style="border-radius:12px; overflow:hidden;">
            <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">Video <span id="video-count" class="badge bg-primary rounded-pill">0</span></li>
            <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">Gambar <span id="image-count" class="badge bg-success rounded-pill">0</span></li>
            <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">Audio <span id="audio-count" class="badge bg-warning text-dark rounded-pill">0</span></li>
            <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">Subtitle <span id="subtitle-count" class="badge bg-info text-dark rounded-pill">0</span></li>
          </ul>
        </div>
        <div id="result-video-block" class="mt-5 text-center" style="display:none;"></div>   
        <!-- Tambahan: Daftar hasil video gabungan dari database -->
        <div class="mt-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold" style="color:#7f5af0; letter-spacing:1px;">Daftar Video Gabungan (Database)</h5>
            <button type="button" class="btn btn-refresh-custom" onclick="loadDbVideosList()">
              <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
          </div>
          <div id="db-videos-list" class="row g-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Galeri (Optimized) -->
<div class="modal fade" id="galleryModal" tabindex="-1" aria-labelledby="galleryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="galleryModalLabel">Pilih dari Galeri</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-0">
        <div class="mb-3">
          <small class="text-muted">Menampilkan 15 item terbaru untuk performa optimal</small>
        </div>
        <div id="gallery-grid" class="gallery-grid">
          <!-- Isi galeri akan diisi dari API -->
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<style>
body {
  background: linear-gradient(135deg, #18122B 0%, #2D3250 100%);
}
.card.shadow-lg {
  background: linear-gradient(135deg, #232946 60%, #7f5af0 100%);
  border: 2.5px solid;
  border-image: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%) 1;
  box-shadow: 0 8px 32px 0 #7f5af088, 0 1.5px 12px 0 #23294655;
}
.inemi-gradient-title {
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
}
.form-label, .fw-semibold, .fw-bold, h2, h4, h5 {
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent !important;
  font-family: 'Playfair Display', serif;
  letter-spacing: 0.5px;
}
.form-control, .form-check-input {
  background: rgba(34,34,50,0.92);
  color: #fff;
  border: 2px solid;
  border-image: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%) 1;
  border-radius: 12px;
  font-size: 1.08rem;
  box-shadow: 0 2px 8px 0 #7f5af022 inset;
  transition: border 0.2s, box-shadow 0.2s;
}
.form-control:focus {
  border-image: linear-gradient(90deg, #ff7cae 0%, #a17cf3 50%, #5fd0fa 100%) 1;
  box-shadow: 0 0 0 0.2rem #7f5af055, 0 2px 8px 0 #7f5af022 inset;
}
.btn-primary, .btn-outline-info, .btn-secondary {
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
  border: none;
  color: #fff !important;
  font-weight: 700;
  font-size: 1.15rem;
  border-radius: 14px;
  box-shadow: 0 4px 24px 0 #7f5af055, 0 1.5px 8px 0 #18b2fa33;
  letter-spacing: 0.5px;
  transition: transform 0.18s, box-shadow 0.18s, background 0.18s;
  background-clip: border-box !important;
  -webkit-background-clip: border-box !important;
  -webkit-text-fill-color: unset !important;
}
.btn-primary:hover, .btn-outline-info:hover, .btn-secondary:hover {
  background: linear-gradient(90deg, #ff7cae 0%, #a17cf3 50%, #5fd0fa 100%);
  color: #fff;
  transform: translateY(-2px) scale(1.04);
  box-shadow: 0 8px 32px 0 #18b2fa55, 0 2px 12px 0 #7f5af055;
}
.list-group-item {
  border: none;
  background: #232946 !important;
  color: #e0e0ff;
  font-size: 1.08rem;
  font-weight: 500;
  letter-spacing: 0.2px;
  border-left: 5px solid;
  border-image: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%) 1;
}
.badge {
  font-size: 1.05rem;
  font-weight: 700;
  box-shadow: 0 2px 8px 0 #7f5af044;
  border-radius: 8px;
  padding: 0.5em 1.1em;
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
  color: #fff;
  border: 2px solid #fff0;
  text-shadow: 0 1px 4px #23294688;
}
.badge.bg-primary, .badge.bg-success, .badge.bg-warning, .badge.bg-info {
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
  color: #fff;
  border: 2px solid #fff0;
}
#result-video-block {
  margin-top: 2rem;
  padding: 1.5rem;
  background: rgba(34, 34, 50, 0.85);
  border-radius: 18px;
  border: 2.5px solid;
  border-image: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%) 1;
}
#result-video-block video {
  max-width: 100%;
  border-radius: 12px;
  border: 2.5px solid;
  border-image: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%) 1;
  box-shadow: 0 8px 32px 0 #7f5af088, 0 2px 12px 0 #18b2fa55;
  background: #18122B;
}
#result-video-block h4 {
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
  letter-spacing: 0.5px;
  font-family: 'Playfair Display', serif;
}
#result-video-block .btn-primary {
  margin-top: 1.2em;
  font-size: 1.1rem;
  padding: 0.7em 2.2em;
  border-radius: 12px;
}
::-webkit-input-placeholder { color: #bdbdf7; }
::-moz-placeholder { color: #bdbdf7; }
:-ms-input-placeholder { color: #bdbdf7; }
::placeholder { color: #bdbdf7; }
.spinner-border {
  width: 3rem;
  height: 3rem;
  color: #7f5af0;
}

/* Optimized Gallery Styles */
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
  gap: 0.7rem;
  margin-bottom: 1.2rem;
}

.gallery-thumb {
  border-radius: 0.7rem;
  overflow: hidden;
  border: 2px solid transparent;
  transition: border-color 0.2s, transform 0.2s;
  cursor: pointer;
  position: relative;
  user-select: none;
}

.gallery-thumb:hover {
  border-color: #a855f7;
  transform: scale(1.05);
  box-shadow: 0 0 15px #a855f7;
}

.gallery-thumb.selected {
  border-color: #a855f7 !important;
  transform: scale(1.05);
  box-shadow: 0 0 20px #a855f7;
}

.gallery-thumb:active {
  transform: scale(0.95);
  transition: transform 0.1s;
}

.gallery-img {
  width: 100%;
  height: 90px;
  object-fit: cover;
  border-radius: 0.7rem;
  border: 2px solid #a855f7;
  box-shadow: 0 1px 8px #a855f799;
  transition: transform 0.2s, box-shadow 0.2s;
  pointer-events: none;
}

.gallery-thumb:hover .gallery-img {
  transform: scale(1.12);
  box-shadow: 0 2px 16px #a855f7cc;
}

.gallery-video {
  width: 100%;
  height: 90px;
  object-fit: cover;
  border-radius: 0.7rem;
  border: 2px solid #a855f7;
  box-shadow: 0 1px 8px #a855f799;
  transition: transform 0.2s, box-shadow 0.2s;
  pointer-events: none;
}

.gallery-thumb:hover .gallery-video {
  transform: scale(1.12);
  box-shadow: 0 2px 16px #a855f7cc;
}

.gallery-audio {
  width: 100%;
  height: 90px;
  object-fit: cover;
  border-radius: 0.7rem;
  border: 2px solid #a855f7;
  box-shadow: 0 1px 8px #a855f799;
  transition: transform 0.2s, box-shadow 0.2s;
  pointer-events: none;
}

.gallery-thumb:hover .gallery-audio {
  transform: scale(1.12);
  box-shadow: 0 2px 16px #a855f7cc;
}



.gallery-name {
  font-size: 0.75rem;
  color: #fff;
  text-align: center;
  margin-top: 0.3rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 90px;
  pointer-events: none;
}

.gallery-thumb input[type="hidden"] {
  pointer-events: none;
}

/* Toast Notification Styles */
.toast-container {
  z-index: 9999;
}

.toast {
  backdrop-filter: blur(10px);
  border-radius: 0.75rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.bg-success {
  background-color: #10b981 !important;
}

.bg-warning {
  background-color: #f59e0b !important;
}

.bg-danger {
  background-color: #ef4444 !important;
}

.bg-info {
  background-color: #3b82f6 !important;
}

/* Styling untuk orientation cards */
.orientation-card {
  background: rgba(34, 34, 50, 0.6);
  border: 2px solid rgba(127, 90, 240, 0.2);
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.orientation-card:hover {
  border-color: rgba(127, 90, 240, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(127, 90, 240, 0.2);
}

.orientation-card.selected {
  border-color: #7f5af0;
  background: rgba(127, 90, 240, 0.1);
  box-shadow: 0 0 20px rgba(127, 90, 240, 0.3);
}

.orientation-card.selected::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%);
}

/* Preview frame styling */
.orientation-preview {
  text-align: center;
  margin-bottom: 15px;
}

.landscape-preview .preview-frame {
  width: 80px;
  height: 45px;
  background: linear-gradient(135deg, #232946 0%, #7f5af0 100%);
  border: 2px solid rgba(127, 90, 240, 0.3);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  position: relative;
}

.portrait-preview .preview-frame {
  width: 45px;
  height: 80px;
  background: linear-gradient(135deg, #232946 0%, #7f5af0 100%);
  border: 2px solid rgba(127, 90, 240, 0.3);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  position: relative;
}

.preview-frame i {
  color: #fff;
  font-size: 1.2rem;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.orientation-card.selected .preview-frame {
  border-color: #7f5af0;
  box-shadow: 0 0 15px rgba(127, 90, 240, 0.4);
}

/* Content styling */
.orientation-content {
  text-align: center;
}

.form-check {
  margin-bottom: 10px;
}

.form-check-input[type="radio"] {
  background-color: rgba(34,34,50,0.92);
  border: 2px solid;
  border-image: linear-gradient(90deg, #5fd0fa 0%, #a17cf3 50%, #ff7cae 100%) 1;
  border-radius: 8px;
  width: 1.2em;
  height: 1.2em;
}

.form-check-input[type="radio"]:checked {
  background-color: #7f5af0;
  border-color: #7f5af0;
  box-shadow: 0 0 0 0.2rem rgba(127, 90, 240, 0.25);
}

.form-check-label {
  color: #e0e0ff;
  font-weight: 500;
  cursor: pointer;
  font-size: 1.1rem;
}

.orientation-details {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.resolution {
  color: #7f5af0;
  font-weight: 600;
  font-size: 0.9rem;
}

.platforms {
  color: #a0a0a0;
  font-size: 0.8rem;
  font-weight: 400;
}

.orientation-card.selected .resolution {
  color: #fff;
}

.orientation-card.selected .platforms {
  color: #e0e0ff;
}

/* Styling untuk info alert */
.alert-info.bg-dark {
  background: rgba(34, 34, 50, 0.8) !important;
  border: 1px solid rgba(127, 90, 240, 0.3) !important;
  color: #e0e0ff !important;
}

.alert-info.bg-dark .text-light {
  color: #e0e0ff !important;
}

.alert-info.bg-dark .text-primary {
  color: #7f5af0 !important;
}

.alert-info.bg-dark .opacity-75 {
  opacity: 0.8 !important;
}

/* Compact video card styling */
.video-card-compact {
  transition: all 0.3s ease;
  border: 1px solid rgba(127, 90, 240, 0.1);
}

.video-card-compact:hover {
  border-color: rgba(127, 90, 240, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(127, 90, 240, 0.2);
}

.video-thumbnail-container {
  position: relative;
  overflow: hidden;
  border-radius: 8px 8px 0 0;
  min-height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.video-compact {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px 8px 0 0;
  display: none;
  /* Ensure portrait videos are displayed properly */
  aspect-ratio: auto;
  /* Prevent video from being stretched */
  max-width: 100%;
  max-height: 100%;
}

/* Special handling for portrait videos */
.video-compact[data-orientation="portrait"] {
  object-fit: contain;
  background: #000;
  /* Ensure portrait videos don't get cropped in fullscreen */
  max-height: 100vh;
  max-width: 100vw;
}

/* Fullscreen portrait video handling */
.video-compact[data-orientation="portrait"]:fullscreen {
  object-fit: contain !important;
  width: auto !important;
  height: auto !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  background: #000 !important;
}

/* Webkit fullscreen support */
.video-compact[data-orientation="portrait"]:-webkit-full-screen {
  object-fit: contain !important;
  width: auto !important;
  height: auto !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  background: #000 !important;
}

/* Mozilla fullscreen support */
.video-compact[data-orientation="portrait"]:-moz-full-screen {
  object-fit: contain !important;
  width: auto !important;
  height: auto !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  background: #000 !important;
}

/* Global fullscreen portrait video handling */
video[data-orientation="portrait"]:fullscreen,
video[data-orientation="portrait"]:-webkit-full-screen,
video[data-orientation="portrait"]:-moz-full-screen {
  object-fit: contain !important;
  width: auto !important;
  height: auto !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  background: #000 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

/* Ensure video controls don't interfere with portrait display */
video[data-orientation="portrait"]::-webkit-media-controls {
  background: rgba(0, 0, 0, 0.5) !important;
}

video[data-orientation="portrait"]::-webkit-media-controls-panel {
  background: rgba(0, 0, 0, 0.5) !important;
}

/* Custom Refresh Button Styling */
.btn-refresh-custom {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: 2px solid transparent;
  color: #fff !important;
  font-weight: 600;
  font-size: 0.9rem;
  border-radius: 25px;
  padding: 8px 20px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.5px;
}

.btn-refresh-custom::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn-refresh-custom:hover {
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
  border-color: rgba(255, 255, 255, 0.3);
}

.btn-refresh-custom:hover::before {
  left: 100%;
}

.btn-refresh-custom:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
}

.btn-refresh-custom i {
  transition: transform 0.3s ease;
}

.btn-refresh-custom:hover i {
  transform: rotate(180deg);
}

/* Loading animation for refresh button */
.btn-refresh-custom.loading {
  pointer-events: none;
  opacity: 0.7;
}

.btn-refresh-custom.loading i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.video-compact::-webkit-media-controls {
  display: none !important;
}

.video-compact::-webkit-media-controls-panel {
  display: none !important;
}

.video-compact::-webkit-media-controls-play-button {
  display: none !important;
}

.video-compact::-webkit-media-controls-start-playback-button {
  display: none !important;
}

.video-info-compact {
  padding: 8px 12px;
  background: rgba(34, 34, 50, 0.6);
  border-radius: 0 0 8px 8px;
}

.video-info-compact small {
  font-size: 0.75rem;
  line-height: 1.2;
}

.video-info-compact .btn {
  font-size: 0.8rem;
  padding: 4px 8px;
  border-radius: 6px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .video-compact {
    height: 140px;
  }
  
  .video-thumbnail-container {
    min-height: 140px;
  }
  
  .video-info-compact {
    padding: 6px 8px;
  }
  
  .video-info-compact .btn {
    font-size: 0.75rem;
    padding: 3px 6px;
  }
}
</style>

<script>
// Tambahan: Fetch dan tampilkan daftar video gabungan dari database (4 terbaru)
function loadDbVideosList() {
  console.log('Loading database videos...');
  const list = document.getElementById('db-videos-list');
  const refreshBtn = document.querySelector('.btn-refresh-custom');
  
  // Add loading state to button
  if (refreshBtn) {
    refreshBtn.classList.add('loading');
    refreshBtn.disabled = true;
  }
  
  // Show loading state
  list.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Memuat daftar video...</p></div>';
  
  fetch('/video_gabung/api/list_videos_db')
    .then(res => {
      console.log('API response status:', res.status);
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      console.log('API response data:', data);
      
      // Remove loading state from button
      if (refreshBtn) {
        refreshBtn.classList.remove('loading');
        refreshBtn.disabled = false;
      }
      
      // Handle error response dari backend
      if (data.error) {
        list.innerHTML = `<div class="text-danger">Error: ${data.error}</div>`;
        return;
      }
      
      if (!Array.isArray(data) || data.length === 0) {
        list.innerHTML = '<div class="text-muted">Belum ada video gabungan di database.</div>';
        return;
      }
      list.innerHTML = '';
      
      // Tampilkan 4 video terbaru dalam grid compact
      data.forEach((item, index) => {
        if (!item.id) {
          console.warn('Video item missing ID:', item);
          return;
        }
        
        const videoUrl = `/video_gabung/stream/${item.id}`;
        const createdAt = item.created_at || 'Unknown';
        
        list.innerHTML += `
          <div class='col-6 col-md-3 mb-2'>
            <div class='video-card-compact bg-dark border-0 shadow-sm' style='border-radius:12px;'>
              <div class='video-thumbnail-container'>
                <div class='text-center py-3' id='loading-${item.id}'>
                  <div class='spinner-border spinner-border-sm text-primary'></div>
                  <small class='text-muted d-block mt-1'>Loading...</small>
                </div>
                <video 
                  controls 
                  preload="metadata"
                  class='video-compact'
                  onloadedmetadata="this.style.display='block'; document.getElementById('loading-${item.id}').style.display='none'; checkVideoOrientation(this);"
                  onerror="this.style.display='none'; document.getElementById('loading-${item.id}').innerHTML='<div class=\'text-center py-2 text-muted\'><i class=\'fas fa-exclamation-triangle\'></i></div>';"
                  crossorigin="anonymous"
                >
                  <source src='${videoUrl}' type='video/mp4' crossorigin="anonymous">
                  Browser Anda tidak mendukung video.
                </video>
              </div>
              <div class='video-info-compact'>
                <small class='text-muted d-block mb-1'>${createdAt}</small>
                <a href='${videoUrl}' download class='btn btn-primary btn-sm w-100'>
                  <i class='fas fa-download me-1'></i>Download
                </a>
              </div>
            </div>
          </div>
        `;
      });
      
      // Tambahkan info jumlah video yang ditampilkan
      if (data.length > 0) {
        const infoDiv = document.createElement('div');
        infoDiv.className = 'col-12 mb-3';
        infoDiv.innerHTML = `
          <div class="alert alert-info bg-dark border-info" style="border-radius: 12px; border: 1px solid rgba(127, 90, 240, 0.3);">
            <div class="d-flex align-items-center">
              <i class="fas fa-info-circle text-primary me-2"></i>
              <div>
                <strong class="text-light">Video Terbaru</strong><br>
                <small class="text-light opacity-75">Menampilkan ${data.length} video terbaru dari database untuk performa optimal</small>
              </div>
            </div>
          </div>
        `;
        list.insertBefore(infoDiv, list.firstChild);
      }
    })
    .catch(error => {
      console.error('Error loading videos:', error);
      
      // Remove loading state from button
      if (refreshBtn) {
        refreshBtn.classList.remove('loading');
        refreshBtn.disabled = false;
      }
      
      const list = document.getElementById('db-videos-list');
      list.innerHTML = '<div class="text-danger">Gagal memuat daftar video. Silakan refresh halaman.</div>';
    });
}
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle AI music prompt area
    const aiMusicCheckbox = document.getElementById('generate_ai_music');
    const aiMusicPromptArea = document.getElementById('ai-music-prompt-area');
    if (aiMusicCheckbox && aiMusicPromptArea) {
      aiMusicCheckbox.addEventListener('change', function() {
        aiMusicPromptArea.style.display = this.checked ? 'block' : 'none';
      });
    }
    
    // Handle video orientation selection
    const orientationCards = document.querySelectorAll('.orientation-card');
    const orientationInputs = document.querySelectorAll('input[name="video_orientation"]');
    
    // Initialize with default orientation
    document.querySelector('[data-orientation="landscape"]').classList.add('selected');
    
    orientationCards.forEach(card => {
      card.addEventListener('click', function() {
        const orientation = this.getAttribute('data-orientation');
        const radioInput = this.querySelector('input[type="radio"]');
        
        // Update radio button
        radioInput.checked = true;
        
        // Update visual feedback
        document.querySelectorAll('.orientation-card').forEach(c => {
          c.classList.remove('selected');
        });
        this.classList.add('selected');
        
        console.log('Selected orientation:', orientation);
      });
    });
    
    // Also handle radio button changes
    orientationInputs.forEach(input => {
      input.addEventListener('change', function() {
        const orientation = this.value;
        const card = this.closest('.orientation-card');
        
        // Update visual feedback
        document.querySelectorAll('.orientation-card').forEach(c => {
          c.classList.remove('selected');
        });
        card.classList.add('selected');
        
        console.log('Selected orientation:', orientation);
      });
    });

  // Update file counters
['videos','images','audios','subtitle'].forEach(function(id) {
  const input = document.getElementById(id);
  const countSpan = document.getElementById(id === 'subtitle' ? 'subtitle-count' : id.replace('s','')+'-count');
  if (input && countSpan) {
    input.addEventListener('change', function() {
      if (id === 'subtitle') {
        countSpan.textContent = input.files.length > 0 ? 1 : 0;
      } else {
        countSpan.textContent = input.files.length;
      }
      });
    }
  });

  // Handle form submission with AJAX
  const uploadForm = document.getElementById('uploadForm');
  const resultBlock = document.getElementById('result-video-block');
  
  if (uploadForm) {
    uploadForm.addEventListener('submit', function(e) {
      const videoFiles = document.getElementById('videos').files;
      const imageFiles = document.getElementById('images').files;
      const audioFiles = document.getElementById('audios').files;
      const galVideos = document.querySelectorAll('input[name="gallery_videos[]"]');
      const galImages = document.querySelectorAll('input[name="gallery_images[]"]');
      const galAudios = document.querySelectorAll('input[name="gallery_audios[]"]');
      if (
        videoFiles.length === 0 && galVideos.length === 0 &&
        imageFiles.length === 0 && galImages.length === 0 &&
        audioFiles.length === 0 && galAudios.length === 0
      ) {
        e.preventDefault();
        alert('Pilih minimal satu file dari galeri atau upload manual!');
        return false;
      }
      e.preventDefault();
      const formData = new FormData(uploadForm);
      
      // Show loading state dengan progress indicator
      resultBlock.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border"></div>
          <p class="mt-3">Sedang memproses video...</p>
          <div class="progress mt-3" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: 0%" 
                 id="progress-bar">0%</div>
          </div>
          <p class="mt-2 text-muted">Proses ini mungkin memakan waktu 2-5 menit tergantung ukuran file</p>
          <p class="text-info"><small>üí° Jika halaman terputus, gunakan tombol "Cek Status Video" untuk melihat hasil</small></p>
          <div class="mt-3">
            <button class="btn btn-outline-info" onclick="checkLatestVideo()">Cek Status Video</button>
            <button class="btn btn-outline-warning ms-2" onclick="toggleAutoCheck()" id="auto-check-btn">Auto Cek: OFF</button>
          </div>
        </div>
      `;
      
      // Auto-start auto-check after 10 seconds
      setTimeout(() => {
        if (!isAutoChecking) {
          toggleAutoCheck();
        }
      }, 10000);
      resultBlock.style.display = 'block';
      
      // Simulasi progress bar (opsional)
      let progress = 0;
      const progressBar = document.getElementById('progress-bar');
      const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90; // Jangan sampai 100% sampai selesai
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
      }, 2000);

      // Submit via AJAX dengan timeout yang lebih pendek dan polling
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 60000); // 1 menit timeout untuk upload
      
      // Generate project ID untuk tracking
      const projectId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      
      fetch('/video_gabung/upload?ajax=1', {
        method: 'POST',
        body: formData,
        signal: controller.signal
      })
      .then(response => {
        clearTimeout(timeoutId);
        clearInterval(progressInterval);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success && data.result_filename) {
          // Stop auto-check if running
          if (isAutoChecking) {
            clearInterval(autoCheckInterval);
            isAutoChecking = false;
            const btn = document.getElementById('auto-check-btn');
            if (btn) {
              btn.textContent = 'Auto Cek: OFF';
              btn.className = 'btn btn-outline-warning ms-2';
            }
          }
          
          // Play notification sound (optional)
          try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
            audio.play();
          } catch (e) {
            // Ignore audio errors
          }
          
          // Show result video
          resultBlock.innerHTML = `
            <div class="alert alert-success">
              <h5>‚úÖ Video Berhasil Dibuat!</h5>
              <p>${data.message || 'Video gabungan telah selesai diproses.'}</p>
            </div>
            <h4 class="fw-bold mb-3">Hasil Video Gabungan</h4>
            <video controls style="max-width:100%;" onloadedmetadata="checkVideoOrientation(this)">
              <source src="/static/results/${data.result_filename}" type="video/mp4">
              Browser Anda tidak mendukung video.
            </video>
            <div class="mt-3">
              <a href="/video_gabung/download/${data.result_filename}" class="btn btn-primary">
                <i class="fas fa-download me-2"></i>Download Video
              </a>
              <button class="btn btn-outline-secondary ms-2" onclick="location.reload()">
                <i class="fas fa-redo me-2"></i>Buat Video Baru
              </button>
            </div>
          `;
        } else {
          resultBlock.innerHTML = `
            <div class="alert alert-danger">
              <h5>‚ùå Gagal Memproses Video</h5>
              <p>${data.error || data.message || 'Gagal memproses video'}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        clearTimeout(timeoutId);
        clearInterval(progressInterval);
        let errorMessage = 'Terjadi kesalahan saat memproses video';
        
        if (error.name === 'AbortError') {
          errorMessage = 'Upload timeout. Proses video mungkin masih berjalan di server.';
          // Mulai polling untuk cek status
          startPolling(projectId);
        } else if (error.message.includes('HTTP 524') || error.message.includes('Network response was not ok')) {
          errorMessage = 'Server timeout. Proses video mungkin masih berjalan di backend.';
          // Mulai polling untuk cek status
          startPolling(projectId);
        } else {
          errorMessage = `Error: ${error.message}`;
        }
        
        resultBlock.innerHTML = `
          <div class="alert alert-warning">
            <h5>‚ö†Ô∏è Proses Video Terputus</h5>
            <p>${errorMessage}</p>
            <p><strong>Tips:</strong></p>
            <ul>
              <li>Proses video mungkin masih berjalan di server</li>
              <li>Sistem akan mengecek status secara otomatis</li>
              <li>Atau gunakan tombol "Cek Hasil Video"</li>
            </ul>
            <button class="btn btn-primary" onclick="location.reload()">Refresh Halaman</button>
            <button class="btn btn-info ms-2" onclick="checkLatestVideo()">Cek Hasil Video</button>
          </div>
        `;
      });
      
      // Function untuk polling status
      function startPolling(projectId) {
        let pollCount = 0;
        const maxPolls = 60; // Poll selama 5 menit (60 x 5 detik)
        
        const pollInterval = setInterval(() => {
          pollCount++;
          
          fetch(`/video_gabung/api/upload_status/${projectId}`)
            .then(response => response.json())
            .then(data => {
              if (data.success && data.status === 'completed') {
                clearInterval(pollInterval);
                // Video selesai, tampilkan hasil
                resultBlock.innerHTML = `
                  <div class="alert alert-success">
                    <h5>‚úÖ Video Berhasil Dibuat!</h5>
                    <p>${data.message}</p>
                  </div>
                  <h4 class="fw-bold mb-3">Hasil Video Gabungan</h4>
                  <video controls style="max-width:100%;" onloadedmetadata="checkVideoOrientation(this)">
                    <source src="/static/results/${data.result_filename}" type="video/mp4">
                    Browser Anda tidak mendukung video.
                  </video>
                  <div class="mt-3">
                    <a href="/video_gabung/download/${data.result_filename}" class="btn btn-primary">
                      <i class="fas fa-download me-2"></i>Download Video
                    </a>
                    <button class="btn btn-outline-secondary ms-2" onclick="location.reload()">
                      <i class="fas fa-redo me-2"></i>Buat Video Baru
                    </button>
                  </div>
                `;
              } else if (pollCount >= maxPolls) {
                clearInterval(pollInterval);
                // Timeout polling
                resultBlock.innerHTML = `
                  <div class="alert alert-info">
                    <h5>‚è≥ Proses Video Memakan Waktu Lama</h5>
                    <p>Video masih dalam proses. Silakan cek lagi nanti.</p>
                    <button class="btn btn-primary" onclick="checkLatestVideo()">Cek Hasil Video</button>
                  </div>
                `;
              }
            })
            .catch(error => {
              console.log('Polling error:', error);
              if (pollCount >= maxPolls) {
                clearInterval(pollInterval);
              }
            });
        }, 5000); // Poll setiap 5 detik
      }
    });
  }

  // Modal galeri logic (fetch from backend, fallback dummy)
  let galleryType = '';
  document.getElementById('btn-gallery-video').onclick = function() {
    galleryType = 'video';
    showGalleryModal();
  };
  document.getElementById('btn-gallery-image').onclick = function() {
    galleryType = 'image';
    showGalleryModal();
  };
  document.getElementById('btn-gallery-audio').onclick = function() {
    galleryType = 'audio';
    showGalleryModal();
  };

  
  function selectGalleryItem(idx) {
    console.log('selectGalleryItem called with idx:', idx);
    
    // Find the clicked thumbnail
    const thumb = document.querySelector(`[data-idx="${idx}"]`);
    if (!thumb) {
      console.log('Thumbnail not found for idx:', idx);
      return;
    }
    
    console.log('Found thumbnail:', thumb);
    const isSelected = thumb.classList.contains('selected');
    
    // Clear all selections first (single selection mode)
    document.querySelectorAll('.gallery-thumb').forEach(t => {
      t.classList.remove('selected');
    });
    
    // Select current item
    if (!isSelected) {
      thumb.classList.add('selected');
      console.log('Selected thumbnail:', thumb);
      
      // Auto-close modal and process selection after a short delay
      setTimeout(() => {
        var modal = bootstrap.Modal.getInstance(document.getElementById('galleryModal'));
        modal.hide();
        processGallerySelection();
      }, 300);
    }
  }
  
  function processGallerySelection() {
    console.log('processGallerySelection called');
    
    // Ambil semua yang dipilih (tanpa checkbox)
    const selected = Array.from(document.querySelectorAll('#gallery-grid .gallery-thumb.selected')).map(thumb => {
      const hiddenInput = thumb.querySelector('input[type="hidden"]');
      return hiddenInput ? hiddenInput.value : null;
    }).filter(val => val !== null);
    
    console.log('Selected items:', selected);
    
    // Simpan ke hidden input sesuai tipe galeri
    if (galleryType === 'video') {
      setGalleryHidden('gallery_videos', selected);
    } else if (galleryType === 'image') {
      setGalleryHidden('gallery_images', selected);
    } else if (galleryType === 'audio') {
      setGalleryHidden('gallery_audios', selected);
    }
    
    // Tampilkan notifikasi
    if (selected.length > 0) {
      const itemName = selected[0].split('/').pop().split('.')[0]; // Ambil nama file tanpa ekstensi
      const displayName = itemName.length > 20 ? itemName.substring(0, 20) + '...' : itemName;
      showNotification(`Berhasil memilih ${galleryType}: ${displayName}`, 'success');
    }
  }
  
  function showGalleryModal() {
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = `<div class='text-center w-100'><div class='spinner-border'></div><div>Memuat galeri...</div></div>`;
    fetch(`/video_gabung/api/gallery?type=${galleryType}`)
      .then(res => res.json())
      .then(data => {
        grid.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          grid.innerHTML = `<div class='text-center w-100 text-muted'>Galeri kosong.</div>`;
          return;
        }
        // Data sudah diurutkan dari terbaru di backend
        data.forEach((item, idx) => {
          let html = '';
          if (galleryType === 'video') {
            html = `<div class='gallery-thumb' data-idx='${idx}' data-src='${item.src}'>
              <video src='${item.src}' class='gallery-video' preload='metadata'></video>
              <input type='hidden' value='${item.src}'>
              <div class='gallery-name'>${item.name}</div>
            </div>`;
          } else if (galleryType === 'image') {
            html = `<div class='gallery-thumb' data-idx='${idx}' data-src='${item.src}'>
              <img src='${item.src}' class='gallery-img'/>
              <input type='hidden' value='${item.src}'>
              <div class='gallery-name'>${item.name}</div>
            </div>`;
          } else if (galleryType === 'audio') {
            html = `<div class='gallery-thumb' data-idx='${idx}' data-src='${item.src}'>
              <img src='${item.image_url || '/static/assets/image/default.jpg'}' class='gallery-audio'/>
              <input type='hidden' value='${item.src}'>
              <div class='gallery-name'>${item.name}</div>
            </div>`;
          }
          grid.innerHTML += html;
        });
        
        // Add event listeners after HTML is added
        document.querySelectorAll('.gallery-thumb').forEach(thumb => {
          thumb.addEventListener('click', function() {
            const idx = this.getAttribute('data-idx');
            selectGalleryItem(idx);
          });
        });
      })
      .catch(() => {
        // Fallback dummy jika gagal fetch
        const dummy = {
          video: [
            {src: '/static/assets/video/feeds/1.mp4', name: 'Video 1'},
            {src: '/static/assets/video/feeds/2.mp4', name: 'Video 2'}
          ],
          image: [
            {src: '/static/assets/image/feeds/1.jpg', name: 'Gambar 1'},
            {src: '/static/assets/image/feeds/2.jpg', name: 'Gambar 2'}
          ],
          audio: [
            {src: '/static/audio_results/10ca3628b07440be9cf96cde74aad6b1.mp3', name: 'Audio 1'}
          ]
        };
        grid.innerHTML = '';
        dummy[galleryType].forEach((item, idx) => {
          let html = '';
          if (galleryType === 'video') {
            html = `<div class='gallery-thumb' data-idx='${idx}' data-src='${item.src}'>
              <video src='${item.src}' class='gallery-video' preload='metadata'></video>
              <input type='hidden' value='${item.src}'>
              <div class='gallery-name'>${item.name}</div>
            </div>`;
          } else if (galleryType === 'image') {
            html = `<div class='gallery-thumb' data-idx='${idx}' data-src='${item.src}'>
              <img src='${item.src}' class='gallery-img'/>
              <input type='hidden' value='${item.src}'>
              <div class='gallery-name'>${item.name}</div>
            </div>`;
          } else if (galleryType === 'audio') {
            html = `<div class='gallery-thumb' data-idx='${idx}' data-src='${item.src}'>
              <img src='${item.image_url || '/static/assets/image/default.jpg'}' class='gallery-audio'/>
              <input type='hidden' value='${item.src}'>
              <div class='gallery-name'>${item.name}</div>
            </div>`;
          }
          grid.innerHTML += html;
        });
        
        // Add event listeners for fallback data
        document.querySelectorAll('.gallery-thumb').forEach(thumb => {
          thumb.addEventListener('click', function() {
            const idx = this.getAttribute('data-idx');
            selectGalleryItem(idx);
          });
        });
      });
    var modal = new bootstrap.Modal(document.getElementById('galleryModal'));
    modal.show();
  }
  document.getElementById('btn-select-gallery').onclick = function() {
    // Ambil semua yang dicentang
    const checked = Array.from(document.querySelectorAll('#gallery-grid input:checked')).map(i => i.value);
    // Simpan ke hidden input (nanti diintegrasi ke backend)
    if (galleryType === 'video') {
      setGalleryHidden('gallery_videos', checked);
    } else if (galleryType === 'image') {
      setGalleryHidden('gallery_images', checked);
    } else if (galleryType === 'audio') {
      setGalleryHidden('gallery_audios', checked);
    }
    // Tutup modal
    var modal = bootstrap.Modal.getInstance(document.getElementById('galleryModal'));
    modal.hide();
  };
  function setGalleryHidden(name, values) {
    // Hapus input lama
    document.querySelectorAll('input[name="' + name + '[]"]').forEach(e => e.remove());
    // Tambah input baru
    const form = document.getElementById('uploadForm');
    values.forEach(v => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name + '[]';
      input.value = v;
      form.appendChild(input);
    });
  }
  

  // Load database videos on page load
  console.log('Page loaded, calling loadDbVideosList...');
  loadDbVideosList();
  
  // Function to check video orientation and apply appropriate styling
  window.checkVideoOrientation = function(videoElement) {
    if (videoElement.videoWidth && videoElement.videoHeight) {
      const isPortrait = videoElement.videoHeight > videoElement.videoWidth;
      if (isPortrait) {
        videoElement.setAttribute('data-orientation', 'portrait');
        videoElement.style.objectFit = 'contain';
        videoElement.style.backgroundColor = '#000';
        
        // Add fullscreen event listeners for portrait videos
        videoElement.addEventListener('fullscreenchange', handleFullscreenChange);
        videoElement.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        videoElement.addEventListener('mozfullscreenchange', handleFullscreenChange);
      } else {
        videoElement.setAttribute('data-orientation', 'landscape');
        videoElement.style.objectFit = 'cover';
      }
    }
  };
  
  // Handle fullscreen changes for portrait videos
  function handleFullscreenChange() {
    const video = this;
    const isPortrait = video.getAttribute('data-orientation') === 'portrait';
    
    if (isPortrait) {
      if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
        // Entering fullscreen
        video.style.objectFit = 'contain';
        video.style.width = 'auto';
        video.style.height = 'auto';
        video.style.maxWidth = '100vw';
        video.style.maxHeight = '100vh';
        video.style.backgroundColor = '#000';
      } else {
        // Exiting fullscreen
        video.style.objectFit = 'contain';
        video.style.width = '100%';
        video.style.height = '180px';
        video.style.maxWidth = 'none';
        video.style.maxHeight = 'none';
        video.style.backgroundColor = '#000';
      }
    }
  }
  
  // Auto-check variables
  let autoCheckInterval = null;
  let isAutoChecking = false;
  
  // Function to toggle auto-check
  window.toggleAutoCheck = function() {
    const btn = document.getElementById('auto-check-btn');
    if (isAutoChecking) {
      // Stop auto-check
      clearInterval(autoCheckInterval);
      isAutoChecking = false;
      btn.textContent = 'Auto Cek: OFF';
      btn.className = 'btn btn-outline-warning ms-2';
    } else {
      // Start auto-check
      autoCheckInterval = setInterval(checkLatestVideo, 30000); // Check every 30 seconds
      isAutoChecking = true;
      btn.textContent = 'Auto Cek: ON';
      btn.className = 'btn btn-warning ms-2';
    }
  }
  
  // Function to check latest video result
  window.checkLatestVideo = function() {
    const resultBlock = document.getElementById('result-video-block');
    
    // Show loading state
    resultBlock.innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border"></div>
        <p class="mt-3">Mengecek hasil video...</p>
      </div>
    `;
    resultBlock.style.display = 'block';
    
    fetch('/video_gabung/api/check_latest_video')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.has_latest_video && data.file_exists) {
          // Stop auto-check if running
          if (isAutoChecking) {
            clearInterval(autoCheckInterval);
            isAutoChecking = false;
            const btn = document.getElementById('auto-check-btn');
            if (btn) {
              btn.textContent = 'Auto Cek: OFF';
              btn.className = 'btn btn-outline-warning ms-2';
            }
          }
          
          // Play notification sound (optional)
          try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
            audio.play();
          } catch (e) {
            // Ignore audio errors
          }
          
          // Show result video
          resultBlock.innerHTML = `
            <div class="alert alert-success">
              <h5>‚úÖ Video Berhasil Ditemukan!</h5>
              <p>Video telah selesai diproses dan siap untuk didownload.</p>
            </div>
            <h4 class="fw-bold mb-3">Hasil Video Gabungan</h4>
            <video controls style="max-width:100%;" onloadedmetadata="checkVideoOrientation(this)">
              <source src="/static/results/${data.video_url}" type="video/mp4">
              Browser Anda tidak mendukung video.
            </video>
            <div class="mt-3">
              <a href="/video_gabung/download/${data.video_url}" class="btn btn-primary">
                <i class="fas fa-download me-2"></i>Download Video
              </a>
              <button class="btn btn-outline-secondary ms-2" onclick="location.reload()">
                <i class="fas fa-redo me-2"></i>Buat Video Baru
              </button>
              <span class="ms-2 text-muted">Dibuat: ${data.created_at}</span>
            </div>
          `;
        } else {
          resultBlock.innerHTML = `
            <div class="alert alert-info">
              <h5>‚è≥ Video Belum Selesai</h5>
              <p>Video masih dalam proses atau belum ditemukan. Silakan tunggu beberapa saat lagi.</p>
              <button class="btn btn-primary" onclick="checkLatestVideo()">Cek Lagi</button>
            </div>
          `;
        }
      })
      .catch(error => {
        resultBlock.innerHTML = `
          <div class="alert alert-danger">
            <h5>‚ùå Gagal Mengecek Video</h5>
            <p>Error: ${error.message}</p>
            <button class="btn btn-primary" onclick="checkLatestVideo()">Coba Lagi</button>
          </div>
        `;
      });
  }
});
</script>
{% endblock %}