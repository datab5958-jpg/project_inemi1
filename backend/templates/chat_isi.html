{% extends "base.html" %}

{% block content %}
<style>
  body, .bg-dark-gradient {
    background: linear-gradient(135deg, #181c2b 0%, #232946 100%) !important;
    min-height: 100vh;
  }
  
  /* Force solid backgrounds for iOS */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    body, .bg-dark-gradient {
      background: #181c2b !important;
    }
  }
  .chat-container {
    height: calc(100vh - 120px);
    display: flex;
    flex-direction: column;
  }
  .chat-header {
    background: rgba(35,41,70,0.95);
    border-bottom: 1px solid #343a40;
    padding: 1.2rem 1.5rem;
    border-radius: 1.5rem 1.5rem 0 0;
    box-shadow: 0 4px 32px #23294633;
    backdrop-filter: blur(6px) saturate(1.2);
    -webkit-backdrop-filter: blur(6px) saturate(1.2);
  }
  
  /* Force solid background for iOS */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .chat-header {
      background: #232946 !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }
  }
  
  /* iOS Safari fallback untuk backdrop-filter */
  @supports not (backdrop-filter: blur(6px)) {
    .chat-header {
      background: #232946 !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      opacity: 1 !important;
    }
  }
  
  /* Deteksi iOS Safari */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .chat-header {
      background: #232946 !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      opacity: 1 !important;
    }
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    background: transparent;
    border-radius: 0 0 1.5rem 1.5rem;
    box-shadow: 0 2px 32px #23294622;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }
  
  /* iOS Safari fallback untuk chat-messages */
  @supports not (backdrop-filter: blur(2px)) {
    .chat-messages {
      background: #181c2b !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      opacity: 1 !important;
    }
  }
  
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .chat-messages {
      background: #181c2b !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      opacity: 1 !important;
    }
  }
  .message {
    display: flex;
    align-items: flex-start;
    animation: fadeInUp 0.5s cubic-bezier(.22,1,.36,1);
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .message.user {
    justify-content: flex-end;
  }
  .message.bot {
    justify-content: flex-start;
  }
  .message-content {
    max-width: 70%;
    padding: 1rem 1.3rem;
    border-radius: 1.2rem;
    word-wrap: break-word;
    box-shadow: 0 2px 16px #23294622;
    font-size: 1.08rem;
    backdrop-filter: blur(2px) saturate(1.2);
    -webkit-backdrop-filter: blur(2px) saturate(1.2);
  }
  
  /* iOS Safari fallback untuk message-content */
  @supports not (backdrop-filter: blur(2px)) {
    .message-content {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
  }
  
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .message-content {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
  }
  .message.user .message-content {
    background: linear-gradient(120deg, #6c63ff 60%, #ff4ecd 100%);
    color: white;
    border-bottom-right-radius: 0.4rem;
    box-shadow: 0 2px 16px #6c63ff44;
  }
  .message.bot .message-content {
    background: rgba(52,58,64,0.85);
    color: #eaeaea;
    border-bottom-left-radius: 0.4rem;
    box-shadow: 0 2px 16px #343a4044;
  }
  .chat-input-container {
    background: transparent;
    padding: 2rem 0 0 0;
    border-radius: 0 0 1.5rem 1.5rem;
    position: sticky;
    bottom: 0;
    z-index: 10;
  }
  .input-bar-glass {
    background: rgba(35,41,70,0.95);
    border: 1.5px solid #6c63ff44;
    border-radius: 2.5rem;
    box-shadow: 0 4px 32px #6c63ff22;
    display: flex;
    align-items: center;
    padding: 0.5rem 1.2rem 0.5rem 1.2rem;
    gap: 0.7rem;
    transition: box-shadow 0.2s, border-color 0.2s;
    backdrop-filter: blur(8px) saturate(1.2);
    -webkit-backdrop-filter: blur(8px) saturate(1.2);
  }
  
  /* Force solid background for iOS */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .input-bar-glass {
      background: #232946 !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }
  }
  
  /* iOS Safari fallback untuk input-bar-glass */
  @supports not (backdrop-filter: blur(8px)) {
    .input-bar-glass {
      background: #232946 !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      opacity: 1 !important;
    }
  }
  
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .input-bar-glass {
      background: #232946 !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      opacity: 1 !important;
    }
  }
  .input-bar-glass:focus-within {
    border-color: #ff4ecd;
    box-shadow: 0 0 0 3px #ff4ecd44;
  }
  .prompt-type-selector {
    background: #181c2b;
    border: 1px solid #343a40;
    color: #eaeaea;
    border-radius: 0.7rem;
    padding: 0.5rem 1.2rem;
    margin-right: 0.7rem;
    font-size: 1.05rem;
    min-width: 140px;
    box-shadow: 0 2px 8px #23294622;
  }
  .chat-input {
    background: transparent;
    border: none;
    color: #eaeaea;
    font-size: 1.08rem;
    flex: 1;
    outline: none;
    padding: 0.7rem 0.5rem;
  }
  .chat-input::placeholder {
    color: #bcbcbc;
    opacity: 0.8;
  }
  .btn-generate {
    background: linear-gradient(135deg, #6c63ff, #ff4ecd);
    border: none;
    border-radius: 2rem;
    padding: 0.7rem 1.7rem;
    color: white;
    font-weight: 600;
    font-size: 1.08rem;
    box-shadow: 0 2px 12px #6c63ff33;
    transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-generate:hover {
    transform: translateY(-2px) scale(1.04);
    box-shadow: 0 4px 16px #ff4ecd55;
    background: linear-gradient(135deg, #ff4ecd, #6c63ff);
  }
  .btn-generate:disabled {
    opacity: 0.6;
    transform: none;
    box-shadow: none;
  }
  .btn-mic {
    background: linear-gradient(135deg, #232946 60%, #6c63ff 100%);
    border: none;
    color: #fff;
    border-radius: 50%;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    margin-right: 0.3rem;
    box-shadow: 0 2px 8px #6c63ff33;
    transition: background 0.2s, box-shadow 0.2s;
    cursor: pointer;
    outline: none;
  }
  .btn-mic.active, .btn-mic:active {
    background: linear-gradient(135deg, #ff4ecd 60%, #6c63ff 100%);
    color: #fff;
    box-shadow: 0 0 0 4px #ff4ecd44;
    animation: pulseMic 1.2s infinite;
  }
  @keyframes pulseMic {
    0% { box-shadow: 0 0 0 4px #ff4ecd44; }
    50% { box-shadow: 0 0 0 10px #ff4ecd22; }
    100% { box-shadow: 0 0 0 4px #ff4ecd44; }
  }
  .prompt-result {
    background: rgba(35,41,70,0.85);
    border: 1px solid #343a40;
    border-radius: 1rem;
    padding: 1.2rem 1rem 1rem 1rem;
    margin-top: 1.2rem;
    display: none;
    box-shadow: 0 2px 16px #6c63ff22;
    animation: fadeInUp 0.5s cubic-bezier(.22,1,.36,1);
  }
  .prompt-result.show {
    display: block;
  }
  .copy-btn {
    background: #6c63ff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    color: white;
    font-size: 0.95rem;
    transition: background 0.2s;
  }
  .copy-btn:hover {
    background: #5a52d5;
  }
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #6c63ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .typing-indicator {
    display: none;
    padding: 0.75rem 1rem;
    background: #343a40;
    border-radius: 1rem;
    border-bottom-left-radius: 0.25rem;
    color: #eaeaea;
    font-style: italic;
  }
  .typing-indicator.show {
    display: block;
  }
  .song-title {
    font-size: 1.25rem;
    font-weight: 800;
    /* background: linear-gradient(90deg, #6c63ff, #ff4ecd, #fb923c); */
    background: linear-gradient(90deg, #dddde0, #f7e0f0, #e4d7cc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
    margin-bottom: 0.2em;
    letter-spacing: 0.5px;
  }
  .song-genre {
    display: inline-block;
    background: linear-gradient(90deg, #fb923c, #6c63ff);
    color: #fff;
    font-size: 1.02rem;
    font-weight: 700;
    border-radius: 1em;
    padding: 0.18em 1em;
    margin-bottom: 0.5em;
    margin-right: 0.2em;
    box-shadow: 0 2px 8px #6c63ff22;
    letter-spacing: 0.2px;
  }
  .inemi-gradient-text-chat {
    background: linear-gradient(90deg, #3b82f6 0%, #a78bfa 30%, #f472b6 60%, #fb7185 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
  }
  @media (max-width: 900px) {
    .chat-header, .chat-messages, .chat-input-container { padding-left: 0.5rem; padding-right: 0.5rem; }
    .chat-header, .chat-messages { border-radius: 1rem 1rem 0 0; }
    .chat-input-container { border-radius: 0 0 1rem 1rem; }
  }
  /* iOS Safari specific fixes - More solid backgrounds */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    body, .bg-dark-gradient {
      background: #181c2b !important;
      -webkit-background-attachment: scroll !important;
      background-attachment: scroll !important;
    }
    
    .chat-header {
      background: #232946 !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      opacity: 1 !important;
    }
    
    .chat-messages {
      background: #181c2b !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      opacity: 1 !important;
    }
    
    .input-bar-glass {
      background: #232946 !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      opacity: 1 !important;
    }
    
    .message-content {
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }
    
    .message.user .message-content {
      background: linear-gradient(120deg, #6c63ff 60%, #ff4ecd 100%) !important;
      opacity: 1 !important;
    }
    
    .message.bot .message-content {
      background: #343a40 !important;
      opacity: 1 !important;
    }
  }

  @media (max-width: 600px) {
    .chat-container {
      height: auto;
      min-height: 100vh;
      padding: 0;
    }
    .chat-header, .chat-messages, .chat-input-container {
      padding-left: 0.2rem;
      padding-right: 0.2rem;
    }
    .chat-header, .chat-messages {
      border-radius: 0.7rem 0.7rem 0 0;
    }
    .chat-messages {
      padding: 1rem 0.2rem 1rem 0.2rem;
      font-size: 0.97rem;
    }
    .message-content {
      max-width: 98vw;
      font-size: 0.97rem;
      padding: 0.7rem 0.7rem;
    }
    .input-bar-glass {
      flex-direction: row !important;
      gap: 0.3rem;
      padding: 0.4rem 0.3rem;
      align-items: center;
    }
    .prompt-type-selector {
      min-width: 0;
      width: 32vw;
      font-size: 0.97rem;
      padding: 0.4rem 0.5rem;
      margin-right: 0.2rem;
    }
    .btn-mic {
      width: 2.2rem;
      height: 2.2rem;
      font-size: 1.1rem;
      margin: 0 0.1rem 0 0;
      padding: 0;
      flex-shrink: 0;
    }
    .chat-input {
      font-size: 0.97rem;
      padding: 0.5rem 0.3rem;
      min-width: 0;
      width: 100%;
      flex: 1 1 0;
    }
    .btn-generate {
      width: auto;
      min-width: 70px;
      font-size: 1rem;
      padding: 0.6rem 1.1rem;
      border-radius: 1.2rem;
      margin-left: 0.1rem;
      flex-shrink: 0;
    }
    .song-title {
      font-size: 1.05rem;
    }
    .song-genre {
      font-size: 0.95rem;
      padding: 0.13em 0.7em;
    }
  }
.option-tag-group {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.2rem;
  flex-wrap: wrap;
}
.option-tag-btn {
  background: transparent;
  color: #fff;
  border: 2px solid;
  border-image-slice: 1;
  border-radius: 2rem;
  padding: 0.7rem 1.5rem;
  font-size: 1.08rem;
  font-weight: 600;
  box-shadow: 0 2px 12px #6c63ff22;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.15s, border-color 0.2s;
  outline: none;
  letter-spacing: 0.5px;
  position: relative;
  opacity: 0.85;
}
.option-tag-btn.active, .option-tag-btn:focus {
  background: linear-gradient(90deg, #6c63ff 0%, #ff4ecd 100%);
  color: #fff;
  box-shadow: 0 0 16px #ff4ecd99, 0 2px 12px #6c63ff44;
  border-color: #ff4ecd;
  transform: scale(1.06);
  z-index: 1;
  opacity: 1;
}
  .option-tag-btn:hover {
    border-color: #ff4ecd;
    color: #fff;
    box-shadow: 0 0 12px #6c63ff99;
    transform: scale(1.04);
    opacity: 1;
  }
  
  /* Additional iOS fixes to ensure no transparency */
  @media screen and (-webkit-min-device-pixel-ratio: 0) {
    .container-fluid {
      background: #181c2b !important;
    }
    
    .chat-container {
      background: #181c2b !important;
    }
    
    .option-tag-group {
      background: transparent !important;
    }
    
    .option-tag-btn {
      background: transparent !important;
      opacity: 1 !important;
    }
    
    .option-tag-btn.active {
      background: linear-gradient(90deg, #6c63ff 0%, #ff4ecd 100%) !important;
      opacity: 1 !important;
    }
  }
</style>

<div class="container-fluid h-100">
  <div class="row h-100">
    <div class="col-12 col-md-8 mx-auto">
      <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="d-flex align-items-center">
            <img src="/static/logo/logo.png" width="48" height="48" class="me-3" alt="Logo Inemi" style="background:#fff;border-radius:1.2rem;padding:4px;box-shadow:0 2px 12px #23294644;">
            <div>
              <span class="inemi-gradient-text-chat" style="font-size:2rem;font-weight:800;letter-spacing:2px;vertical-align:middle;">INEMI</span>
              <div class="text-white mb-0" style="font-size:1.1rem;font-weight:600;">AI Chat Assistant</div>
              <small class="text-white">Generate prompt untuk musik, video, dan foto</small>
            </div>
          </div>
        </div>
        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
          <!-- Welcome Message -->
          <div class="message bot">
            <div class="message-content">
              <strong>Halo! ðŸ‘‹</strong><br>
              Saya adalah AI assistant yang bisa membantu Anda membuat prompt yang akurat untuk:
              <ul class="mb-0 mt-2">
                <li>ðŸŽµ <strong>Musik</strong> - Prompt untuk Musik</li>
                <li>ðŸŽ¬ <strong>Video</strong> - Prompt untuk AI video generator</li>
                <li>ðŸ“¸ <strong>Foto</strong> - Prompt untuk AI image generator</li>
              </ul>
              <br>
              Silakan pilih tipe prompt dan berikan deskripsi yang Anda inginkan!
            </div>
          </div>
        </div>
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
          <span class="loading me-2"></span>
          AI sedang memproses...
        </div>
        <!-- Chat Input -->
        <div class="chat-input-container">
          <form id="chatForm">
            <!-- Ganti select+option dengan button group -->
            <div class="option-tag-group" id="mediaTypeGroup">
              <button type="button" class="option-tag-btn active" data-value="music">ðŸŽµ Musik</button>
              <button type="button" class="option-tag-btn" data-value="video">ðŸŽ¬ Video</button>
              <button type="button" class="option-tag-btn" data-value="photo">ðŸ“¸ Foto</button>
            </div>
            <input type="hidden" name="prompt_type" id="promptType" value="music">
            <div class="input-bar-glass">
              <button type="button" class="btn-mic" id="micBtn" title="Voice Input"><i class="bi bi-mic-fill"></i></button>
              <input type="text" class="chat-input" id="userInput" placeholder="Deskripsi yang Anda inginkan... (contoh: lagu pop yang ceria)" autocomplete="off">
              <!-- Lampiran File Mulai -->
              <input type="file" id="attachmentInput" class="d-none" multiple accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt">
              <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="attachBtn" title="Lampirkan file"><i class="bi bi-paperclip"></i></button>
              <span id="attachmentList" class="ms-2 small text-info"></span>
              <!-- Lampiran File Selesai -->
              <button type="submit" class="btn btn-generate" id="sendBtn">
                <span class="btn-text">Kirim</span>
                <span class="loading d-none" id="sendLoading"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variables
let currentPrompt = '';
let recognition;
let recognizing = false;
let isVoiceSubmitting = false;

// DOM elements
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const promptType = document.getElementById('promptType');
const sendBtn = document.getElementById('sendBtn');
const sendLoading = document.getElementById('sendLoading');
const btnText = document.querySelector('.btn-text');
const chatMessages = document.getElementById('chatMessages');
const typingIndicator = document.getElementById('typingIndicator');
const promptResult = document.getElementById('promptResult');
const generatedPrompt = document.getElementById('generatedPrompt');
const micBtn = document.getElementById('micBtn');

// Proteksi agar event listener tidak dipasang dua kali
if (!window._chatSubmitAttached) {
  chatForm.addEventListener('submit', handleSubmit);
  window._chatSubmitAttached = true;
}

// Voice input setup
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'id-ID';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = function() {
    recognizing = true;
    micBtn.classList.add('active');
    micBtn.title = 'Merekam... klik untuk stop';
  };
  recognition.onend = function() {
    recognizing = false;
    micBtn.classList.remove('active');
    micBtn.title = 'Voice Input';
  };
  recognition.onerror = function(e) {
    recognizing = false;
    micBtn.classList.remove('active');
    micBtn.title = 'Voice Input';
    alert('Voice input error: ' + e.error);
  };
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    userInput.value = transcript;
    userInput.focus();
    setTimeout(() => {
      if (userInput.value.trim() && !isVoiceSubmitting) {
        isVoiceSubmitting = true;
        chatForm.requestSubmit();
      }
    }, 100);
  };

  micBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (recognizing) {
      recognition.stop();
    } else {
      recognition.start();
    }
  });
} else {
  micBtn.disabled = true;
  micBtn.title = 'Voice input tidak didukung di browser ini';
}

// Lampiran file
const attachBtn = document.getElementById('attachBtn');
const attachmentInput = document.getElementById('attachmentInput');
const attachmentList = document.getElementById('attachmentList');
let selectedFiles = [];

attachBtn.addEventListener('click', function(e) {
  e.preventDefault();
  attachmentInput.click();
});
attachmentInput.addEventListener('change', function() {
  selectedFiles = Array.from(attachmentInput.files);
  if (selectedFiles.length > 0) {
    attachmentList.textContent = selectedFiles.map(f => f.name).join(', ');
  } else {
    attachmentList.textContent = '';
  }
});

// Event listeners
// Hapus event keypress pada userInput
// userInput.addEventListener('keypress', function(e) {
//   if (e.key === 'Enter' && !e.shiftKey) {
//     e.preventDefault();
//     handleSubmit(e);
//   }
// });

// Handle form submission
async function handleSubmit(e) {
  console.log('SUBMIT!');
  e.preventDefault();
  if (isVoiceSubmitting) {
    isVoiceSubmitting = false; // reset flag
    // lanjutkan submit voice, tapi jangan submit lagi
  } else if (recognizing) {
    // Jika sedang voice, jangan submit manual
    return;
  }
  const input = userInput.value.trim();
  const type = promptType.value;
  if (!input && selectedFiles.length === 0) {
    alert('Silakan masukkan deskripsi atau lampirkan file!');
    return;
  }
  setLoadingState(true);
  addMessage(input || '[Lampiran]', 'user');
  showTypingIndicator();
  try {
    let prompt;
    if (selectedFiles.length > 0) {
      // Kirim FormData
      const formData = new FormData();
      formData.append('input', input);
      formData.append('type', type);
      selectedFiles.forEach((file, idx) => {
        formData.append('attachments', file);
      });
      const endpoint = {
        'music': '/api/chat/generate-music-prompt',
        'video': '/api/chat/generate-video-prompt',
        'photo': '/api/chat/generate-photo-prompt'
      }[type];
      const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      if (result.success) {
        prompt = result.prompt;
      } else {
        console.error('API Error:', result.error);
        prompt = null;
      }
    } else {
      prompt = await generatePrompt(input, type);
    }
    if (prompt) {
      addMessageWithCopy(prompt, 'bot');
      currentPrompt = prompt;
    } else {
      addMessage('Maaf, terjadi kesalahan saat generate prompt. Silakan coba lagi.', 'bot');
    }
  } catch (error) {
    console.error('Error:', error);
    addMessage('Maaf, terjadi kesalahan. Silakan coba lagi.', 'bot');
  } finally {
    setLoadingState(false);
    hideTypingIndicator();
    userInput.value = '';
    userInput.focus();
    attachmentInput.value = '';
    selectedFiles = [];
    attachmentList.textContent = '';
  }
}

// Generate prompt using API
async function generatePrompt(input, type) {
  const endpoints = {
    'music': '/api/chat/generate-music-prompt',
    'video': '/api/chat/generate-video-prompt',
    'photo': '/api/chat/generate-photo-prompt'
  };
  const endpoint = endpoints[type];
  try {
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ input: input })
    });
    const result = await response.json();
    if (result.success) {
      return result.prompt;
    } else {
      console.error('API Error:', result.error);
      return null;
    }
  } catch (error) {
    console.error('Network Error:', error);
    return null;
  }
}

function addMessage(content, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  const contentDiv = document.createElement('div');
  contentDiv.className = 'message-content';
  contentDiv.innerHTML = content.replace(/\n/g, '<br>');
  messageDiv.appendChild(contentDiv);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function setLoadingState(loading) {
  if (loading) {
    sendBtn.disabled = true;
    btnText.style.display = 'none';
    sendLoading.classList.remove('d-none');
  } else {
    sendBtn.disabled = false;
    btnText.style.display = 'inline';
    sendLoading.classList.add('d-none');
  }
}
function showTypingIndicator() {
  typingIndicator.classList.add('show');
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function hideTypingIndicator() {
  typingIndicator.classList.remove('show');
}
function showPromptResult(prompt) {
  currentPrompt = prompt;
  generatedPrompt.textContent = prompt;
  promptResult.classList.add('show');
  setTimeout(() => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 100);
}
function addMessageWithCopy(content, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  const contentDiv = document.createElement('div');
  contentDiv.className = 'message-content position-relative';

  // Highlight judul dan genre jika bot
  if (sender === 'bot') {
    // Split lines
    const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
    let html = '';
    if (lines.length > 0) {
      html += `<span class="song-title">${lines[0]}</span>`;
    }
    if (lines.length > 1) {
      html += `<span class="song-genre">${lines[1]}</span><br>`;
    }
    if (lines.length > 2) {
      html += lines.slice(2).map(line => line).join('<br>');
    }
    contentDiv.innerHTML = html;
  } else {
    contentDiv.innerHTML = content.replace(/\n/g, '<br>');
  }

  if (sender === 'bot') {
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn btn-sm copy-btn position-absolute top-0 end-0 m-2';
    copyBtn.type = 'button';
    copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
    copyBtn.addEventListener('click', function() {
      // Ambil teks asli dari variabel content (bukan dari innerHTML)
      let text = content;
      // Hilangkan tag <br> jika ada
      text = text.replace(/<br\s*\/?>(\n)?/gi, '\n');
      // Hilangkan semua tag HTML
      text = text.replace(/<[^>]+>/g, '');
      // Hilangkan tanda ** (markdown bold)
      text = text.replace(/\*\*/g, '');
      // Hilangkan spasi ekstra di awal/akhir
      text = text.trim();
      // Salin ke clipboard
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          copyBtn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
          copyBtn.style.background = '#28a745';
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
            copyBtn.style.background = '#6c63ff';
          }, 2000);
        }, () => {
          alert('Gagal menyalin prompt. Silakan copy manual.');
        });
      } else {
        // Fallback untuk browser lama
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
          document.execCommand('copy');
          copyBtn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
          copyBtn.style.background = '#28a745';
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
            copyBtn.style.background = '#6c63ff';
          }, 2000);
        } catch (err) {
          alert('Gagal menyalin prompt. Silakan copy manual.');
        }
        document.body.removeChild(textarea);
      }
    });
    contentDiv.appendChild(copyBtn);
  }
  messageDiv.appendChild(contentDiv);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
userInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
document.querySelectorAll('.option-tag-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.option-tag-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('promptType').value = this.getAttribute('data-value');
  });
});
// Deteksi iOS Safari dan perbaiki tampilan
function detectIOS() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  
  if (isIOS || isSafari) {
    // Tambahkan class untuk iOS
    document.body.classList.add('ios-safari');
    
    // Perbaiki viewport untuk iOS
    const viewport = document.querySelector('meta[name="viewport"]');
    if (viewport) {
      viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
    }
    
    // Perbaiki background attachment untuk iOS
    const style = document.createElement('style');
    style.textContent = `
      .ios-safari body, .ios-safari .bg-dark-gradient {
        background: #181c2b !important;
        background-attachment: scroll !important;
        -webkit-background-attachment: scroll !important;
      }
      .ios-safari .chat-header {
        background: #232946 !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        opacity: 1 !important;
      }
      .ios-safari .chat-messages {
        background: #181c2b !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        opacity: 1 !important;
      }
      .ios-safari .input-bar-glass {
        background: #232946 !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        opacity: 1 !important;
      }
      .ios-safari .message-content {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      .ios-safari .message.user .message-content {
        background: linear-gradient(120deg, #6c63ff 60%, #ff4ecd 100%) !important;
        opacity: 1 !important;
      }
      .ios-safari .message.bot .message-content {
        background: #343a40 !important;
        opacity: 1 !important;
      }
    `;
    document.head.appendChild(style);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  detectIOS();
  userInput.focus();
});
</script>
{% endblock %}